{"componentChunkName":"component---src-templates-blog-template-js","path":"/coupon-event/","result":{"data":{"cur":{"id":"9406497c-9b1c-5499-8eef-a5a4f1a67e27","html":"<p>안녕하세요. 현재 데브코스 4기로 활동 중인 모아밤팀 서버 개발자 홍혁준입니다.</p>\n<p>이번 포스팅에서 <strong>실시간 선착순 시스템</strong>에 대해 이야기를 풀어내 보려고 합니다. 감사합니다.</p>\n<hr>\n<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>저희 모아밤 서비스는 사용자들을 위해 쿠폰 이벤트를 도입하게 되었습니다.\n현재 생각 중인 쿠폰은 선착순으로 진행하는 이벤트로 사용자들이 다양한 종류의 N개 쿠폰을 선착순으로 지급 받도록 할 계획입니다.</p>\n<p>선착순 쿠폰 발급 이벤트는 짧은 시간에 많은 트래픽이 발생합니다.\n중요한 점은 서버가 다운되지 않고 수량 제한에 맞춰 정확하게 쿠폰이 발급되어야 합니다.\n이런 사항들을 모아밤에서는 어떻게 해결했는지 살펴봅시다.</p>\n<h3 id=\"요구사항\" style=\"position:relative;\"><a href=\"#%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD\" aria-label=\"요구사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>요구사항</h3>\n<ul>\n<li>사용자들은 정해진 재고에 따라 선착순으로 쿠폰을 발급 받을 수 있다.</li>\n<li>동일한 이벤트에서 동일 사용자가 쿠폰을 중복하여 발급 받을 수 없다.</li>\n<li>쿠폰은 발급 후 쿠폰함 혹은 결제창에서 1회 사용 가능하다.</li>\n</ul>\n<h3 id=\"고민사항\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%AF%BC%EC%82%AC%ED%95%AD\" aria-label=\"고민사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고민사항</h3>\n<ul>\n<li>N번의 선착순일 때, 정확하게 N번 발급해줄 수 있어야 합니다.</li>\n<li>쿠폰 발급 요청을 여러번 하는 경우 최초 요청을 선착순 발급 기준으로 1회만 받습니다.</li>\n<li>짧은 시간 내에 발생하는 높은 트래픽을 감당해야 합니다.</li>\n</ul>\n<hr>\n<h2 id=\"모아밤의-쿠폰-발급-아키텍처\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98\" aria-label=\"모아밤의 쿠폰 발급 아키텍처 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤의 쿠폰 발급 아키텍처</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAj0lEQVQY031PSwoCMRTr/a/gFQQv4A3ceQBltOKu2g/t9Bt5GQZcOAZCXtM0vCpsYIyB3jt1pZz/QTJKhhgjWmtkKYU6zzN95xwZQkDOmay1kpKVkvvjicv1xlIlhjGGQSmw1vKxlMistcY0TdSUEu/E997DvN5Az9gfz9gdTkvhuurWl78hm/9C6wOlLdkPRUA4TbNfKVQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon1.png\"\n        title=\"coupon1.png\"\n        src=\"/static/436573b6d1398874d65228a206559242/37523/coupon1.png\"\n        srcset=\"/static/436573b6d1398874d65228a206559242/e9ff0/coupon1.png 180w,\n/static/436573b6d1398874d65228a206559242/f21e7/coupon1.png 360w,\n/static/436573b6d1398874d65228a206559242/37523/coupon1.png 720w,\n/static/436573b6d1398874d65228a206559242/302a4/coupon1.png 1080w,\n/static/436573b6d1398874d65228a206559242/21b4d/coupon1.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>쿠폰 발급을 위한 흐름을 살펴봅시다.</p>\n<ol>\n<li>사용자가 쿠폰 발급 요청을 서버로 보냅니다.</li>\n<li>서버에서는 요청을 받아 쿠폰 발급 로직을 처리합니다.</li>\n<li>발급된 쿠폰이 데이터베이스에 저장됩니다.</li>\n</ol>\n<p>이처럼 쿠폰 발급 요청은 매우 간단합니다. 하지만 쿠폰 발급 요청이 많아지고 트래픽이 많아진다면,\n그만큼 동시에 들어오는 요청이 많을 텐데 Race Condition 문제는 어떻게 해결해야 할까요?\n또 Race Condition 문제가 발생하지 않더라도 트래픽이 API 처리량을 넘어간다면 장애가 발생할텐데,\n이런 문제들이 어떤 상황에 발생하는 것이고 어떤 해결방법이 있고 모아밤에서는 어떻게 해결했을까요?\n계속해서 살펴봅시다.</p>\n<br/>\n<h3 id=\"race-condition-살펴보기\" style=\"position:relative;\"><a href=\"#race-condition-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"race condition 살펴보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Race Condition 살펴보기</h3>\n<blockquote>\n<p>Race Condition (경쟁 상태) : 둘 이상의 입력 또는 조작의 타이밍, 순서 등이 결과값에 영향을 줄 수 있는 상태</p>\n</blockquote>\n<p>모아밤 서비스에서 사용자들에게 선착순으로 100개의 쿠폰을 지급한다고 가정해봅시다.</p>\n<p>개발 관점으로 보면 여러명의 사용자가 쿠폰을 동시에 발급받아서 쿠키 재고를 감소시킬 수 있게 됩니다.\n즉 쿠폰(공유 자원)에 N명의 사용자가 접근하여 읽거나 쓰려고 하는 Race Condition이 발생할 수 있게 됩니다.</p>\n<br/>\n<p><strong>[그림으로 이해하기]</strong></p>\n<p>단, 한명의 사용자에게만 쿠폰을 지급하는 이벤트가 있다고 가정해봅시다. 이해를 위해 재고 감소 과정을 표현했습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACBElEQVQoz22S3WsTQRTF99/1QdGKiChS+iiIotA3H/omitpabH1QW2ttjdWEIEk2ye5287VJNsluPhp3d/bjJzN2K4oHLgNz75x7z7mjZVmGhFg4JM47ksEBbn0Xr/mGWXOTYFwlR+QbLIxNfGOHfuU1S3uX0N4mntsqn2UpWk6YJoKNjSesra1yfPSJVCwRwYxYBAgRc3Z2RhwFJNEcES7wJ0PW1x+zcv0qJ99OFEeSJGi/mTP16Onzlzx4tE6p/EMVTGdzvheLVCoVTNPEMEwM85QwEgRhxOFRgWcvNjEt+0KFtlwu6Xa7WJbFZDxGRCHD4ZAwDEmSGN/38TxPxXg8ZrFYkKYJ0+kU3/cIgp+q3nVdVavNZjNM06LVatHr9bBtm26vR5qmpGnG/yAVSeJSqUS5XEbXder1uhpKy4tebW1z684qly5f4+Dws7qbz+dMJhMcx1EN5SSSSCIIQnL/5ZmHFgSBGr9Q+MrO7lv29g+wWy01oZRYq+nUdJ1mo4FhGEqaRBhFCCHOlaR/CAeDAcViUY3e0HVM06Ddbquk9Lff79PpdFSMXJfRaEQcx/jTKffuP+Tm7btcWbmhGqilyIcXHc7PPCm/SrVapdlscmpZyifpsyQcDl2OvxTY2//I+w97anJpkfaX2ednLuXfReSeSXieT6PRUIvoO46yRP6WX86w5Dgglv5HAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon2.png\"\n        title=\"coupon2.png\"\n        src=\"/static/5b8872ac290d498cb5e670cd5d5213bb/37523/coupon2.png\"\n        srcset=\"/static/5b8872ac290d498cb5e670cd5d5213bb/e9ff0/coupon2.png 180w,\n/static/5b8872ac290d498cb5e670cd5d5213bb/f21e7/coupon2.png 360w,\n/static/5b8872ac290d498cb5e670cd5d5213bb/37523/coupon2.png 720w,\n/static/5b8872ac290d498cb5e670cd5d5213bb/302a4/coupon2.png 1080w,\n/static/5b8872ac290d498cb5e670cd5d5213bb/21b4d/coupon2.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 그림처럼 클라이언트 A가 쿠폰을 가져옵니다.\n하지만 클라이언트 B도 클라이언트 A가 쿠폰을 발급받기 전에 쿠폰을 가져오게 되고 클라이언트 A와 B 모두 가져온\n쿠폰 재고는 1개가 있습니다. 때문에, 결국 클라이언트 A와 B가 쿠폰을 발급받게 되고 쿠폰 재고는 -1개가 됩니다.\n이러한 상황을 Race Condition이라고 할 수 있습니다.</p>\n<p>이처럼 Race Condition은 두 개 이상의 스레드가 공유 데이터에 접근할 때 발생하는 문제이므로\n싱글 스레드로 작업을 한다면 레이드 컨디션은 일어나지 않습니다.\n하지만 싱글 스레드 작업은 먼저 요청한 사용자가 쿠폰이 발급되기까지 대기하다가 다른 사람들이 쿠폰 발급이\n가능해지기 때문에 성능이 좋지 못합니다. 그렇다면 어떻게 해결해야 할까요?</p>\n<hr>\n<h2 id=\"문제-해결---java-x\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---java-x\" aria-label=\"문제 해결   java x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 - Java <strong>(X)</strong></h2>\n<h3 id=\"자바의-synchronized-키워드-이용하기\" style=\"position:relative;\"><a href=\"#%EC%9E%90%EB%B0%94%EC%9D%98-synchronized-%ED%82%A4%EC%9B%8C%EB%93%9C-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"자바의 synchronized 키워드 이용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>자바의 synchronized 키워드 이용하기</h3>\n<p>자바의 synchronized는 멀티 스레드 환경에서 단 하나의 스레드만이 특정 코드 블럭을 실행하도록 보장하는\n역할을 합니다. 그래서 해결할 수 있을 거라 생각할 수 있습니다. 하지만 이는 서버가 여러 대가 되는 순간 다시\nRace Condition이 발생하게 되어 적절하지 않습니다.</p>\n<hr>\n<h2 id=\"문제-해결---lock-x\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---lock-x\" aria-label=\"문제 해결   lock x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 - Lock <strong>(X)</strong></h2>\n<h3 id=\"mysql-lock과-redis를-활용한-분산락을-이용하기\" style=\"position:relative;\"><a href=\"#mysql-lock%EA%B3%BC-redis%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EB%B6%84%EC%82%B0%EB%9D%BD%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"mysql lock과 redis를 활용한 분산락을 이용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MySQL Lock과 Redis를 활용한 분산락을 이용하기</h3>\n<p><a href=\"https://hongdosan.tistory.com/373\">[🌐 동시성 이슈 보러 가기]</a></p>\n<p>MySQL Lock과 Redis Lock을 이용해도 충분히 해결할 수 있습니다. 하지만 다시 생각해봅시다.\n우리는 선착순으로 쿠폰을 발급해주기 위해 Coupon Table에서 해당 쿠폰의 갯수를 먼저 가져와야 합니다.\n그리고 나서 쿠폰 재고를 감소함과 동시에 한 사용자의 지갑에 쿠폰을 생성해줘야 합니다.\n즉 <strong>이 모든 과정에 락을 걸어야 하는 것</strong>입니다.</p>\n<p>이렇게 된다면 락을 거는 구간이 길어져서 성능에 불이익이 있을 수밖에 없습니다.\n예를 들어, n초가 걸린다면 n초만큼 계속해서 밀리게 되고 사용자는 밀린 시간만큼 기다려야 합니다.\n따라서 해당 방법도 적절하지 않을 것 같습니다.</p>\n<hr>\n<h2 id=\"문제-해결---redis-incr-x\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---redis-incr-x\" aria-label=\"문제 해결   redis incr x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 - Redis INCR <strong>(X)</strong></h2>\n<h3 id=\"redis의-incr-혹은-decr-명령어\" style=\"position:relative;\"><a href=\"#redis%EC%9D%98-incr-%ED%98%B9%EC%9D%80-decr-%EB%AA%85%EB%A0%B9%EC%96%B4\" aria-label=\"redis의 incr 혹은 decr 명령어 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis의 INCR 혹은 DECR 명령어</h3>\n<blockquote>\n<p>INCR 명령어 : 키에 대한 값을 1씩 증가시키는 명령어로 성능도 매우 빠릅니다.<br>\nDECR 명령어 : 키에 대한 값을 1씩 감소시키는 명령어로 성능도 매우 빠릅니다.</p>\n</blockquote>\n<p>Redis는 싱글 스레드이기 때문에, Race Condition도 해결할 수 있습니다.\n또한 저희의 핵심은 쿠폰 개수이므로 쿠폰 개수 정합성만 관리하면 충분합니다.\n때문에 <strong>성능도 매우 빠른</strong> <strong>Redis의 DECR 명령어를 활용해 해결하는 것은 매우 적절</strong>합니다.</p>\n<br/>\n<p><strong>[redis-cli 실습]</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhUlEQVQY063QzQ6CMBAEYN5DowEtvwVaqFsVkAvh/d9oyBZiPPLjYQ5z+TK7XmxahPoFX9a4JApXTqrnJAonIXEO89XxymZARr1Db8UD94IQVe+l0z4wpQ+Ees5gaRHVzQGw/QXpP2Bm+++ZQlnwX7kzvhnU3egW8u/45CA3bi33QJrN4AQ/hrGi8ZITGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon3.png\"\n        title=\"coupon3.png\"\n        src=\"/static/013d5820ae4efca062bf60f278d9bfe6/37523/coupon3.png\"\n        srcset=\"/static/013d5820ae4efca062bf60f278d9bfe6/e9ff0/coupon3.png 180w,\n/static/013d5820ae4efca062bf60f278d9bfe6/f21e7/coupon3.png 360w,\n/static/013d5820ae4efca062bf60f278d9bfe6/37523/coupon3.png 720w,\n/static/013d5820ae4efca062bf60f278d9bfe6/302a4/coupon3.png 1080w,\n/static/013d5820ae4efca062bf60f278d9bfe6/b94e3/coupon3.png 1126w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 이미지처럼 incr 명령어로 값을 1씩 증가시키고 decr 명령어로 값이 1씩 감소하는 것을 살펴볼 수 있습니다.\n이처럼 해당 명령어로 발급된 쿠폰 개수를 제어할 수 있게 되는 것입니다.\n즉, 쿠폰 발급전에 쿠폰 재고를 1 증가시키고 반환되는 값이 100보다 크면 쿠폰 발급을 멈추는 로직을 작성할 수 있습니다.</p>\n<h3 id=\"흐름\" style=\"position:relative;\"><a href=\"#%ED%9D%90%EB%A6%84\" aria-label=\"흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[흐름]</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.55555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACJUlEQVQoz3WS60/aYBTG+/9n9yyafVhc3JYlRsW47cNu8a6JyVRAtEBBCi0UsBdqC73Bb3lfrUOzneSkp0/Pec5zzqkCkI37RK1NJvpXuucFvNoGQaNA0PpOkkREUUyWxnjaF/x6AauygVUpEDQ/S59GtqBhNpuhiGBnd5enz56yuLjA2dlvkiigZ7a5qJRotVpoWoNOx6Br6kTjG+IoxB853PgOI++acRg+JHRdD71tYJg9bMdlOgPDMDk9K9JsNjEMg45hoLc7BEFIHCdY1oCFN2958uI1K2sFclNE8bylaSo7JXGMbdt0u12q1aqMHcchu/seRRFxHBOGIUlyiyEU9vrXbH7b4cfWHnv7B1SrNZksVG1tb3N8fMylqnJaLKNpdVzXlY2jOGY6nZIkyQNBSr/fZ72wwcrqGkvLH6hcXEqVIll2fWQCy7JM+rzl+YoI5k2MkaSpHMWyLEzTpNFoMBgMGA6vCcdj2dAwTVZW11n++In9gyNJKHAlZxcdxXMSRZJYEBweHlEqlbi6ukJVq3INAhcrGQyG7O4d8PPXFueVi78jC5m55wrzbkKl53n0ej1GoxG+798XZo+umXMo80BOKMy2HYrFIuVymZOTE1RVpd1uEwQ3pGmGPxwy9UfMslQeJq//L6FQVKvV0HUdx7YZWha240h8MpnQrGu8fP6KpXfv5futwn8RJgnzh7q/6t2ec8xxXS6rNWp17f7XESP/AUg1hqvtcIkCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon4.png\"\n        title=\"coupon4.png\"\n        src=\"/static/00ac516debd4e87054fc9af4f42e702b/37523/coupon4.png\"\n        srcset=\"/static/00ac516debd4e87054fc9af4f42e702b/e9ff0/coupon4.png 180w,\n/static/00ac516debd4e87054fc9af4f42e702b/f21e7/coupon4.png 360w,\n/static/00ac516debd4e87054fc9af4f42e702b/37523/coupon4.png 720w,\n/static/00ac516debd4e87054fc9af4f42e702b/302a4/coupon4.png 1080w,\n/static/00ac516debd4e87054fc9af4f42e702b/21b4d/coupon4.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>Redis는 싱글-스레드 기반으로 동작하기 때문에,\n위 흐름처럼 클라이언트 A가 INCR 명령어를 실행했다면 클라이언트 B는 해당 명령어 작업이 종료될 때까지 기다렸다가 INCR 명령어를 실행하게 됩니다.\n이처럼 <strong>모든 스레드에서는 언제나 최신값을 가져갈 수 있게 됩니다.</strong></p>\n<h3 id=\"문제점\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[문제점]</h3>\n<p>Redis의 INCR을 사용해, 선착순으로 쿠폰을 발급할 수 있게 하였습니다.\n하지만 이 방식은 높은 트래픽이 발생했을 때, 발생하는 문제점들을 해결하지 못했습니다.\n예를 들어, 이는 선착순 쿠폰 재고가 10_000개이고 선착순 쿠폰 발급 가능 시각이 되어서 10_000명의 사용자가 동시에 선착순 쿠폰 요청을 보냈다고 가정해봅시다.\n이 경우 <strong>10_000개의 쿠폰 저장 쿼리</strong>가 동시에 발생합니다. 이로 인해 데이터베이스에 설정된 1분에 가능한 최대 INSERT 수가 100명이라면 모든 쿼리가 날라가는데, 총 100분이 걸리게 됩니다.\n최악의 경우 데이터베이스의 타임아웃보다 지연시간이 길어져서 쿠폰 저장이 되지 않는 이슈도 발생하게 됩니다.</p>\n<h3 id=\"해결-방법\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\" aria-label=\"해결 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[해결 방법]</h3>\n<p>해결 방법으로는 여러가지가 있을 텐데, 그 중 대표적으로 메시징 큐에 담아 처리하는 방법이 있습니다.\n메시징 큐에 담아 처리하는 방법으로는 Kafka와 RabbitMQ를 사용하면 해결이 가능할 것입니다.\n하지만 <a href=\"https://hongdosan.tistory.com/374\">FCM Token 도입기</a> 포스팅 에서도 말했듯 초기 자원이\n한정적이라 서버 비용 추가 발생 시, 감당이 힘들다는 문제점과 초기 프로젝트임만큼 오버 엔지니어링입니다.\n또한 러닝커브가 높고 현재 사용되는 기술에 있어서 이해와 공부가 먼저라고 생각하여 해당 방법은 고려 대상에서 제외되었습니다.</p>\n<hr>\n<h2 id=\"문제-해결---redis-queue-system-o\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---redis-queue-system-o\" aria-label=\"문제 해결   redis queue system o permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 - Redis Queue System <strong>(O)</strong></h2>\n<p>앞서 포스팅에 적었던 문제 해결 방식들은 모두 적절하지 않다고 판단했습니다.\n따라서 “쿠폰 발급 요청에 대한 대기열을 만들어서 해결하자.”란 결론을 내리게 되었습니다.</p>\n<h3 id=\"왜-redis를-선택했을까\" style=\"position:relative;\"><a href=\"#%EC%99%9C-redis%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%96%88%EC%9D%84%EA%B9%8C\" aria-label=\"왜 redis를 선택했을까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>왜 Redis를 선택했을까?</h3>\n<p>대기열 저장소 선택에 있어서 고려사항은 고성능 처리 기능을 제공해야 해서 Redis를 고려하게 되었습니다.\n또한 저희 모아밤의 한정적인 자원에서 이미 Redis 사용을 기획에 포함시켰기 때문에, Redis 선택은 매우\n적합하다고 생각했습니다. 기술적인 면에서도 Redis는 아래와 같은 근거로 적절하다고 판단했습니다.</p>\n<ul>\n<li>Redis는 이미 많은 서비스에서 사용되는 검증된 저장소입니다.</li>\n<li>Redis는 I/O이 빠른 In-memory 데이터베이스입니다.</li>\n<li>다양한 자료구조 지원으로 요구사항을 쉽게 해결 가능합니다.</li>\n</ul>\n<h3 id=\"redis의-어떤-명령어와-자료구조를-선택할까\" style=\"position:relative;\"><a href=\"#redis%EC%9D%98-%EC%96%B4%EB%96%A4-%EB%AA%85%EB%A0%B9%EC%96%B4%EC%99%80-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%95%A0%EA%B9%8C\" aria-label=\"redis의 어떤 명령어와 자료구조를 선택할까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis의 어떤 명령어와 자료구조를 선택할까?</h3>\n<h4 id=\"redis-keys-명령어---x\" style=\"position:relative;\"><a href=\"#redis-keys-%EB%AA%85%EB%A0%B9%EC%96%B4---x\" aria-label=\"redis keys 명령어   x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[Redis KEYS 명령어] - <strong>X</strong></h4>\n<p>KEYS 명령어는 Full-Scan을 합니다. 그리고 시간복잡도가 O(n)이기 때문에,\n데이터가 많을 수록 성능이 떨어질 수밖에 없습니다. 심지어 Redis는 싱글-스레드이기 때문에 명령어 수행 시\n다른 명령어들은 블락되고 그만큼 지연되어 적절하지 않다고 판단했습니다.</p>\n<br/>\n<h4 id=\"대기열-redis의-list-자료구조---x\" style=\"position:relative;\"><a href=\"#%EB%8C%80%EA%B8%B0%EC%97%B4-redis%EC%9D%98-list-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0---x\" aria-label=\"대기열 redis의 list 자료구조   x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[대기열 Redis의 List 자료구조] - <strong>X</strong></h4>\n<p>대기열을 추가하는데 List의 RPUSH와 대기열에서 대상을 가져오는 데 LPOP을 사용할 수 있습니다.\n두 명령어는 O(1)의 시간복잡도로 사용할 수 있습니다. 하지만 문제점이 있습니다.\nList 자료구조의 특정값의 순서를 찾을 수 있는 LPOS 명령어는 순차탐색이 필요하여 O(n)의 시간복잡도가 소요됩니다.\n또한 동일한 사용자가 쿠폰 발급 요청을 했을 때, List 자료구조를 사용하면 새로운 데이터가 계속되어 추가됩니다. 따라서 적절하지 않다고 판단하였습니다.</p>\n<br/>\n<h4 id=\"대기열---redis의-sorted-set-자료구조---o\" style=\"position:relative;\"><a href=\"#%EB%8C%80%EA%B8%B0%EC%97%B4---redis%EC%9D%98-sorted-set-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0---o\" aria-label=\"대기열   redis의 sorted set 자료구조   o permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[대기열 - Redis의 Sorted Set 자료구조] - <strong>O</strong></h4>\n<p>Sorted Set은 특정 스코어를 기반으로 정렬하여 스코어로 TimeStamp를 사용할 수 있습니다.\n또한 대기열을 추가하고 가져오는데 ZADD 명령어와 ZRANGE 명령어를 사용할 수 있습니다.\n두 명령어의 시간복잡도는 O(log(n))이기 List보다는 느리지만, 이 정도면 충분하다고 생각했습니다.</p>\n<p>추가적으로 Sorted Set 자료구조에서는 특정 순서를 찾기 위해 ZRANK 명령어를 사용할 수 있는데,\n이는 List의 LPOS와는 다르게 O(log(n))으로 더 빠릅니다. 또한 Sorted Set은 ZADD NX 명령어 사용 시,\n데이터가 중복되지 않아 중복 쿠폰 발급 요청이 들어와도 최초 요청 기준으로 대기열을 관리할 수 있습니다.\n이러한 이유로 Sorted Set은 요구사항들을 간단하고 준수한 성능으로 만족시킬 수 있을 거라 판단하여 선택하게 되었습니다.</p>\n<hr>\n<h2 id=\"redis-sorted-set으로-선착순-쿠폰-발급-시스템-구현하기\" style=\"position:relative;\"><a href=\"#redis-sorted-set%EC%9C%BC%EB%A1%9C-%EC%84%A0%EC%B0%A9%EC%88%9C-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"redis sorted set으로 선착순 쿠폰 발급 시스템 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis Sorted Set으로 선착순 쿠폰 발급 시스템 구현하기</h2>\n<p>위와 같은 다양한 해결방법을 고민하다가 모아밤에서는 결국 Redis에서 제공하는 Sorted Set을 활용하게 되었습니다. Sorted Set을\n활용해 모든 요청이 바로 Database에 바로 부하가 가지 않고 순서대로 일정 범위만큼씩 처리하는 구성을 하였습니다.</p>\n<h3 id=\"sorted-set-이란\" style=\"position:relative;\"><a href=\"#sorted-set-%EC%9D%B4%EB%9E%80\" aria-label=\"sorted set 이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sorted Set 이란?</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCklEQVQoz5WT2WrFMAxE8/8f2AtpoM6ehyw3+54pI1BwE0pTgZEty8caLw4ArOuKrutQliWGYcCyLBJj036e50jTDEmSIAxDRFGEL2NkvO87MTiOAw47XNS2LbIsE3BVVeLHcTyB7/db5gkjhEDXdZGm6R3IzrZtMsFGyDzPApqm6fTctO978VTCHHquP4E6uBqr45xuxkqM8fHxesHzPBhj4LqfCIJA5m8V2o3GJELVWHnTNCK9KAqpVKtUO4F2wPZMpvyrMX5VpmPnmnyFskr70DVmy/xxhn8BCVPpGqPUx8An0v8l+Tcob5lv0Pd9uWF54FEkb/N2y0+AdV3LYv0pcRzLT2HMftjfDf1cELt6sU8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon5.png\"\n        title=\"coupon5.png\"\n        src=\"/static/267f8d0eee941538b6a727d28a91257d/37523/coupon5.png\"\n        srcset=\"/static/267f8d0eee941538b6a727d28a91257d/e9ff0/coupon5.png 180w,\n/static/267f8d0eee941538b6a727d28a91257d/f21e7/coupon5.png 360w,\n/static/267f8d0eee941538b6a727d28a91257d/37523/coupon5.png 720w,\n/static/267f8d0eee941538b6a727d28a91257d/302a4/coupon5.png 1080w,\n/static/267f8d0eee941538b6a727d28a91257d/5c744/coupon5.png 1206w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>하나의 Key에 여러 Value와 Score를 가지고 있으며 중복되지 않는 Value가 Score 순으로 데이터를 정렬합니다.\n만약 Score가 같으면 Value로 정렬됩니다.</p>\n<h3 id=\"모아밤에서의-sorted-set-구조\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4%EC%97%90%EC%84%9C%EC%9D%98-sorted-set-%EA%B5%AC%EC%A1%B0\" aria-label=\"모아밤에서의 sorted set 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤에서의 Sorted Set 구조</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABYklEQVQ4y5WT627CMAyF+/6Pxo8hNBAppVxb7qhIQIEWONOXLSwqhWmWLIMbH59jJ8H9ftf1elVZljbyH3N557fbTefzWUmSaDKZKElSG+fzuRaLhVarlbbbrYI8z7XZbNRoNNTv97Xf75VlmY7HowXAT6eTLpeL1uu1Wq2WPtttdY3RR7OpTqdjPQxDDYdDBXSnACBAaLDb7WwOL4riwRoj99sot5Fm1HI2UI1R5MvkMDnibDbTaDx+SEcujnQUBHT3HQOIYt/4xiiiKFK3a9TrRTLG2DER4zi2DQK/wI/IgJWfw5DFAnE3EtS4GFRZ+BGWHHI5Hxhj3qjx7QnwlfS60RwOB8vU//60lCpLt9FXCnzAJ4bvpDtp/2ZYB8gcq1uvzrh2hu9A3UZhxA0oy8Iy/P5d1m+5DtSXyMXliZmwp9ForDge2OfGXZxOp0rT9G/A6oIAwAc/QLwYgHhBy+VSX2swQVOrQKYJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon6.png\"\n        title=\"coupon6.png\"\n        src=\"/static/a921e83ea097e666abd378bca2098ba8/37523/coupon6.png\"\n        srcset=\"/static/a921e83ea097e666abd378bca2098ba8/e9ff0/coupon6.png 180w,\n/static/a921e83ea097e666abd378bca2098ba8/f21e7/coupon6.png 360w,\n/static/a921e83ea097e666abd378bca2098ba8/37523/coupon6.png 720w,\n/static/a921e83ea097e666abd378bca2098ba8/302a4/coupon6.png 1080w,\n/static/a921e83ea097e666abd378bca2098ba8/21b4d/coupon6.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>모아밤에서는 쿠폰명과 사용자 닉네임이 유니크한 값이기 때문에, Sorted Set의 Key로 쿠폰명으로 하였고\nValue를 사용자 ID으로 선정했습니다. 마지막으로 Score는 참여 순서로 정렬하기 위해 쿠폰 발급 요청 시간을\n유닉스타임(m/s) 값으로 선정했습니다.</p>\n<h3 id=\"모아밤-쿠폰-발급-흐름\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%ED%9D%90%EB%A6%84\" aria-label=\"모아밤 쿠폰 발급 흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤 쿠폰 발급 흐름</h3>\n<p><strong>이해를 위해 재고가 100개인 선착순 쿠폰이 생겼고 1000명이 요청했으며,\n10명의 사용자에 대해 처리한다고 가정해봅시다.</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABB0lEQVQoz32SP0vEQBDF90NbWfo5rK5VsLfTQlDORkRBsEuRi4Rkk+y/bJInb2C93HJxYDJhM/nNY96qZVkwjiNY53nGNE2SPLPWwjknNYQgPYxU83eG4o9N0wjEe4+u69D3vWRZlpJFUWAYhhNgyhyqCDLGIA+qpSoO4PcY4wkoB6ZUa+l5I6O3FoOxOBfHXlY+AbU1Kam8v7zA690tZgDeWdln27aiOMMDy3xUmE9OwOfdNarPd5n+U1Wyb66B60gmEv74tMfbx9cGcLVHqQB026I8HATGc5pJE2lWcAZXuxfcPHz/r5A1eIdOa2itRV1d138mrcOHiDFO54E5NL9rW27z2vwCeVe/4nwm5ZMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon7.png\"\n        title=\"coupon7.png\"\n        src=\"/static/c3f2dbfbd172f705e826da43e5187be9/37523/coupon7.png\"\n        srcset=\"/static/c3f2dbfbd172f705e826da43e5187be9/e9ff0/coupon7.png 180w,\n/static/c3f2dbfbd172f705e826da43e5187be9/f21e7/coupon7.png 360w,\n/static/c3f2dbfbd172f705e826da43e5187be9/37523/coupon7.png 720w,\n/static/c3f2dbfbd172f705e826da43e5187be9/302a4/coupon7.png 1080w,\n/static/c3f2dbfbd172f705e826da43e5187be9/21b4d/coupon7.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ol>\n<li>1000명의 사용자가 쿠폰 발급 요청을 보냅니다.</li>\n<li>서버는 해당 요청을 바로 처리하지 않고 1000명의 사용자를 Redis의 Sorted Set에 순차적으로 등록합니다.</li>\n<li>서버는 스케쥴러를 통해 정해진 주기마다 대기열에 등록된 사용자 중 10명에 대해 쿠폰 발급이 가능한 지 판단합니다.</li>\n<li>쿠폰 발급이 가능하다면, 해당 10명에게 쿠폰을 발급하고 남은 쿠폰이 없을 때까지 3번부터 다시 반복합니다.</li>\n</ol>\n<h3 id=\"모아밤-코드\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%BD%94%EB%93%9C\" aria-label=\"모아밤 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤 코드</h3>\n<p><strong>1) 대기열 등록</strong></p>\n<ul>\n<li>대기열은 어떤 요청이든 해당 쿠폰이 발급 가능 날짜라면, 대기열에 넣도록 합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">registerQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> couponName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">double</span> registerTime <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">validateRegisterQueue</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    couponManageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">addIfAbsentQueue</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> memberId<span class=\"token punctuation\">,</span> registerTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n    \n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">validateRegisterQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> couponName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">LocalDate</span> now <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">existsByNameAndStartAt</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorMessage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_COUPON_PERIOD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>2) 쿠폰 발급</strong></p>\n<ul>\n<li>스케줄러를 통해 1초마다 발급 가능한 쿠폰이 있는 지 체크합니다.</li>\n<li>발급 가능한 쿠폰이 있으면, ZRANGE 명령어를 통해 대기열에서 ISSUE_SIZE(10)만큼 꺼내옵니다.</li>\n<li>대기열에서 꺼내온 사용자들이 재고 내에 요청한 사용자들인지 ZRANK 명령어를 통해 확인합니다.</li>\n<li>발급 결과를 각 사용자에게 FCM 알림을 보내서, 실시간으로 알립니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Scheduled</span><span class=\"token punctuation\">(</span>fixedDelay <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">issue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">LocalDate</span> now <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">></span></span> optionalCoupon <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByStartAt</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>optionalCoupon<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\">Coupon</span> coupon <span class=\"token operator\">=</span> optionalCoupon<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span> couponName <span class=\"token operator\">=</span> coupon<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> max <span class=\"token operator\">=</span> coupon<span class=\"token punctuation\">.</span><span class=\"token function\">getStock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> membersId <span class=\"token operator\">=</span> couponManageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">rangeQueue</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> current<span class=\"token punctuation\">,</span> current <span class=\"token operator\">+</span> <span class=\"token constant\">ISSUE_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId <span class=\"token operator\">:</span> membersId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">int</span> rank <span class=\"token operator\">=</span> couponManageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">rankQueue</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>max <span class=\"token operator\">&lt;</span> rank<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            notificationService<span class=\"token punctuation\">.</span><span class=\"token function\">sendCouponIssueResult</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token constant\">FAIL_ISSUE_BODY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        couponWalletRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponWallet</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> coupon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        notificationService<span class=\"token punctuation\">.</span><span class=\"token function\">sendCouponIssueResult</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token constant\">SUCCESS_ISSUE_BODY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        current<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"문제점-1\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90-1\" aria-label=\"문제점 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제점</h3>\n<p><strong>[상황]</strong></p>\n<p>코드를 보면, 대기열 등록과 쿠폰 발급에서 DB에 동일한 요청을 계속해서 보내고 있습니다.</p>\n<p><strong>[원인]</strong></p>\n<ul>\n<li>대기열 등록 코드 : 동일한 요청으로 인해, 들어온 요청 수만큼 동일한 쿼리를 DB에날립니다.</li>\n<li>쿠폰 발급 코드 : 스케줄러로 인해 1초마다 동일한 쿼리를 DB에 날립니다.</li>\n</ul>\n<p><strong>[해결]</strong></p>\n<p>현재 쿠폰은 변경 가능성이 매우 적습니다. 또한 동일한 요청을 보내고별도의 연산 수행없이 동일한 응답값을 받습니다. 따라서 Redis의 Cache 기능을 활용해 성능을 개선할 수 있을 것이라 판단했습니다.</p>\n<br/>\n<p>긴 글 읽어주셔서 감사합니다. 이상으로 포스팅은 여기서 마치고 Redis Cache에 대한 자세한 내용은 모아밤의 <strong>[Redis Cache 기능 도입기]</strong> 포스팅에서 이어나가겠습니다. 😁</p>\n<hr>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://hongdosan.tistory.com/entry/%EB%B2%A1%EC%97%94%EB%93%9C-%EB%8D%B0%EB%B8%8C%EC%BD%94%EC%8A%A4-TIL-%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%9D%B4%EC%8A%88-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" title=\"동시성 이슈 해결하기 - 홍도산\">동시성 이슈 해결하기 - 홍도산</a></li>\n<li><a href=\"https://www.inflearn.com/course/%EC%84%A0%EC%B0%A9%EC%88%9C-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%8B%A4%EC%8A%B5/dashboard\">실습으로 배우는 선착순 이벤트 시스템 - 최상용</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=MTSn93rNPPE&#x26;t=710s\">선착순 이벤트 서버 생존기! 47만 RPM에서 살아남다?! - 우아한테크토크 김민국</a></li>\n<li><a href=\"https://redis.io/docs/data-types/sorted-sets/\">Redis Sorted Set - 공식문서</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B0%B0%EA%B2%BD\">배경</a></p>\n<ul>\n<li><a href=\"#%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD\">요구사항</a></li>\n<li><a href=\"#%EA%B3%A0%EB%AF%BC%EC%82%AC%ED%95%AD\">고민사항</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98\">모아밤의 쿠폰 발급 아키텍처</a></p>\n<ul>\n<li><a href=\"#race-condition-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\">Race Condition 살펴보기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---java-x\">문제 해결 - Java <strong>(X)</strong></a></p>\n<ul>\n<li><a href=\"#%EC%9E%90%EB%B0%94%EC%9D%98-synchronized-%ED%82%A4%EC%9B%8C%EB%93%9C-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\">자바의 synchronized 키워드 이용하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---lock-x\">문제 해결 - Lock <strong>(X)</strong></a></p>\n<ul>\n<li><a href=\"#mysql-lock%EA%B3%BC-redis%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EB%B6%84%EC%82%B0%EB%9D%BD%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\">MySQL Lock과 Redis를 활용한 분산락을 이용하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---redis-incr-x\">문제 해결 - Redis INCR <strong>(X)</strong></a></p>\n<ul>\n<li><a href=\"#redis%EC%9D%98-incr-%ED%98%B9%EC%9D%80-decr-%EB%AA%85%EB%A0%B9%EC%96%B4\">Redis의 INCR 혹은 DECR 명령어</a></li>\n<li><a href=\"#%ED%9D%90%EB%A6%84\">[흐름]</a></li>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90\">[문제점]</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\">[해결 방법]</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---redis-queue-system-o\">문제 해결 - Redis Queue System <strong>(O)</strong></a></p>\n<ul>\n<li>\n<p><a href=\"#%EC%99%9C-redis%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%96%88%EC%9D%84%EA%B9%8C\">왜 Redis를 선택했을까?</a></p>\n</li>\n<li>\n<p><a href=\"#redis%EC%9D%98-%EC%96%B4%EB%96%A4-%EB%AA%85%EB%A0%B9%EC%96%B4%EC%99%80-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%95%A0%EA%B9%8C\">Redis의 어떤 명령어와 자료구조를 선택할까?</a></p>\n<ul>\n<li><a href=\"#redis-keys-%EB%AA%85%EB%A0%B9%EC%96%B4---x\">[Redis KEYS 명령어] - <strong>X</strong></a></li>\n<li><a href=\"#%EB%8C%80%EA%B8%B0%EC%97%B4-redis%EC%9D%98-list-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0---x\">[대기열 Redis의 List 자료구조] - <strong>X</strong></a></li>\n<li><a href=\"#%EB%8C%80%EA%B8%B0%EC%97%B4---redis%EC%9D%98-sorted-set-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0---o\">[대기열 - Redis의 Sorted Set 자료구조] - <strong>O</strong></a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#redis-sorted-set%EC%9C%BC%EB%A1%9C-%EC%84%A0%EC%B0%A9%EC%88%9C-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\">Redis Sorted Set으로 선착순 쿠폰 발급 시스템 구현하기</a></p>\n<ul>\n<li><a href=\"#sorted-set-%EC%9D%B4%EB%9E%80\">Sorted Set 이란?</a></li>\n<li><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4%EC%97%90%EC%84%9C%EC%9D%98-sorted-set-%EA%B5%AC%EC%A1%B0\">모아밤에서의 Sorted Set 구조</a></li>\n<li><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%ED%9D%90%EB%A6%84\">모아밤 쿠폰 발급 흐름</a></li>\n<li><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%BD%94%EB%93%9C\">모아밤 코드</a></li>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90-1\">문제점</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>\n</div>","excerpt":"안녕하세요. 현재 데브코스 4기로 활동 중인 모아밤팀 서버 개발자 홍혁준입니다. 이번 포스팅에서 실시간 선착순 시스템에 대해 이야기를 풀어내 보려고 합니다. 감사합니다. 배경 저희 모아밤 서비스는 사용자들을 위해 쿠폰 이벤트를 도입하게 되었습니다.\n현재 생각 중인 쿠폰은 선착순으로 진행하는 이벤트로 사용자들이 다양한 종류의 N개 쿠폰을 선착순으로 지급 받도록 할 계획입니다. 선착순 쿠폰 발급 이벤트는 짧은 시간에 많은 트래픽이 발생합니다.\n중요한 점은 서버가 다운되지 않고 수량 제한에 맞춰 정확하게 쿠폰이 발급되어야 합니다.\n이런 사항들을 모아밤에서는 어떻게 해결했는지 살펴봅시다. 요구사항 사용자들은 정해진 재고에 따라 선착순으로 쿠폰을 발급 받을 수 있다. 동일한 이벤트에서 동일 사용자가 쿠폰을 중복하여 발급 받을 수 없다. 쿠폰은 발급 후 쿠폰함 혹은 결제창에서 1회 사용 가능하다. 고민사항 N번의 선착순일 때, 정확하게 N번 발급해줄 수 있어야 합니다. 쿠폰 발급 요청을 여러…","frontmatter":{"date":"November 09, 2023","title":"모아밤의 실시간 선착순 쿠폰 이벤트 도입기","categories":"Tech","author":"홍혁준","emoji":"🧑🏻‍💻"},"fields":{"slug":"/coupon-event/"}},"next":{"id":"1143d3ab-acf3-5d41-978d-501a679f166b","html":"<p>안녕하세요. 현재 데브코스 4기로 활동 중인 모아밤팀 서버 개발자 홍혁준입니다.<br>\n이번 포스팅에서 <strong>예외 처리</strong>에 대해 이야기를 풀어내 보려고 합니다. 감사합니다.</p>\n<hr>\n<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>모아밤에서는 @RestControllerAdvice와 @ExceptionHandler를 통해 예외\n처리를 진행하고 있습니다. 하지만 왜? 해당 방식을 사용할까요? 단순 예외 처리가 아닌\n일반적인 요청 흐름과 예외 발생 시, 흐름을 파악하여 왜 해당 방식을 사용하게 되었는 지 살펴봅시다!</p>\n<h2 id=\"사전-지식\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%A0%84-%EC%A7%80%EC%8B%9D\" aria-label=\"사전 지식 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사전 지식</h2>\n<h3 id=\"basicerrorcontroller\" style=\"position:relative;\"><a href=\"#basicerrorcontroller\" aria-label=\"basicerrorcontroller permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>BasicErrorController</h3>\n<p>스프링은 예외 처리를 위한 BasicErrorController를\n구현했습니다. 그리고 스프링 부트는 예외 발생 시, 기본적으로 <code class=\"language-text\">/error</code>로\n예외 요청을 다시 전달하도록 WAS 설정이 되어 있습니다.\n즉, 별도 설정이 없다면 예외 발생 시, BasicErrorController로 예외\n처리 요청이 전달됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABr0lEQVQ4y32SV5LcMAxEdZsZkUgkxaTVOH34/jdqF6kJDjv+eNUNlgS1QCzFPGLakLaMXOrUR73l8vRDB8IM5xy8909+r5fABPKM6+Xy4nrF9XKdfr37p64ObrKe3Js9dLEsCEVhOUFzh+aCcWYlQnODlg4rFc/nisCyQXOEpvBJwt6hiSGRwcbgMJQgYSBPWEfN85zNQBpB+klDzQqJEZIqJBZw2MAhn36+4ODJ/4l3cG6d+L/mucTsoZFBOpIJeKQZSaOCgoDUg81PPT1NRqrPWH5+9/jxlXB821FvHfXWUPaKWgNai6h7P+ltYhZARG9ZNmWUIKh7Rjka6tGQ94ocDSVF5NyQtrEyaa6NhQBmfsti5BDYwWiFSoBZmggHKAeYBJDzWNexMq9VefvL41atKbQmaNshuU6sZIQm8Oz/2+CfhioeFhi5Kcqu2Ipg64bU48SSgYghIiDmOScRhaiCRaZORO63zA63LPjyUXH0itte0GtB6wf6fqC2HW3/mH7/OKavrSPEhBDi1DHbEON5KZ4ITB7EAmaZOpKMrw/GQ+fAz/qR5DXL9ZytO+tfaY2SYfVfcDIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"exception1.png\"\n        title=\"exception1.png\"\n        src=\"/static/1e9a8283a0bf36b8a7ccdfe8bce101eb/37523/exception1.png\"\n        srcset=\"/static/1e9a8283a0bf36b8a7ccdfe8bce101eb/e9ff0/exception1.png 180w,\n/static/1e9a8283a0bf36b8a7ccdfe8bce101eb/f21e7/exception1.png 360w,\n/static/1e9a8283a0bf36b8a7ccdfe8bce101eb/37523/exception1.png 720w,\n/static/1e9a8283a0bf36b8a7ccdfe8bce101eb/302a4/exception1.png 1080w,\n/static/1e9a8283a0bf36b8a7ccdfe8bce101eb/21b4d/exception1.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>BasicErrorController는 accept Header에 따라 예외 페이지를\n반환하거나 예외 메시지를 반환합니다.\n예외 경로는 위에서 말했듯, 기본적으로 <code class=\"language-text\">/error</code>로 정의되어 있습니다.</p>\n<h3 id=\"스프링의-예외-처리-흐름\" style=\"position:relative;\"><a href=\"#%EC%8A%A4%ED%94%84%EB%A7%81%EC%9D%98-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC-%ED%9D%90%EB%A6%84\" aria-label=\"스프링의 예외 처리 흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>스프링의 예외 처리 흐름</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABTElEQVQoz3WSbU/DIBSF9///lx80LjFG48tcna4228oYawsUVvoYUKZOvckp5OZwzrnQyTiOZEAEtOqZuppSV5dYvU6977zEPZ7huMaacFJjGNGtpFrcs6nmONvxjf/FOzFJBlHwMBzonaXTBm0t2ljkesX8esrrww2NlDhj6Oo1plGEYWAM4bfBp+uk3gmK5RPFy4xFVaDaJjmF8QPOD7RS8Hh5xvzqnEYKnLX4rsVpTQghISedZHXvDz8H+hzjtCKt7xrKuyuWt1NsTB2bOWH8hDDgnPvz8vMo2mqkkqw2NXIvadp9QtxvNyt2sqazOguGo+B/JZVg+VYwm9+zKAvEXrBVgteyYPZ0x8vbM0KJL8G+71OaD/EOo3cJ3tvUyzUMwy+zEE5+mygUE3rvcM6jtjPWy3M25QWtKnHuQN/bZGqMSWvkR+R9fpR3ucW8AN3AzXAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"exception2.png\"\n        title=\"exception2.png\"\n        src=\"/static/46ec4a11beb094900cabf1434617aab4/37523/exception2.png\"\n        srcset=\"/static/46ec4a11beb094900cabf1434617aab4/e9ff0/exception2.png 180w,\n/static/46ec4a11beb094900cabf1434617aab4/f21e7/exception2.png 360w,\n/static/46ec4a11beb094900cabf1434617aab4/37523/exception2.png 720w,\n/static/46ec4a11beb094900cabf1434617aab4/302a4/exception2.png 1080w,\n/static/46ec4a11beb094900cabf1434617aab4/21b4d/exception2.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>ExceptionHandlerExceptionResolver 동작</strong></p>\n<ol>\n<li>예외 발생 시 컨트롤러 안에 적합한 @ExceptionHandler가 있는 지 검사합니다.</li>\n<li>있다면 처리하고 없다면, @RestControllerAdvice로 넘어갑니다.</li>\n<li>@RestControllerAdvice 안에 적합한 @ExceptionHandler가 있으면 처리하고 없다면, 다음 처리기로 넘어갑니다.</li>\n</ol>\n<br/>\n<p><strong>ResponseStatusExceptionResolver 동작</strong></p>\n<ol>\n<li>@ResponseStatus 혹은 ResponseStatusException가 있는 지 검사합니다.</li>\n<li>있다면, ServletResponse의 <code class=\"language-text\">sendError()</code>로 예외를 서블릿까지 전달합니다.</li>\n<li>서블릿은 BasicErrorController로 요청 전달합니다.</li>\n</ol>\n<br/>\n<p><strong>DefaultHandlerExceptionResolver 동작</strong></p>\n<ul>\n<li>스프링 내부 예외인 지 검사 후 맞다면 예외를 처리합니다.</li>\n<li>없다면 적합한 ExceptionResolver가 없어서 예외가 서블릿까지 전달되고 서블릿은 스프링 부트가 진행한 자동 설정에 맞게 BasicErrorController로 요청을 다시 전달합니다.</li>\n</ul>\n<hr>\n<h2 id=\"요청-흐름\" style=\"position:relative;\"><a href=\"#%EC%9A%94%EC%B2%AD-%ED%9D%90%EB%A6%84\" aria-label=\"요청 흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>요청 흐름</h2>\n<h3 id=\"기본-요청-흐름\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%EB%B3%B8-%EC%9A%94%EC%B2%AD-%ED%9D%90%EB%A6%84\" aria-label=\"기본 요청 흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기본 요청 흐름</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">WAS(Tomcat) -> Filter -> Servlet(Dispatcher-Servlet) -> Interceptor -> Controller</code></pre></div>\n<h3 id=\"컨트롤러에서-예외-발생-시-기본-요청-흐름\" style=\"position:relative;\"><a href=\"#%EC%BB%A8%ED%8A%B8%EB%A1%A4%EB%9F%AC%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D-%EC%8B%9C-%EA%B8%B0%EB%B3%B8-%EC%9A%94%EC%B2%AD-%ED%9D%90%EB%A6%84\" aria-label=\"컨트롤러에서 예외 발생 시 기본 요청 흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>컨트롤러에서 예외 발생 시, 기본 요청 흐름</h3>\n<p>WAS에 도착하면 어플리케이션에서 처리를 못하는 예외가 올라왔다고\n판단하고 예외 처리를 진행합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Controller(Error!) -> Interceptor -> Servlet(Dispatcher Servlet) -> Filter -> WAS(Tomcat) \n-> Filter Servlet(Dispatcher Servlet) -> Interceptor -> Controller(BasicErrorController)</code></pre></div>\n<p>이처럼 기본적인 예외 처리 방식은 아래와 같이 결국 <code class=\"language-text\">Exception Controller</code>를 한 번 더 호출하게 됩니다.</p>\n<p>즉, 필터와 인터셉터도 다시 호출되는 것이죠. 정리하면, 이는 요청이 2번 생기는 것이 아닌, 1번의 요청이 2번 전달되는\n것이게 되므로 이를 제어할 수 있도록 별도의 설정이 필요해보입니다.</p>\n<hr>\n<h2 id=\"해결하기\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" aria-label=\"해결하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결하기</h2>\n<h3 id=\"try-catch\" style=\"position:relative;\"><a href=\"#try-catch\" aria-label=\"try catch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>try-catch</h3>\n<p>보통 자바에서는 <code class=\"language-text\">try-catch</code>를 통해 예외 처리를 합니다. 하지만 모든 코드에\n<code class=\"language-text\">try-catch</code> 문을 붙이는 것은 매우 비효율적입니다.</p>\n<br/>\n<h3 id=\"responsestatus\" style=\"position:relative;\"><a href=\"#responsestatus\" aria-label=\"responsestatus permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@ResponseStatus</h3>\n<p>@ResponseStatus는 HTTP 상태를 변경하도록 도와주는 어노테이션이지만, BasicErrorController에 의한 응답입니다.</p>\n<p>즉, @ResponseStatus을 처리하는 ResponseStatusExceptionResolver는\nWAS까지 예외를 전달시키기 때문에 1번의 요청이 2번 전달됩니다.</p>\n<br/>\n<h3 id=\"responsestatusexception\" style=\"position:relative;\"><a href=\"#responsestatusexception\" aria-label=\"responsestatusexception permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ResponseStatusException</h3>\n<p>ResponseStatusException은 Spring5 버전부터 제공하는 @ResponseStatus의 대안으로 HTTP 상태와\n함께 선택적으로 <code class=\"language-text\">reason/cause</code>를 추가할 수 있을 뿐만 아니라, 언체크 예외도 상속받고 있어서 명시적으로 예외 처리를 하지 않아도 됩니다.</p>\n<p>즉, HTTP 상태를 직접 설정해 예외 클래스와 결합도를 낮추고 기본적인 예외 처리를 빠르게 적용하여\n손쉽게 프로토타이핑할 수 있습니다. 하지만 여전히 ResponseStatusExceptionResolver가 예외를 처리합니다.</p>\n<br />\n<h3 id=\"restcontrolleradvice와-exceptionhandler\" style=\"position:relative;\"><a href=\"#restcontrolleradvice%EC%99%80-exceptionhandler\" aria-label=\"restcontrolleradvice와 exceptionhandler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@RestControllerAdvice와 @ExceptionHandler</h3>\n<p>@ExceptionHandler 어노테이션은 컨트롤러 클래스 혹은 @RestControllerAdvice가 있는 클래스의 메소드에 해당\n어노테이션을 추가하고 예외 클래스를 속성으로 받아 손쉽게 예외 처리를 할 수 있도록 도와줍니다.</p>\n<p>즉, @RestControllerAdvice는 @ExceptionHandler를 전역적으로 제공할 수 있도록 스프링에서 제공하는 어노테이션입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVQoz52RW3LDIAxFvZ0aCaEHtrGb7n9XtwM0TWaS/vTjDNIMHF1gSURgNWQPZBdIMLJPpBMZpQrEM1gIXBjECeu6IqX0wkJMKHvAzg3WDH4WWCvQtkGbw3p/KvQoQ3yX98N36bN8CLMR7MhTtMuPpCArgzL9Jut9p/eJ3qccwvVjHZPjpohPRXzZoA/INq/d1y4fA8qs/xSSpJGyHALZBTnykMz3e9S/CQu/XPnOUgrjuhR1M7gLqmfY04Fn3n3CS0JmRlHFtjdcZ8PtOnC2HR4B84BHRWz7rL3CPaHGOnrzClUbe9wDTIRFRB7RR6oJEf2Lb3VG9weheA+IAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"exception3.png\"\n        title=\"exception3.png\"\n        src=\"/static/403acff5bec787f3db52f6e5f0e71640/37523/exception3.png\"\n        srcset=\"/static/403acff5bec787f3db52f6e5f0e71640/e9ff0/exception3.png 180w,\n/static/403acff5bec787f3db52f6e5f0e71640/f21e7/exception3.png 360w,\n/static/403acff5bec787f3db52f6e5f0e71640/37523/exception3.png 720w,\n/static/403acff5bec787f3db52f6e5f0e71640/302a4/exception3.png 1080w,\n/static/403acff5bec787f3db52f6e5f0e71640/21b4d/exception3.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>HandlerExceptionResolver : 스프링에서 예외 처리 공통 관심사(Cross-Cutting Concerns)를 메인 로직으로부터 분리해 다양한 예외 처리 방식을 고안한 방식</p>\n</blockquote>\n<p>사전 지식에서 봤듯 @ExceptionHandler는 HandlerExceptionResolver의 구현체 중 ExceptionHandlerExceptionResolver로 처리하게 됩니다.</p>\n<p>ExceptionHandlerExceptionResolver는 발생한 예외를 잡고 HTTP 상태나 응답 메시지를 설정하기 때문에, WAS 입장에선 해당 요청이\n정상적인 응답인 것으로 인식되어 위와 다르게 WAS의 에러 전달이 진행되지 않습니다.</p>\n<p>이러한 이유로 모아밤에서는 @RestControllerAdvice와\n@ExceptionHandler 예외 처리 방식을 선택하게 되었습니다. 감사합니다.</p>\n<hr>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://hongdosan.tistory.com/entry/8-9-%EC%A3%BC%EC%B0%A8-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC\">예외 처리 - 홍도산</a></li>\n<li><a href=\"https://mangkyu.tistory.com/205\">@RestControllerAdvice를 이용한 스프링 예외 처리</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B0%B0%EA%B2%BD\">배경</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%82%AC%EC%A0%84-%EC%A7%80%EC%8B%9D\">사전 지식</a></p>\n<ul>\n<li><a href=\"#basicerrorcontroller\">BasicErrorController</a></li>\n<li><a href=\"#%EC%8A%A4%ED%94%84%EB%A7%81%EC%9D%98-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC-%ED%9D%90%EB%A6%84\">스프링의 예외 처리 흐름</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9A%94%EC%B2%AD-%ED%9D%90%EB%A6%84\">요청 흐름</a></p>\n<ul>\n<li><a href=\"#%EA%B8%B0%EB%B3%B8-%EC%9A%94%EC%B2%AD-%ED%9D%90%EB%A6%84\">기본 요청 흐름</a></li>\n<li><a href=\"#%EC%BB%A8%ED%8A%B8%EB%A1%A4%EB%9F%AC%EC%97%90%EC%84%9C-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D-%EC%8B%9C-%EA%B8%B0%EB%B3%B8-%EC%9A%94%EC%B2%AD-%ED%9D%90%EB%A6%84\">컨트롤러에서 예외 발생 시, 기본 요청 흐름</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\">해결하기</a></p>\n<ul>\n<li><a href=\"#try-catch\">try-catch</a></li>\n<li><a href=\"#responsestatus\">@ResponseStatus</a></li>\n<li><a href=\"#responsestatusexception\">ResponseStatusException</a></li>\n<li><a href=\"#restcontrolleradvice%EC%99%80-exceptionhandler\">@RestControllerAdvice와 @ExceptionHandler</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"November 09, 2023","title":"모아밤의 예외 처리","categories":"Tech","author":"홍혁준","emoji":"🧑🏻‍💻"},"fields":{"slug":"/exception/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://team-moabam.github.io","comments":{"utterances":{"repo":"team-moabam/team-moabam.github.io"}}}}},"pageContext":{"slug":"/coupon-event/","nextSlug":"/exception/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}