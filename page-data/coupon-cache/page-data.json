{"componentChunkName":"component---src-templates-blog-template-js","path":"/coupon-cache/","result":{"data":{"cur":{"id":"d37e8b5a-8f6d-5642-bae2-1b2381790237","html":"<p>안녕하세요. 백엔드 데브코스 4기를 무사히 수료한 모아밤팀 서버 개발자 홍혁준입니다.<br>\n이번 포스팅에서 <strong>Caching</strong>에 대해 이야기를 풀어내 보려고 합니다. 감사합니다.</p>\n<hr>\n<h2 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h2>\n<h4 id=\"문제\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C\" aria-label=\"문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제</h4>\n<p>현재 모아밤 서비스의 문제점은\n<a href=\"https://hongdosan.tistory.com/376\">Moabam Tech - 실시간 선착순 쿠폰 이벤트 도입기</a> 포스팅을 보면 알 수 있듯\n대기열 등록 및 쿠폰 발급 부분에서 DB에 동일한 요청을 계속해서 보내고 있습니다.\n즉 불필요한 쿼리가 발생하고 있습니다.</p>\n<h4 id=\"원인\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8\" aria-label=\"원인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인</h4>\n<p>사용자들이 선착순 쿠폰 발급을 위해 쿠폰 발급 요청을 하기 때문에,\n단기간에 동일한 요청이 여러번 발생합니다. 또한 스케줄러로 인해 1초마다 동일한 쿼리가 발생합니다.</p>\n<h4 id=\"해결\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0\" aria-label=\"해결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결</h4>\n<p>현재 모아밤 서비스는 쿠폰 정보 변경 가능성이 없다고 봐도 무방합니다.\n또한 동일한 요청을 보내고 별도 연산없이 동일한 응답값을 보내고 있습니다.\n따라서 <strong>캐싱 기능</strong>을 통해 성능을 개선할 수 있을 것이라 판단했습니다.</p>\n<hr>\n<h2 id=\"캐시란-무엇일까\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%9C%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C\" aria-label=\"캐시란 무엇일까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐시란 무엇일까?</h2>\n<p>캐시는 <strong>값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고,\n뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소</strong>입니다.\n애플리케이션은 데이터베이스를 얼마나 자주 호출하냐에 크게 좌우되는데,\n현재 모아밤은 쿠폰 데이터를 가져오기 한 번 이상의 데이터베이스 호출이 단기간 혹은 주기적으로 발생합니다.\n캐시는 이 문제를 해결할 수 있습니다. 글로만 보면 이해가 안가니, 그림을 보면서 캐시 흐름을 이해해봅시다.</p>\n<hr>\n<h3 id=\"그림으로-이해하기\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%A6%BC%EC%9C%BC%EB%A1%9C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0\" aria-label=\"그림으로 이해하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그림으로 이해하기</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApElEQVQI1zVPWwrCQBDr9byVR/IC/vjjCQShSLsPWnxsi7vus+1GZtCBkBBmQqZxzmFdV2zbhlIKjDGMaZqQcwaN9wFv61jXWhl/TXeolTNuQqMZhgEUSvDeYxxHKKWYP96jlIzLtcXxdIazlveklOi6DkIIaK2RU4S+G+z2BzTzPHNQSgkxRtjfEfkhBCzLgsfzhV5q1tSKPqH2xOTRhBjR9hpf4nvke4vCdcgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"img.png\"\n        src=\"/static/d54d7b59a8f869eeb3b15bb755660aec/37523/cache1.png\"\n        srcset=\"/static/d54d7b59a8f869eeb3b15bb755660aec/e9ff0/cache1.png 180w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/f21e7/cache1.png 360w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/37523/cache1.png 720w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/302a4/cache1.png 1080w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/21b4d/cache1.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 그림처럼 별도의 캐시 계층을 두어서 데이터를 잠시 보관한다면\n성능이 개선될 뿐만 아니라 데이터베이스의 부하를 줄일 수 있게 됩니다.</p>\n<hr>\n<h2 id=\"어떤-점을-고려해야-할까\" style=\"position:relative;\"><a href=\"#%EC%96%B4%EB%96%A4-%EC%A0%90%EC%9D%84-%EA%B3%A0%EB%A0%A4%ED%95%B4%EC%95%BC-%ED%95%A0%EA%B9%8C\" aria-label=\"어떤 점을 고려해야 할까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>어떤 점을 고려해야 할까?</h2>\n<p>캐시를 사용하기 위해서 여러 고민사항이 있는데, 모아밤이 현재 큰 서비스는 아니기 때문에,\n아래에 정리한 3가지를 고민해봤습니다.</p>\n<br/>\n<h3 id=\"1-캐시에-저장할-쿠폰-정보-데이터는-어떻게-만료할-것인가\" style=\"position:relative;\"><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"1 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</h3>\n<p>만료 정책이 없거나 너무 길면 캐시에 쿠폰 정보가 계속 남게 되어 일관성 문제가 발생합니다.\n이로 인해 쿠폰 발급에 문제가 발생할 것입니다. 또한 만료 기한이 너무 짧으면 데이터베이스를\n자주 읽기 때문에 곤란합니다.</p>\n<br/>\n<h3 id=\"2-장애에는-어떻게-대처할-것인가\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"2 장애에는 어떻게 대처할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장애에는 어떻게 대처할 것인가?</h3>\n<p>사실 캐시 서버를 한 대만 두는 경우 해당 서버는 단일 장애 지점(SPOF)이 되어버릴 가능성이\n있습니다.</p>\n<br/>\n<h3 id=\"3-local-cache와-global-cache-중-어떤-것을-선택할-것인가\" style=\"position:relative;\"><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"3 local cache와 global cache 중 어떤 것을 선택할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</h3>\n<p><strong>로컬 캐시는 각 캐시 서버를 두고 저장하는 전략</strong>으로 로컬 서버의 리소스(Memory, Disk)를\n사용해 캐싱을 처리합니다. 때문에 속도는 빠르지만, 다른 서버의 캐시를 참조하기가 어렵습니다.\n반대로 <strong>글로벌 캐시는 별도의 캐시 서버를 두는 전략</strong>으로 Redis 혹은 Memcached 등을\n사용해 캐싱을 처리합니다. 때문에, 서버 간 데이터 공유가 쉽지만 네트워크 트래픽을 사용하기 때문에\n로컬 캐시보단 속도가 느립니다.</p>\n<hr>\n<h2 id=\"고려사항에-대한-모아밤의-선택\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%A0%A4%EC%82%AC%ED%95%AD%EC%97%90-%EB%8C%80%ED%95%9C-%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%84%A0%ED%83%9D\" aria-label=\"고려사항에 대한 모아밤의 선택 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고려사항에 대한 모아밤의 선택</h2>\n<h3 id=\"1-캐시에-저장할-쿠폰-정보-데이터는-어떻게-만료할-것인가-1\" style=\"position:relative;\"><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"1 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</h3>\n<p>모아밤 서비스는 00시에 단 하나의 쿠폰 이벤트가 발생합니다. 즉,\n캐시 데이터는 00시가 되면 그 즉시 만료하는 정책으로 가면 될 것 같습니다. 예\n를 들어, 최초 요청이 들어왔을 때, 00시에서 해당 요청 시간을 뺀 값으로 만료시간을\n정하면 될 것 같습니다.</p>\n<br/>\n<h3 id=\"2-장애에는-어떻게-대처할-것인가-1\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"2 장애에는 어떻게 대처할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장애에는 어떻게 대처할 것인가?</h3>\n<p>현재 모아밤의 자원은 한정적입니다. 어쩔 수 없이 SPOF를 감안하고 캐시 서버는 한 대로 진\n행해야 할 것 같습니다.</p>\n<br/>\n<h3 id=\"3-local-cache와-global-cache-중-어떤-것을-선택할-것인가-1\" style=\"position:relative;\"><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"3 local cache와 global cache 중 어떤 것을 선택할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</h3>\n<p>고민 끝에, 모아밤에서는 Global Cache를 선택하게 되었습니다. 여러가지 이유가 있는데,\n사실 현재 상황에선 Local Cache 전략을 사용하는 게 더 좋습니다. 다만 이미 Redis 저\n장소를 사용하고 있는 점, 추후 서버가 2대 이상이 되거나, 모아밤의 쿠폰 이벤트 정책이 변경되\n었을 때, 코드 변경이 크게 일어난다는 점을 고려해서 Global Cache를 선택하게 되었습니다.</p>\n<hr>\n<h2 id=\"redis로-캐싱-구현하기\" style=\"position:relative;\"><a href=\"#redis%EB%A1%9C-%EC%BA%90%EC%8B%B1-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"redis로 캐싱 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis로 캐싱 구현하기</h2>\n<h3 id=\"캐싱에-필요한-설정-및-만료-정책-코드\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%B1%EC%97%90-%ED%95%84%EC%9A%94%ED%95%9C-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EB%A7%8C%EB%A3%8C-%EC%A0%95%EC%B1%85-%EC%BD%94%EB%93%9C\" aria-label=\"캐싱에 필요한 설정 및 만료 정책 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐싱에 필요한 설정 및 만료 정책 코드</h3>\n<ul>\n<li>redisCacheConfiguration() : 원하는 TTL과 직렬화 전략을 설정했습니다.</li>\n<li>getTtl() : TTL을 반환합니다. 이는 00시 기준으로 요청 시각을 뺀 값입니다.</li>\n<li>objectMapper() : Jackson2는 LocalDate 타입을 인식하지 못하기 때문에, 그에 따른 에러 방지 설정</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EnableCaching</span>\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisCacheConfiguration</span> <span class=\"token function\">redisCacheConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> strSerializePair <span class=\"token operator\">=</span> <span class=\"token class-name\">SerializationPair</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">var</span> objSerializePair <span class=\"token operator\">=</span> <span class=\"token class-name\">SerializationPair</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">GenericJackson2JsonRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token function\">objectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">RedisCacheConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token function\">defaultCacheConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">entryTtl</span><span class=\"token punctuation\">(</span><span class=\"token function\">getTtl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">serializeKeysWith</span><span class=\"token punctuation\">(</span>strSerializePair<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">serializeValuesWith</span><span class=\"token punctuation\">(</span>objSerializePair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Duration</span> <span class=\"token function\">getTtl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">LocalTime</span> now <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">LocalTime</span> end <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">endOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">between</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">ObjectMapper</span> <span class=\"token function\">objectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">PolymorphicTypeValidator</span> polymorphicTypeValidator <span class=\"token operator\">=</span> <span class=\"token class-name\">BasicPolymorphicTypeValidator</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">allowIfSubType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">JsonMapper</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">polymorphicTypeValidator</span><span class=\"token punctuation\">(</span>polymorphicTypeValidator<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SerializationFeature</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WRITE_DATES_AS_TIMESTAMPS</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">addModule</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">JavaTimeModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">activateDefaultTyping</span><span class=\"token punctuation\">(</span>polymorphicTypeValidator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObjectMapper<span class=\"token punctuation\">.</span>DefaultTyping</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NON_FINAL</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"캐시-서비스-코드\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%BD%94%EB%93%9C\" aria-label=\"캐시 서비스 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐시 서비스 코드</h3>\n<ul>\n<li>getByNameAndStartAt(…) : 쿠폰 발급 요청 시, 요청된 쿠폰 정보 캐싱</li>\n<li>getByStartAt(…) : 쿠폰 발급 대기열 처리 시, 해당 쿠폰 정보 캐싱</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token annotation punctuation\">@CacheConfig</span><span class=\"token punctuation\">(</span>cacheNames <span class=\"token operator\">=</span> <span class=\"token string\">\"coupons\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponCacheService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"#couponName + #now\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Coupon</span> <span class=\"token function\">getByNameAndStartAt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDate</span> now<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByNameAndStartAt</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> now<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorMessage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_COUPON_PERIOD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"#now\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getByStartAt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDate</span> now<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByStartAt</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<p>이로 인해, <code class=\"language-text\">실시간 선착순 쿠폰 이벤트 도입기</code>의 문제점들을 모두 해결했습니다. 긴 글 읽어주셔서 감사합니다. 이상으로 포스팅은 여기서 마치도록 하겠습니다.</p>\n<hr>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://www.baeldung.com/spring-expression-language\">Spring Expression Language Guide - Baeldung</a></li>\n<li><a href=\"https://www.baeldung.com/spring-boot-redis-cache\">Spring Boot Cache with Redis - Baeldung</a></li>\n<li><a href=\"https://docs.spring.io/spring-data-redis/reference/redis/redis-cache.html\">Redis Cache - 공식 문서</a></li>\n<li><a href=\"https://docs.spring.io/spring-framework/reference/integration/cache/jsr-107.html\">JCache Annotations - 공식 문서</a></li>\n<li> 가상 면접 사례로 배우는 대규모 시스템 설계 기초 - 알렉스 쉬 지음, 이병준 옮김</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EA%B0%9C%EC%9A%94\">개요</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C\">문제</a></li>\n<li><a href=\"#%EC%9B%90%EC%9D%B8\">원인</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0\">해결</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%BA%90%EC%8B%9C%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C\">캐시란 무엇일까?</a></p>\n<ul>\n<li><a href=\"#%EA%B7%B8%EB%A6%BC%EC%9C%BC%EB%A1%9C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0\">그림으로 이해하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%96%B4%EB%96%A4-%EC%A0%90%EC%9D%84-%EA%B3%A0%EB%A0%A4%ED%95%B4%EC%95%BC-%ED%95%A0%EA%B9%8C\">어떤 점을 고려해야 할까?</a></p>\n<ul>\n<li><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</a></li>\n<li><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">2. 장애에는 어떻게 대처할 것인가?</a></li>\n<li><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B3%A0%EB%A0%A4%EC%82%AC%ED%95%AD%EC%97%90-%EB%8C%80%ED%95%9C-%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%84%A0%ED%83%9D\">고려사항에 대한 모아밤의 선택</a></p>\n<ul>\n<li><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</a></li>\n<li><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">2. 장애에는 어떻게 대처할 것인가?</a></li>\n<li><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#redis%EB%A1%9C-%EC%BA%90%EC%8B%B1-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\">Redis로 캐싱 구현하기</a></p>\n<ul>\n<li><a href=\"#%EC%BA%90%EC%8B%B1%EC%97%90-%ED%95%84%EC%9A%94%ED%95%9C-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EB%A7%8C%EB%A3%8C-%EC%A0%95%EC%B1%85-%EC%BD%94%EB%93%9C\">캐싱에 필요한 설정 및 만료 정책 코드</a></li>\n<li><a href=\"#%EC%BA%90%EC%8B%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%BD%94%EB%93%9C\">캐시 서비스 코드</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>\n</div>","excerpt":"안녕하세요. 백엔드 데브코스 4기를 무사히 수료한 모아밤팀 서버 개발자 홍혁준입니다. 이번 포스팅에서 Caching에 대해 이야기를 풀어내 보려고 합니다. 감사합니다. 개요 문제 현재 모아밤 서비스의 문제점은\nMoabam Tech - 실시간 선착순 쿠폰 이벤트 도입기 포스팅을 보면 알 수 있듯\n대기열 등록 및 쿠폰 발급 부분에서 DB에 동일한 요청을 계속해서 보내고 있습니다.\n즉 불필요한 쿼리가 발생하고 있습니다. 원인 사용자들이 선착순 쿠폰 발급을 위해 쿠폰 발급 요청을 하기 때문에,\n단기간에 동일한 요청이 여러번 발생합니다. 또한 스케줄러로 인해 1초마다 동일한 쿼리가 발생합니다. 해결 현재 모아밤 서비스는 쿠폰 정보 변경 가능성이 없다고 봐도 무방합니다.\n또한 동일한 요청을 보내고 별도 연산없이 동일한 응답값을 보내고 있습니다.\n따라서 캐싱 기능을 통해 성능을 개선할 수 있을 것이라 판단했습니다. 캐시란 무엇일까? 캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 …","frontmatter":{"date":"January 12, 2024","title":"모아밤의 캐싱으로 성능 개선하기","categories":"Tech","author":"홍혁준","emoji":"🧑🏻‍💻"},"fields":{"slug":"/coupon-cache/"}},"next":{"id":"2c80a0a9-5a46-5df1-bdbc-2d3722444f77","html":"<p>안녕하세요. 모아밤팀의 서버 개발자 박세연입니다!</p>\n<p>랭킹 시스템을 도입했던 경험을 공유하고 싶어 작성합니다.</p>\n<hr>\n<h2 id=\"서비스-분석\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%B6%84%EC%84%9D\" aria-label=\"서비스 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서비스 분석</h2>\n<p>모아밤 서비스의 경우 이용자들은 매일 인증을 통해 경험치를 얻게 됩니다. 이러한 경험치를 기준으로 랭킹이 있다면, 서로 경쟁을 통해 더욱 열심히 인증을 참여할 수 있기 때문에 도입하게 되었습니다.</p>\n<h3 id=\"랭킹의-기준\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9%EC%9D%98-%EA%B8%B0%EC%A4%80\" aria-label=\"랭킹의 기준 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹의 기준</h3>\n<p>모아밤에서 랭킹의 기준은 사용자가 인증할때 마다 쌓이는 경험치입니다.</p>\n<h3 id=\"랭킹에서-보여주는-데이터\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9%EC%97%90%EC%84%9C-%EB%B3%B4%EC%97%AC%EC%A3%BC%EB%8A%94-%EB%8D%B0%EC%9D%B4%ED%84%B0\" aria-label=\"랭킹에서 보여주는 데이터 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹에서 보여주는 데이터</h3>\n<p>랭킹에서는 현재 <code class=\"language-text\">사용자의 점수</code>, <code class=\"language-text\">닉네임</code>, <code class=\"language-text\">프로필 이미지</code>을 보여주고 있습니다.</p>\n<h2 id=\"모아밤-서비스의-트래픽-특성\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-%ED%8A%B8%EB%9E%98%ED%94%BD-%ED%8A%B9%EC%84%B1\" aria-label=\"모아밤 서비스의 트래픽 특성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤 서비스의 트래픽 특성</h2>\n<h3 id=\"랭킹-업데이트\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8\" aria-label=\"랭킹 업데이트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹 업데이트</h3>\n<ul>\n<li>매시 15분 모든 회원에 대해 업데이트를 진행</li>\n</ul>\n<h3 id=\"랭킹-조회\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9-%EC%A1%B0%ED%9A%8C\" aria-label=\"랭킹 조회 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹 조회</h3>\n<ul>\n<li>사용자의 요청이 있을 경우</li>\n</ul>\n<p>위와 같은 특성을 봤을 때 대부분의 트래픽은 랭킹조회에서 발생하는 것을 알 수 있습니다.</p>\n<h2 id=\"설계\" style=\"position:relative;\"><a href=\"#%EC%84%A4%EA%B3%84\" aria-label=\"설계 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>설계</h2>\n<h3 id=\"1-db만으로-구성\" style=\"position:relative;\"><a href=\"#1-db%EB%A7%8C%EC%9C%BC%EB%A1%9C-%EA%B5%AC%EC%84%B1\" aria-label=\"1 db만으로 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. DB만으로 구성</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 659px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNElEQVQozy2STWsTURSG8xPaZD7uvUnaJiZpm1RroVHbJpmZJDMTO00atIS0Su1CGuhCoeLChrqR4kZBsC5EEBQR3EhbXakbF+LHP3DlT3kkkyxe7oFzOZz3fU4kOraCNl5CmBZiwkEkHUTcRhTqmFc89GIdrVjDvOwhFlxEwkYmHcy4zVTawa/UCRyXQqGGnnCIFA97nD/YIR6sI1MuMuuhsj7a8y7i7Bb2lwOqX/vET3aIvttCLgWolIuRa5Cf93jTDzh73MSvuIxJh4j1cp/F4z0SmxvIjI+abaDyAdHXW8z9uMvq70c0/xxR+dVHO91G2i1UxsecC8jN+3x/1uTf+zZe2WV8MHA8tkxMKyGEhUjaQykLc8VDtAJkMFS81UTUG4iJgWU7tJyYcnh4+yrH+wHzF2poA8vxVA2VqiGnqsjJkQa1sJFRCxkbyB6+uh32xeiPnqiiJqtMnqsSU07Yi+jKQlcVDGUNYQw2HASfrmLOVtGmHaI5C23aRmRrIyg2urKZmanS2/DZ6/iULtXDoRH/8yH+hz5LH++hNtrIlEe8sEb0SYf86R7Opwcsn93n4ukdYq+6yOJqCM0oBMwuNDg5WuPni3Ua1ghK7maH6W6H9OZ15GIDmXZRGQ+jHZDcvUZut0u+d4NMr4uxtYac8VAZFyPjkc27fHva5O/bNvXSCIquldH1MoZWQSh7dIs20rQxNQs9VkaLlTFi5TBDkRjeaggm6dCqeWw3/TBHc8LhP8vCMT08GeNVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"onlydb\"\n        title=\"onlydb\"\n        src=\"/static/556fc347a32fb3fa41256c525287258d/6db71/onlydb.png\"\n        srcset=\"/static/556fc347a32fb3fa41256c525287258d/e9ff0/onlydb.png 180w,\n/static/556fc347a32fb3fa41256c525287258d/f21e7/onlydb.png 360w,\n/static/556fc347a32fb3fa41256c525287258d/6db71/onlydb.png 659w\"\n        sizes=\"(max-width: 659px) 100vw, 659px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>사실 현재는 랭킹 자체가 지금까지 쌓아온 인증 경험치에 대해 매기고 있기 때문에 아주 단순한 구조 입니다.</p>\n<p>따라서 위와 같이 조회할때는 단순 조회</p>\n<p>랭킹에 대한 score를 업데이트를 할때는 update를 하면 됩니다.</p>\n<p>만약 최근 1달간 랭킹과 같이 여러 조건이 붙는 경우네는</p>\n<p>Ranking Board와 같은 테이블로 분리하여 테이블에서 가져올 수 있을 것입니다.</p>\n<h3 id=\"그렇다면-문제는\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%A0%87%EB%8B%A4%EB%A9%B4-%EB%AC%B8%EC%A0%9C%EB%8A%94\" aria-label=\"그렇다면 문제는 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>그렇다면 문제는?</strong></h3>\n<p><strong>1 . 매번 조회 쿼리를 날린다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> nickname<span class=\"token punctuation\">,</span>\n       member_id<span class=\"token punctuation\">,</span>\n       profile_url<span class=\"token punctuation\">,</span>\n       count<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">from</span> members\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> member_id\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> count <span class=\"token keyword\">DESC</span>\n<span class=\"token keyword\">LIMIT</span> <span class=\"token number\">10</span></code></pre></div>\n<p>위와 같이 매번 동일한 쿼리로 Grouping과 정렬하여 Top Ranking의 정보를 가져오게 됩니다.</p>\n<p>이렇게 되면, <code class=\"language-text\">조회를 할 때마다 매번 테이블의 모든 데이터를 정렬</code>해야 합니다.</p>\n<p>이러면 데이터가 많아지면 점점 병목현상이 심해지고, 스코어는 매번 변경이 되기 때문에 인덱스를 걸기도 힘듭니다.</p>\n<p><strong>2 . 조회 쿼리를 날릴때 변경이 될 수 있다.</strong></p>\n<p>데이터를 업데이트를 할 때 조회를 하게 된다면 잘못된 정보를 가져가게 된다. 물론 사용자가 재 조회할 수도 있지만, 어쨌든 문제이다. 따라서\n업데이트를 할 때는 조회가 안되도록 락을 걸어야 한다.</p>\n<h3 id=\"2-redis와-함께-사용\" style=\"position:relative;\"><a href=\"#2-redis%EC%99%80-%ED%95%A8%EA%BB%98-%EC%82%AC%EC%9A%A9\" aria-label=\"2 redis와 함께 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Redis와 함께 사용</h3>\n<p>우리 서비스에서 랭킹에 대한 트래픽은 업데이트는 매 정각에서 10분 사이에 인증 경험치가 업데이트되다 보니 조회가 압도적으로 많았습니다.</p>\n<p>따라서 이를 해결하기 위해 caching 기능을 따로 사용해야 했습니다.\n그래서 인메모리DB를 고민하였고 그 중 다양한 자료구조가 존재하고, 무엇보다 ranking system을 구축하기에 적합한 sorted set을 제공하는 redis를 사욯하고자 하였습니다.</p>\n<p><img src=\"redis.png\" alt=\"Alt text\"></p>\n<p>위 구조가 변경이 된 구조 입니다.</p>\n<p>먼저 <code class=\"language-text\">조회</code>의 경우, 2가지 정도 생각해 볼 수 있었습니다</p>\n<ol>\n<li>redis에 보여주려는 모든 데이터를 저장하고서 전달 할 것인가.</li>\n<li>redis에 id(인덱싱 되어있는)를 저장하고, 조회시 가져와서 DB에서 데이터를 가져와서 사용할 것인가 입니다.</li>\n</ol>\n<p>이렇게 생각할 수 밖에 없었던 이유는 redis에 해당 정보만 사용하는 것이 아니라 여러 정보를 같이 사용합니다. 따라서 저장되는 데이터가 크면 비용적으로 문제가 발생할 수 있다고 생각했습니다.\n또한, 인덱싱을 통해 데이터를 조회하기 때문에 이전 쿼리 방식보다는 낫기 때문입니다.</p>\n<p>여기서 현재는 아직 redis에 인증 및 인가용 refreshtoken, 실시간 이벤트 발급 캐싱용 이렇게 2가지를 사용하고 있었고, db에 접근하지 않고 빠른 조회를 위해 사용하기 위해서 redis를 사용했었기 때문에 <code class=\"language-text\">2번</code>을 사용했습니다.</p>\n<p>반대로 <code class=\"language-text\">업데이트</code>의 경우에도 2가지를 고민해 볼 수 있었습니다.</p>\n<ol>\n<li>인증 경험치가 업데이트 될 때 마다, redis의 데이터도 같이 업데이트 하여 실시간을 유지</li>\n<li>scheduler를 통해 특정 시간에 업데이트 하도록 하기</li>\n</ol>\n<p>처음에는 1번을 적용했었습니다. 더 좋은 user experience를 제공해주기 때문이었습니다.</p>\n<h3 id=\"인증-업데이트-마다-redis에-같이-했을-때의-문제점\" style=\"position:relative;\"><a href=\"#%EC%9D%B8%EC%A6%9D-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8-%EB%A7%88%EB%8B%A4-redis%EC%97%90-%EA%B0%99%EC%9D%B4-%ED%96%88%EC%9D%84-%EB%95%8C%EC%9D%98-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"인증 업데이트 마다 redis에 같이 했을 때의 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>인증 업데이트 마다 redis에 같이 했을 때의 문제점</h3>\n<p>“실시간을 유지하기 위해 매번 redis와 db를 접근해야 할까”에 대한 피드백을 받았습니다.</p>\n<p>실시간 변경이 필수 기능도 아니였고, 인증 업데이트 트래픽은 인증시간인 매 정각 10분 사이에 일어나기 때문에, db 업데이트 후 트랜잭션 밖에서 redis에 데이터를 저장한다 하더라도 하더라도 매번 조회하기 때문에 인증 시간에 너무 많은 일을 하기 때문에 다른 작업에 영향이 갈 수 있다고 판단하였습니다.</p>\n<p>따라서 매 인증이 끝나고 바로 업데이트를 할 수 있도록 인증 시간 외의 시간에 scheduler를 적용하여 업데이트를 적용하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@Scheduled(cron = \"0 11 * * * *\")\npublic void updateAllRanking() {\n\tList&lt;Member> members = memberSearchRepository.findAllMembers();\n\tList&lt;UpdateRanking> updateRankings = members.stream()\n\t\t.map(MemberMapper::toUpdateRanking)\n\t\t.toList();\n\n\trankingService.updateScores(updateRankings);\n}</code></pre></div>\n<h2 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<p>결과적으로\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 574px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACuElEQVQoz02SzW8TVxTF/RcExfbMvPfGHnvsZBw7H9igQhJs5sMznnGLkyhFaYKaNhEEVTSgCBAIlA0gsUNIVcWCjw3toqraCqntiq76V8Bf80MzJlEWR096996je849uWK+S3GyixAuwvIRJQ9hB4h2hHa6n0GciRBOkNWk5WOYLp1mzMPhFvsdn6bVQ1QCZMUn1z68SufJHurSKtKOUFaEsTGi8M827vsHBP8dov37HdqjDZQ9QDoxqhbw+vwSH/Z2+H+xw+OpWbRKf0w4f/A9C/d2UPEKsj5AVQdo65co/7HLxXf38d89oP33LbSHl1G1GNmIKTVink63+H2qyp8thzvTbTTr84bFQpdU9liyN5Zc8RFzIfpcH302QMz1EbaPUC6y5GKYHnbpIuutLrFzATOdO5Is7YAM1fRjjNRLWQ6QZR9ph6jGENVMkClmEszWEDGTkD+9Sr4+wEj7srmA3BFJhvQo1rhoCBct38WoRujlPobwkNUQWQvRLA+94mPW+qis38/IxhueIBRHb9nHWllleneD+tVNnN1N7CtfI+YiTDvinPst7cUNjGqAsvsnCNMNU6np5wnZetmj8XSH5b/ucubXfZZ+u83CLzcQwQg1leB8sc5UZ42ik6A5CbrpHVuVMwyXQprFQhdDd8e+lTz0yR6TE0ucmlhiYuI82qkuMj1cyUUXPXTZI1gOWRnENJsBWmlsVW567xu6Px+w+NM+9ZtbGLUQNTNEO7zMwpsfOPvyRzqvbiCebyKWh6jaADWToDsJz25+yftnI7zliEnpo6oBuWqywvzeNq1rV7BGq4h6iHJi9K0R9YMtZm9tk2ZVXF9DtGNkStgYkLcHvLj7FR/frnHhXEhefSZMJWdZLPSOJYuyh9Q99EKP45wWXaTpZQeTZQ/N9DjbCUnciJIdHKfjE1v4hp581Y1/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Alt text\"\n        title=\"Alt text\"\n        src=\"/static/7c0f8d47ec5484066e4c18158a424614/86389/image.png\"\n        srcset=\"/static/7c0f8d47ec5484066e4c18158a424614/e9ff0/image.png 180w,\n/static/7c0f8d47ec5484066e4c18158a424614/f21e7/image.png 360w,\n/static/7c0f8d47ec5484066e4c18158a424614/86389/image.png 574w\"\n        sizes=\"(max-width: 574px) 100vw, 574px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n위와 같은 구조를 구성하게 되었으며, 랭킹에 대해 트래픽이 집중된 시간을 피해 업데이트를 하고 랭킹을 빠르게 조회할 수 있습니다.</p>\n<p>이상으로 모아밤 서비스의 랭킹 시스템 도입기였습니다. 서비스 로직상 랭킹 로직 자체가 간단했지만 조건이 많아지게 된다면 그에 따른 변화에 대해서는 추가적으로 포스팅할 예정입니다.</p>","frontmatter":{"date":"December 06, 2023","title":"모아밤 랭킹 시스템 도입기","categories":"Tech","author":"박세연","emoji":"🦻🏼🖥️"},"fields":{"slug":"/ranking-system/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://team-moabam.github.io","comments":{"utterances":{"repo":"team-moabam/team-moabam.github.io"}}}}},"pageContext":{"slug":"/coupon-cache/","nextSlug":"/ranking-system/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}