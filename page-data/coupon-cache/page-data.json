{"componentChunkName":"component---src-templates-blog-template-js","path":"/coupon-cache/","result":{"data":{"cur":{"id":"d37e8b5a-8f6d-5642-bae2-1b2381790237","html":"<p>안녕하세요. 백엔드 데브코스 4기를 무사히 수료한 모아밤팀 서버 개발자 홍혁준입니다.<br>\n이번 포스팅에서 <strong>Caching</strong>에 대해 이야기를 풀어내 보려고 합니다. 감사합니다.</p>\n<hr>\n<h2 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h2>\n<h4 id=\"문제\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C\" aria-label=\"문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제</h4>\n<p>현재 모아밤 서비스의 문제점은\n<a href=\"https://hongdosan.tistory.com/376\">Moabam Tech - 실시간 선착순 쿠폰 이벤트 도입기</a> 포스팅을 보면 알 수 있듯\n대기열 등록 및 쿠폰 발급 부분에서 DB에 동일한 요청을 계속해서 보내고 있습니다.\n즉 불필요한 쿼리가 발생하고 있습니다.</p>\n<h4 id=\"원인\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8\" aria-label=\"원인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인</h4>\n<p>사용자들이 선착순 쿠폰 발급을 위해 쿠폰 발급 요청을 하기 때문에,\n단기간에 동일한 요청이 여러번 발생합니다. 또한 스케줄러로 인해 1초마다 동일한 쿼리가 발생합니다.</p>\n<h4 id=\"해결\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0\" aria-label=\"해결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결</h4>\n<p>현재 모아밤 서비스는 쿠폰 정보 변경 가능성이 없다고 봐도 무방합니다.\n또한 동일한 요청을 보내고 별도 연산없이 동일한 응답값을 보내고 있습니다.\n따라서 <strong>캐싱 기능</strong>을 통해 성능을 개선할 수 있을 것이라 판단했습니다.</p>\n<hr>\n<h2 id=\"캐시란-무엇일까\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%9C%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C\" aria-label=\"캐시란 무엇일까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐시란 무엇일까?</h2>\n<p>캐시는 <strong>값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고,\n뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소</strong>입니다.\n애플리케이션은 데이터베이스를 얼마나 자주 호출하냐에 크게 좌우되는데,\n현재 모아밤은 쿠폰 데이터를 가져오기 한 번 이상의 데이터베이스 호출이 단기간 혹은 주기적으로 발생합니다.\n캐시는 이 문제를 해결할 수 있습니다. 글로만 보면 이해가 안가니, 그림을 보면서 캐시 흐름을 이해해봅시다.</p>\n<hr>\n<h3 id=\"그림으로-이해하기\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%A6%BC%EC%9C%BC%EB%A1%9C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0\" aria-label=\"그림으로 이해하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그림으로 이해하기</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApElEQVQI1zVPWwrCQBDr9byVR/IC/vjjCQShSLsPWnxsi7vus+1GZtCBkBBmQqZxzmFdV2zbhlIKjDGMaZqQcwaN9wFv61jXWhl/TXeolTNuQqMZhgEUSvDeYxxHKKWYP96jlIzLtcXxdIazlveklOi6DkIIaK2RU4S+G+z2BzTzPHNQSgkxRtjfEfkhBCzLgsfzhV5q1tSKPqH2xOTRhBjR9hpf4nvke4vCdcgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"img.png\"\n        src=\"/static/d54d7b59a8f869eeb3b15bb755660aec/37523/cache1.png\"\n        srcset=\"/static/d54d7b59a8f869eeb3b15bb755660aec/e9ff0/cache1.png 180w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/f21e7/cache1.png 360w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/37523/cache1.png 720w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/302a4/cache1.png 1080w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/21b4d/cache1.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 그림처럼 별도의 캐시 계층을 두어서 데이터를 잠시 보관한다면\n성능이 개선될 뿐만 아니라 데이터베이스의 부하를 줄일 수 있게 됩니다.</p>\n<hr>\n<h2 id=\"어떤-점을-고려해야-할까\" style=\"position:relative;\"><a href=\"#%EC%96%B4%EB%96%A4-%EC%A0%90%EC%9D%84-%EA%B3%A0%EB%A0%A4%ED%95%B4%EC%95%BC-%ED%95%A0%EA%B9%8C\" aria-label=\"어떤 점을 고려해야 할까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>어떤 점을 고려해야 할까?</h2>\n<p>캐시를 사용하기 위해서 여러 고민사항이 있는데, 모아밤이 현재 큰 서비스는 아니기 때문에,\n아래에 정리한 3가지를 고민해봤습니다.</p>\n<br/>\n<h3 id=\"1-캐시에-저장할-쿠폰-정보-데이터는-어떻게-만료할-것인가\" style=\"position:relative;\"><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"1 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</h3>\n<p>만료 정책이 없거나 너무 길면 캐시에 쿠폰 정보가 계속 남게 되어 일관성 문제가 발생합니다.\n이로 인해 쿠폰 발급에 문제가 발생할 것입니다. 또한 만료 기한이 너무 짧으면 데이터베이스를\n자주 읽기 때문에 곤란합니다.</p>\n<br/>\n<h3 id=\"2-장애에는-어떻게-대처할-것인가\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"2 장애에는 어떻게 대처할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장애에는 어떻게 대처할 것인가?</h3>\n<p>사실 캐시 서버를 한 대만 두는 경우 해당 서버는 단일 장애 지점(SPOF)이 되어버릴 가능성이\n있습니다.</p>\n<br/>\n<h3 id=\"3-local-cache와-global-cache-중-어떤-것을-선택할-것인가\" style=\"position:relative;\"><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"3 local cache와 global cache 중 어떤 것을 선택할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</h3>\n<p><strong>로컬 캐시는 각 캐시 서버를 두고 저장하는 전략</strong>으로 로컬 서버의 리소스(Memory, Disk)를\n사용해 캐싱을 처리합니다. 때문에 속도는 빠르지만, 다른 서버의 캐시를 참조하기가 어렵습니다.\n반대로 <strong>글로벌 캐시는 별도의 캐시 서버를 두는 전략</strong>으로 Redis 혹은 Memcached 등을\n사용해 캐싱을 처리합니다. 때문에, 서버 간 데이터 공유가 쉽지만 네트워크 트래픽을 사용하기 때문에\n로컬 캐시보단 속도가 느립니다.</p>\n<hr>\n<h2 id=\"고려사항에-대한-모아밤의-선택\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%A0%A4%EC%82%AC%ED%95%AD%EC%97%90-%EB%8C%80%ED%95%9C-%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%84%A0%ED%83%9D\" aria-label=\"고려사항에 대한 모아밤의 선택 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고려사항에 대한 모아밤의 선택</h2>\n<h3 id=\"1-캐시에-저장할-쿠폰-정보-데이터는-어떻게-만료할-것인가-1\" style=\"position:relative;\"><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"1 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</h3>\n<p>모아밤 서비스는 00시에 단 하나의 쿠폰 이벤트가 발생합니다. 즉,\n캐시 데이터는 00시가 되면 그 즉시 만료하는 정책으로 가면 될 것 같습니다. 예\n를 들어, 최초 요청이 들어왔을 때, 00시에서 해당 요청 시간을 뺀 값으로 만료시간을\n정하면 될 것 같습니다.</p>\n<br/>\n<h3 id=\"2-장애에는-어떻게-대처할-것인가-1\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"2 장애에는 어떻게 대처할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장애에는 어떻게 대처할 것인가?</h3>\n<p>현재 모아밤의 자원은 한정적입니다. 어쩔 수 없이 SPOF를 감안하고 캐시 서버는 한 대로 진\n행해야 할 것 같습니다.</p>\n<br/>\n<h3 id=\"3-local-cache와-global-cache-중-어떤-것을-선택할-것인가-1\" style=\"position:relative;\"><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"3 local cache와 global cache 중 어떤 것을 선택할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</h3>\n<p>고민 끝에, 모아밤에서는 Global Cache를 선택하게 되었습니다. 여러가지 이유가 있는데,\n사실 현재 상황에선 Local Cache 전략을 사용하는 게 더 좋습니다. 다만 이미 Redis 저\n장소를 사용하고 있는 점, 추후 서버가 2대 이상이 되거나, 모아밤의 쿠폰 이벤트 정책이 변경되\n었을 때, 코드 변경이 크게 일어난다는 점을 고려해서 Global Cache를 선택하게 되었습니다.</p>\n<hr>\n<h2 id=\"redis로-캐싱-구현하기\" style=\"position:relative;\"><a href=\"#redis%EB%A1%9C-%EC%BA%90%EC%8B%B1-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"redis로 캐싱 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis로 캐싱 구현하기</h2>\n<h3 id=\"캐싱에-필요한-설정-및-만료-정책-코드\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%B1%EC%97%90-%ED%95%84%EC%9A%94%ED%95%9C-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EB%A7%8C%EB%A3%8C-%EC%A0%95%EC%B1%85-%EC%BD%94%EB%93%9C\" aria-label=\"캐싱에 필요한 설정 및 만료 정책 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐싱에 필요한 설정 및 만료 정책 코드</h3>\n<ul>\n<li>redisCacheConfiguration() : 원하는 TTL과 직렬화 전략을 설정했습니다.</li>\n<li>getTtl() : TTL을 반환합니다. 이는 00시 기준으로 요청 시각을 뺀 값입니다.</li>\n<li>objectMapper() : Jackson2는 LocalDate 타입을 인식하지 못하기 때문에, 그에 따른 에러 방지 설정</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EnableCaching</span>\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisCacheConfiguration</span> <span class=\"token function\">redisCacheConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> strSerializePair <span class=\"token operator\">=</span> <span class=\"token class-name\">SerializationPair</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">var</span> objSerializePair <span class=\"token operator\">=</span> <span class=\"token class-name\">SerializationPair</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">GenericJackson2JsonRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token function\">objectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">RedisCacheConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token function\">defaultCacheConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">entryTtl</span><span class=\"token punctuation\">(</span><span class=\"token function\">getTtl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">serializeKeysWith</span><span class=\"token punctuation\">(</span>strSerializePair<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">serializeValuesWith</span><span class=\"token punctuation\">(</span>objSerializePair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Duration</span> <span class=\"token function\">getTtl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">LocalTime</span> now <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">LocalTime</span> end <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">endOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">between</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">ObjectMapper</span> <span class=\"token function\">objectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">PolymorphicTypeValidator</span> polymorphicTypeValidator <span class=\"token operator\">=</span> <span class=\"token class-name\">BasicPolymorphicTypeValidator</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">allowIfSubType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">JsonMapper</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">polymorphicTypeValidator</span><span class=\"token punctuation\">(</span>polymorphicTypeValidator<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SerializationFeature</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WRITE_DATES_AS_TIMESTAMPS</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">addModule</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">JavaTimeModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">activateDefaultTyping</span><span class=\"token punctuation\">(</span>polymorphicTypeValidator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObjectMapper<span class=\"token punctuation\">.</span>DefaultTyping</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NON_FINAL</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"캐시-서비스-코드\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%BD%94%EB%93%9C\" aria-label=\"캐시 서비스 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐시 서비스 코드</h3>\n<ul>\n<li>getByNameAndStartAt(…) : 쿠폰 발급 요청 시, 요청된 쿠폰 정보 캐싱</li>\n<li>getByStartAt(…) : 쿠폰 발급 대기열 처리 시, 해당 쿠폰 정보 캐싱</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token annotation punctuation\">@CacheConfig</span><span class=\"token punctuation\">(</span>cacheNames <span class=\"token operator\">=</span> <span class=\"token string\">\"coupons\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponCacheService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"#couponName + #now\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Coupon</span> <span class=\"token function\">getByNameAndStartAt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDate</span> now<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByNameAndStartAt</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> now<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorMessage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_COUPON_PERIOD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"#now\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getByStartAt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDate</span> now<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByStartAt</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h2 id=\"단일-장애점-spof-single-point-of-failure\" style=\"position:relative;\"><a href=\"#%EB%8B%A8%EC%9D%BC-%EC%9E%A5%EC%95%A0%EC%A0%90-spof-single-point-of-failure\" aria-label=\"단일 장애점 spof single point of failure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>단일 장애점 (SPOF; Single Point Of Failure)</h2>\n<h4 id=\"상황\" style=\"position:relative;\"><a href=\"#%EC%83%81%ED%99%A9\" aria-label=\"상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[상황]</h4>\n<p>위 Redis 캐싱 서버 구축으로 <code class=\"language-text\">실시간 선착순 쿠폰 이벤트 도입기</code>의 문제점은 해결했지만, 캐시 서버 장애 시, 서비스 장애로 이어집니다. 때문에, 캐시 서버 장애가 발생하면 데이터베이스를 직접 조회하는 방안이 있습니다. 하지만 이 해결 방안도 결국 데이터베이스 부하가 생기기 때문에, 데이터베이스 서버 장애로 이어질 수 있습니다.</p>\n<h4 id=\"해결-1\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0-1\" aria-label=\"해결 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[해결]</h4>\n<p>지금 당장 생각해본 방법으론 로컬 캐시를 추가하여, Redis 캐시 장애가 발생 시, 로컬 캐시를 접근하도록 하여 해결하면 될 것 같습니다.</p>\n<hr>\n<p>긴 글 읽어주셔서 감사합니다. 이상으로 포스팅은 여기서 마치고 단일 장애 지점 해결 방안의 자세한 내용은 모아밤의 <code class=\"language-text\">캐시 서버로 인한 단일 장애 지점 - (작성중)</code> 포스팅에서 이어나가겠습니다. 😁</p>\n<hr>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://www.baeldung.com/spring-expression-language\">Spring Expression Language Guide - Baeldung</a></li>\n<li><a href=\"https://www.baeldung.com/spring-boot-redis-cache\">Spring Boot Cache with Redis - Baeldung</a></li>\n<li><a href=\"https://docs.spring.io/spring-data-redis/reference/redis/redis-cache.html\">Redis Cache - 공식 문서</a></li>\n<li><a href=\"https://docs.spring.io/spring-framework/reference/integration/cache/jsr-107.html\">JCache Annotations - 공식 문서</a></li>\n<li>가상 면접 사례로 배우는 대규모 시스템 설계 기초 - 알렉스 쉬 지음, 이병준 옮김</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EA%B0%9C%EC%9A%94\">개요</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C\">문제</a></li>\n<li><a href=\"#%EC%9B%90%EC%9D%B8\">원인</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0\">해결</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%BA%90%EC%8B%9C%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C\">캐시란 무엇일까?</a></p>\n<ul>\n<li><a href=\"#%EA%B7%B8%EB%A6%BC%EC%9C%BC%EB%A1%9C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0\">그림으로 이해하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%96%B4%EB%96%A4-%EC%A0%90%EC%9D%84-%EA%B3%A0%EB%A0%A4%ED%95%B4%EC%95%BC-%ED%95%A0%EA%B9%8C\">어떤 점을 고려해야 할까?</a></p>\n<ul>\n<li><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</a></li>\n<li><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">2. 장애에는 어떻게 대처할 것인가?</a></li>\n<li><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B3%A0%EB%A0%A4%EC%82%AC%ED%95%AD%EC%97%90-%EB%8C%80%ED%95%9C-%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%84%A0%ED%83%9D\">고려사항에 대한 모아밤의 선택</a></p>\n<ul>\n<li><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</a></li>\n<li><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">2. 장애에는 어떻게 대처할 것인가?</a></li>\n<li><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#redis%EB%A1%9C-%EC%BA%90%EC%8B%B1-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\">Redis로 캐싱 구현하기</a></p>\n<ul>\n<li><a href=\"#%EC%BA%90%EC%8B%B1%EC%97%90-%ED%95%84%EC%9A%94%ED%95%9C-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EB%A7%8C%EB%A3%8C-%EC%A0%95%EC%B1%85-%EC%BD%94%EB%93%9C\">캐싱에 필요한 설정 및 만료 정책 코드</a></li>\n<li><a href=\"#%EC%BA%90%EC%8B%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%BD%94%EB%93%9C\">캐시 서비스 코드</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%8B%A8%EC%9D%BC-%EC%9E%A5%EC%95%A0%EC%A0%90-spof-single-point-of-failure\">단일 장애점 (SPOF; Single Point Of Failure)</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#%EC%83%81%ED%99%A9\">[상황]</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0-1\">[해결]</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>\n</div>","excerpt":"안녕하세요. 백엔드 데브코스 4기를 무사히 수료한 모아밤팀 서버 개발자 홍혁준입니다. 이번 포스팅에서 Caching에 대해 이야기를 풀어내 보려고 합니다. 감사합니다. 개요 문제 현재 모아밤 서비스의 문제점은\nMoabam Tech - 실시간 선착순 쿠폰 이벤트 도입기 포스팅을 보면 알 수 있듯\n대기열 등록 및 쿠폰 발급 부분에서 DB에 동일한 요청을 계속해서 보내고 있습니다.\n즉 불필요한 쿼리가 발생하고 있습니다. 원인 사용자들이 선착순 쿠폰 발급을 위해 쿠폰 발급 요청을 하기 때문에,\n단기간에 동일한 요청이 여러번 발생합니다. 또한 스케줄러로 인해 1초마다 동일한 쿼리가 발생합니다. 해결 현재 모아밤 서비스는 쿠폰 정보 변경 가능성이 없다고 봐도 무방합니다.\n또한 동일한 요청을 보내고 별도 연산없이 동일한 응답값을 보내고 있습니다.\n따라서 캐싱 기능을 통해 성능을 개선할 수 있을 것이라 판단했습니다. 캐시란 무엇일까? 캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 …","frontmatter":{"date":"January 12, 2024","title":"모아밤의 캐싱으로 성능 개선하기","categories":"Tech","author":"홍혁준","emoji":"🧑🏻‍💻"},"fields":{"slug":"/coupon-cache/"}},"next":{"id":"2c80a0a9-5a46-5df1-bdbc-2d3722444f77","html":"<p>안녕하세요. 모아밤팀의 서버 개발자 박세연입니다!</p>\n<p>랭킹 시스템을 도입했던 경험을 공유하고 싶어 작성합니다.</p>\n<hr>\n<h2 id=\"서비스-분석\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%B6%84%EC%84%9D\" aria-label=\"서비스 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서비스 분석</h2>\n<p>모아밤 서비스의 경우 이용자들은 매일 인증을 통해 경험치를 얻게 됩니다. 경험치를 기준으로 랭킹이 있다면, 서로 경쟁을 통해 더욱 열심히 인증을 참여하게 될 것이고, 사용자가 서비스를 지속적으로 사용하게할 수 있는 좋은 방법이라 생각하여 도입하게 되었습니다.</p>\n<h3 id=\"랭킹의-기준\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9%EC%9D%98-%EA%B8%B0%EC%A4%80\" aria-label=\"랭킹의 기준 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹의 기준</h3>\n<p>모아밤에서 랭킹의 기준은 사용자가 인증할 때 마다 쌓이는 경험치입니다.</p>\n<h3 id=\"랭킹에서-보여주는-데이터\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9%EC%97%90%EC%84%9C-%EB%B3%B4%EC%97%AC%EC%A3%BC%EB%8A%94-%EB%8D%B0%EC%9D%B4%ED%84%B0\" aria-label=\"랭킹에서 보여주는 데이터 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹에서 보여주는 데이터</h3>\n<p>랭킹에서는 현재 <code class=\"language-text\">사용자의 점수</code>, <code class=\"language-text\">닉네임</code>, <code class=\"language-text\">프로필 이미지</code>을 보여주고 있습니다.</p>\n<h2 id=\"모아밤-랭킹-서비스의-트래픽-특성\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EB%9E%AD%ED%82%B9-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-%ED%8A%B8%EB%9E%98%ED%94%BD-%ED%8A%B9%EC%84%B1\" aria-label=\"모아밤 랭킹 서비스의 트래픽 특성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤 랭킹 서비스의 트래픽 특성</h2>\n<p>랭킹 서비스에서 크게 <code class=\"language-text\">랭킹 업데이트</code>와 <code class=\"language-text\">랭킹 조회</code>, 2가지 트래픽이 존재합니다.</p>\n<h3 id=\"랭킹-업데이트\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8\" aria-label=\"랭킹 업데이트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹 업데이트</h3>\n<ul>\n<li>매시 15분 모든 회원에 대해 업데이트를 진행</li>\n</ul>\n<h3 id=\"랭킹-조회\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9-%EC%A1%B0%ED%9A%8C\" aria-label=\"랭킹 조회 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹 조회</h3>\n<ul>\n<li>사용자의 요청을 통해 랭킹 조회 페이지에 접근할 때</li>\n</ul>\n<p>위와 같은 특성을 봤을 때 대부분의 트래픽은 랭킹조회에서 발생하는 것을 알 수 있습니다.</p>\n<h2 id=\"설계\" style=\"position:relative;\"><a href=\"#%EC%84%A4%EA%B3%84\" aria-label=\"설계 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>설계</h2>\n<h3 id=\"1-db만으로-구성\" style=\"position:relative;\"><a href=\"#1-db%EB%A7%8C%EC%9C%BC%EB%A1%9C-%EA%B5%AC%EC%84%B1\" aria-label=\"1 db만으로 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. DB만으로 구성</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 659px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNElEQVQozy2STWsTURSG8xPaZD7uvUnaJiZpm1RroVHbJpmZJDMTO00atIS0Su1CGuhCoeLChrqR4kZBsC5EEBQR3EhbXakbF+LHP3DlT3kkkyxe7oFzOZz3fU4kOraCNl5CmBZiwkEkHUTcRhTqmFc89GIdrVjDvOwhFlxEwkYmHcy4zVTawa/UCRyXQqGGnnCIFA97nD/YIR6sI1MuMuuhsj7a8y7i7Bb2lwOqX/vET3aIvttCLgWolIuRa5Cf93jTDzh73MSvuIxJh4j1cp/F4z0SmxvIjI+abaDyAdHXW8z9uMvq70c0/xxR+dVHO91G2i1UxsecC8jN+3x/1uTf+zZe2WV8MHA8tkxMKyGEhUjaQykLc8VDtAJkMFS81UTUG4iJgWU7tJyYcnh4+yrH+wHzF2poA8vxVA2VqiGnqsjJkQa1sJFRCxkbyB6+uh32xeiPnqiiJqtMnqsSU07Yi+jKQlcVDGUNYQw2HASfrmLOVtGmHaI5C23aRmRrIyg2urKZmanS2/DZ6/iULtXDoRH/8yH+hz5LH++hNtrIlEe8sEb0SYf86R7Opwcsn93n4ukdYq+6yOJqCM0oBMwuNDg5WuPni3Ua1ghK7maH6W6H9OZ15GIDmXZRGQ+jHZDcvUZut0u+d4NMr4uxtYac8VAZFyPjkc27fHva5O/bNvXSCIquldH1MoZWQSh7dIs20rQxNQs9VkaLlTFi5TBDkRjeaggm6dCqeWw3/TBHc8LhP8vCMT08GeNVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"onlydb\"\n        title=\"onlydb\"\n        src=\"/static/556fc347a32fb3fa41256c525287258d/6db71/onlydb.png\"\n        srcset=\"/static/556fc347a32fb3fa41256c525287258d/e9ff0/onlydb.png 180w,\n/static/556fc347a32fb3fa41256c525287258d/f21e7/onlydb.png 360w,\n/static/556fc347a32fb3fa41256c525287258d/6db71/onlydb.png 659w\"\n        sizes=\"(max-width: 659px) 100vw, 659px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>가장 단순한 구조로 DB만을 사용한 설계입니다. 랭킹 자체가 지금까지 쌓아온 인증 경험치에 대해 매기고 있기 때문에 <code class=\"language-text\">랭킹 조회 요청</code>이 들어오게 되면,\nDB에서 쿼리를 통해 조회 후 반환을 하면 되고, 랭킹 순위 기준인 경험치가 업데이트 될 때는, 추가적인 작업이 필요하지 않기 때문에, 빠른 구현이 가능합니다.</p>\n<p>만약, 이 상황에서 조회에 대한 조건이 붙는다면?</p>\n<p>예를 들어 , <code class=\"language-text\">경험치를 기반한 랭킹 조회에서, 최근 일주일간 경험치 증가량에 기반한 랭킹 조회</code>로 변경이 된다면 어떻게 해야할까요.\n이때는, 경험치가 들어오는 값을 매번 기록하는 Board테이블을 만들어서 조회 조건을 추가할 수 있습니다.</p>\n<h3 id=\"그렇다면-위-설계의-문제는\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%A0%87%EB%8B%A4%EB%A9%B4-%EC%9C%84-%EC%84%A4%EA%B3%84%EC%9D%98-%EB%AC%B8%EC%A0%9C%EB%8A%94\" aria-label=\"그렇다면 위 설계의 문제는 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>그렇다면 위 설계의 문제는?</strong></h3>\n<p><strong>1 . 매번 조회 쿼리를 날린다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> nickname<span class=\"token punctuation\">,</span>\n       member_id<span class=\"token punctuation\">,</span>\n       profile_url<span class=\"token punctuation\">,</span>\n       exp<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">from</span> members\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> member_id\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> exp <span class=\"token keyword\">DESC</span>\n<span class=\"token keyword\">LIMIT</span> <span class=\"token number\">10</span></code></pre></div>\n<p>위와 같이 매번 Grouping과 정렬을 하는 쿼리로 Top Ranking의 정보를 가져오게 됩니다.\n이렇게 되면, <code class=\"language-text\">조회를 할 때마다 매번 테이블의 모든 데이터를 정렬</code>해야 합니다.</p>\n<p>데이터가 많아지면 점점 병목현상이 심해지고, 인덱스를 적용시키기에는 경험치는 매번 변경이 되기 때문에 적용하기 힘듭니다.</p>\n<p><strong>2 . 조회 쿼리를 날릴때 변경이 될 수 있다.</strong></p>\n<p>경험치가 포함된 테이블의 경우 랭킹이 조회될 때 마다 랭킹의 정보가 사용자의 정보와 동일해야 합니다.\n하지만 전체 테이블을 조회하는 쿼리를 매번 날리는 경우, 상황에 따라 다르겠지만 락을 거는 경우가 존재합니다.</p>\n<p>mysql의 경우에는 fk가 포함된 update를 하게 되면 x-lock을 걸게 됩니다. 이는 경험치의 값을 업데이트하게 되면 락이 걸리고 이때 랭킹 조회가 바로 되는 것이 아니라\n트랜잭션이 끝나는 것을 기다려야 하다 보니 성능상 문제가 있습니다.</p>\n<h3 id=\"2-redis와-함께-사용\" style=\"position:relative;\"><a href=\"#2-redis%EC%99%80-%ED%95%A8%EA%BB%98-%EC%82%AC%EC%9A%A9\" aria-label=\"2 redis와 함께 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Redis와 함께 사용</h3>\n<p>우리 서비스에서 랭킹에 대한 트래픽은 업데이트는 매 정각에서 10분 사이에 인증 경험치를 업데이트 하지만, 조회는 매번 가능하다보니 조회가 압도적으로 많습니다.</p>\n<p>그렇다보니 위에서 말한 2문제가 발생했습니다.\n따라서 이를 해결하기 위해 caching 기능을 따로 사용하고자 했습니다.</p>\n<p><strong>인메모리 cache</strong>\n고려했던 인메모리 cache의 경우 크게 2가지가 있었습니다.\nGlobal cache였던 redis와 local cache인 caffeine캐시였습니다.</p>\n<p>결과적으로는 redis를 선택하게 되었습니다.\n그 이유로는, caffeine의 경우 네트워크 IO의 소비가 없고, 비용적인 문제도 적습니다. 다만, 랭킹 조회에 대한 결과가\nTop Ranking뿐만 아니라 모든 사용자에 대한 Ranking또한 필요하다보니 많은 메모리를 소모하게 됩니다.\n따라서 Local cache에서 감당하기에는 힘들다 판단하였고, redis는 다양한 자료구조가 존재하고, 무엇보다 ranking system을 구축하기에 적합한 sorted set을 제공하기 때문에 선택하였습니다.</p>\n<p><img src=\"redis.png\" alt=\"Alt text\"></p>\n<p>위 구조가 변경이 된 구조 입니다.</p>\n<p>먼저 <code class=\"language-text\">조회</code>의 경우, 2가지 정도 생각해 볼 수 있었습니다</p>\n<ol>\n<li>redis에 보여주려는 모든 데이터를 저장하고서 전달 할 것인가.</li>\n<li>redis에 id(인덱싱 되어있는)를 저장하고, 조회시 가져와서 DB에서 데이터를 가져와서 사용할 것인가 입니다.</li>\n</ol>\n<p>이 중 1번을 사용했습니다. redis와 같은 인메모리 캐시를 사용하려는 이유가 DB에 대한 접근 최소한으로 하려하는 것인데 다시 조회할 이유가 없었습니다.</p>\n<p>반대로 <code class=\"language-text\">업데이트</code>의 경우에도 2가지를 고민해 볼 수 있었습니다.</p>\n<ol>\n<li>인증 경험치가 업데이트 될 때 마다, redis의 데이터도 같이 업데이트 하여 실시간을 유지</li>\n<li>scheduler를 통해 특정 시간에 업데이트 하도록 하기</li>\n</ol>\n<p>업데이트의 경우 가장 중요하게 생각할 수 있는 것은 데이터의 정합성이었습니다. 캐시를 통해 분리하다보니 업데이트가 되어도 캐시가 업데이트가 되어있지 않으면 잘못된 정보를 제공하게 됩니다.\n따라서 데이터를 업데이트할 때 redis에도 업데이트를 해주었는데, 여기서 서비스 특성상 특정 시간에 많은 요청이 들어오고, redis가 싱글 쓰레드 이다 보니 사용자의 토큰 및 fcm 토큰을 같이 관리하고 있어서 요청을 처리하기 힘들어 집니다. 다라서 scheduler를 통해 특정 시간에만 redis를 업데이트 하는 방식으로 처리하였습니다.\n아래는 상세 문제점 입니다.</p>\n<h3 id=\"인증-업데이트-마다-redis에-같이-했을-때의-문제점\" style=\"position:relative;\"><a href=\"#%EC%9D%B8%EC%A6%9D-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8-%EB%A7%88%EB%8B%A4-redis%EC%97%90-%EA%B0%99%EC%9D%B4-%ED%96%88%EC%9D%84-%EB%95%8C%EC%9D%98-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"인증 업데이트 마다 redis에 같이 했을 때의 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>인증 업데이트 마다 redis에 같이 했을 때의 문제점</h3>\n<p>“실시간을 유지하기 위해 매번 redis와 db를 접근해야 할까”에 대한 피드백을 받았습니다.</p>\n<p>실시간 변경이 필수 기능도 아니였고, 인증 업데이트 트래픽은 인증시간인 매 정각 10분 사이에 일어나기 때문에, db 업데이트 후 트랜잭션 밖에서 redis에 데이터를 저장한다 하더라도 하더라도 매번 조회하기 때문에 인증 시간에 너무 많은 일을 하기 때문에 다른 작업에 영향이 갈 수 있다고 판단하였습니다.</p>\n<p>따라서 매 인증이 끝나고 바로 업데이트를 할 수 있도록 인증 시간 외의 시간에 scheduler를 적용하여 업데이트를 적용하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@Scheduled(cron = \"0 11 * * * *\")\npublic void updateAllRanking() {\n\tList&lt;Member> members = memberSearchRepository.findAllMembers();\n\tList&lt;UpdateRanking> updateRankings = members.stream()\n\t\t.map(MemberMapper::toUpdateRanking)\n\t\t.toList();\n\n\trankingService.updateScores(updateRankings);\n}</code></pre></div>\n<h2 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<p>결과적으로\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 574px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACuElEQVQoz02SzW8TVxTF/RcExfbMvPfGHnvsZBw7H9igQhJs5sMznnGLkyhFaYKaNhEEVTSgCBAIlA0gsUNIVcWCjw3toqraCqntiq76V8Bf80MzJlEWR096996je849uWK+S3GyixAuwvIRJQ9hB4h2hHa6n0GciRBOkNWk5WOYLp1mzMPhFvsdn6bVQ1QCZMUn1z68SufJHurSKtKOUFaEsTGi8M827vsHBP8dov37HdqjDZQ9QDoxqhbw+vwSH/Z2+H+xw+OpWbRKf0w4f/A9C/d2UPEKsj5AVQdo65co/7HLxXf38d89oP33LbSHl1G1GNmIKTVink63+H2qyp8thzvTbTTr84bFQpdU9liyN5Zc8RFzIfpcH302QMz1EbaPUC6y5GKYHnbpIuutLrFzATOdO5Is7YAM1fRjjNRLWQ6QZR9ph6jGENVMkClmEszWEDGTkD+9Sr4+wEj7srmA3BFJhvQo1rhoCBct38WoRujlPobwkNUQWQvRLA+94mPW+qis38/IxhueIBRHb9nHWllleneD+tVNnN1N7CtfI+YiTDvinPst7cUNjGqAsvsnCNMNU6np5wnZetmj8XSH5b/ucubXfZZ+u83CLzcQwQg1leB8sc5UZ42ik6A5CbrpHVuVMwyXQprFQhdDd8e+lTz0yR6TE0ucmlhiYuI82qkuMj1cyUUXPXTZI1gOWRnENJsBWmlsVW567xu6Px+w+NM+9ZtbGLUQNTNEO7zMwpsfOPvyRzqvbiCebyKWh6jaADWToDsJz25+yftnI7zliEnpo6oBuWqywvzeNq1rV7BGq4h6iHJi9K0R9YMtZm9tk2ZVXF9DtGNkStgYkLcHvLj7FR/frnHhXEhefSZMJWdZLPSOJYuyh9Q99EKP45wWXaTpZQeTZQ/N9DjbCUnciJIdHKfjE1v4hp581Y1/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Alt text\"\n        title=\"Alt text\"\n        src=\"/static/7c0f8d47ec5484066e4c18158a424614/86389/image.png\"\n        srcset=\"/static/7c0f8d47ec5484066e4c18158a424614/e9ff0/image.png 180w,\n/static/7c0f8d47ec5484066e4c18158a424614/f21e7/image.png 360w,\n/static/7c0f8d47ec5484066e4c18158a424614/86389/image.png 574w\"\n        sizes=\"(max-width: 574px) 100vw, 574px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n위와 같은 구조를 구성하게 되었으며, 랭킹에 대해 트래픽이 집중된 시간을 피해 업데이트를 하고 랭킹을 빠르게 조회할 수 있습니다.</p>\n<p>이상으로 모아밤 서비스의 랭킹 시스템 도입기였습니다. 서비스 로직상 랭킹 로직 자체가 간단했지만 조건이 많아지게 된다면 그에 따른 변화에 대해서는 추가적으로 포스팅할 예정입니다.</p>","frontmatter":{"date":"December 06, 2023","title":"모아밤 랭킹 시스템 도입기","categories":"Tech","author":"박세연","emoji":"🦻🏼🖥️"},"fields":{"slug":"/ranking-system/"}},"prev":{"id":"0e4f4ace-fc97-5a6a-a7a2-852e2e23676f","html":"<p>안녕하세요. 모아밤팀의 서버 개발자 박세연입니다!</p>\n<p>Custom Secuirty를 만들면서 통합 테스트를 하게 되면 해당 필터를 거치게 되면서 테스트에 설정이 많아졌습니다. 이는 곧 개발 속도가 늦춰지는 문제가 발생하면서 이를 간편하게 만들어 주고자 Support 클래스를 만들게 되었는데, 그 도입 과정에 대해 공유하고자 합니다.</p>\n<hr>\n<h2 id=\"상황\" style=\"position:relative;\"><a href=\"#%EC%83%81%ED%99%A9\" aria-label=\"상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>상황</h2>\n<p>모아밤 서비스에서는 따로 Spring security를 도입하지 않았습니다. 그렇기에 로그인 및 cors등 여러 필터를 직접 구현해야 했습니다. 문제는 테스트 코드를 작성하면서 발생했습니다.</p>\n<p><code class=\"language-text\">Service</code>, <code class=\"language-text\">Repository</code> 테스트 같은 경우에는 단위 테스트 및 DB와의 단위 테스트만 했기 때문에 문제가 없지만, <code class=\"language-text\">Presentation Layer</code>에서는 전체 통합 테스트를 진행하기로 했습니다. 이렇게 되니 모든 통합 테스트의 custom filter를 거치게 되면서 테스트가 실패하고, 통과하기 위해 쿠키에 토큰을 넣어주는 등의 기본 설정들을 해줘야 합니다.</p>\n<p>이로인해, 테스트를 작성하는데 많은 시간이 들어가고, 테스트하고자 하는 부분에 집중하지 못하며, 반복적인 코드들이 많이 들어가는 것을 확인했습니다.</p>\n<h2 id=\"요구-사항\" style=\"position:relative;\"><a href=\"#%EC%9A%94%EA%B5%AC-%EC%82%AC%ED%95%AD\" aria-label=\"요구 사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>요구 사항</h2>\n<ol>\n<li>@SpringBootTest 어노테이션은 하나의 통합테스트를 나타내는 메타데이터로도 볼 수 있기 때문에 직접 작성하는 것이 좋을 거 같다.</li>\n</ol>\n<p>@SpringBootTest와 같은 어노테이션은 통합테스트에서 빈들을 등록시켜주기 때문에 필요합니다. 따라서 통합테스트를 서포트해주는 클래스를 만들때 해당 어노테이션도 같이 생략하려 했지만, 메타데이터로도 볼 수 있기 때문에 분리하지 않았으면 좋겠다 했습니다.</p>\n<ol start=\"2\">\n<li>통합테스트에서 테스트하고 싶은 부분은 서비스 로직이지 필터가 정상 동작되는 것이 아니다.</li>\n</ol>\n<p>말 그대로 어떤 API에 대한 통합 테스트는 해당 서비스 로직이 정상 동작하는지 확인하는 것이기 때문에, filter가 어떻게 동작하는지 알 필요가 없는 것입니다.</p>\n<ol start=\"3\">\n<li>기본 구성이 최소한으로 하면 좋겠다.</li>\n</ol>\n<p>테스트를 위해서 기본적인 많은 설정이 필요하다 하면 오히려 사용이 힘들어 질 수 있기 때문에 최소한의 어노테이션, 최소한의 클래스를 활용하면 좋겠다 생각했습니다.</p>\n<ol start=\"4\">\n<li>테스트 코드를 위해 운영 코드가 변경이 되지 않았으면 좋겠다.</li>\n</ol>\n<p>테스트 코드나 테스트 코드 서포트를 위한 클래스를 적용하기 위해 운영코드가 변경되는건 주객전도가 되는 상황과 같다는 의견이 있었습니다.</p>\n<h2 id=\"filter-구성\" style=\"position:relative;\"><a href=\"#filter-%EA%B5%AC%EC%84%B1\" aria-label=\"filter 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Filter 구성</h2>\n<p>Filter의 구성 및 예외 처리 방식에 따라 support 클래스를 제공하는 방식도 많이 바뀔 거 같습니다.</p>\n<p>현재 Filter는 <code class=\"language-text\">CorsFilter</code>, <code class=\"language-text\">PathFilter</code>, <code class=\"language-text\">AuthorizationFilter</code> 총 3개로 구성되어 있습니다.</p>\n<p>corsFilter는 요청에 따라 cors를 허용할지 아님 예외를 던질지 처리하는 필터이고, PathFilter의 경우, 요청하는 Path에 따라 인가 필터를 거칠지 아닐지를 선택하는 필터이며\nAuthorizationFilter의 경우 로그인 할때 사용자가 인가 토큰을 가지고 있는지 위변조 한건 아닌지를 판단하고 ContextHolder에 사용자 정보를 넣고 Controller로 전달까지 해주는 역할을 합니다.</p>\n<p>모아밤 서비스의 경우 모든 기능들이 로그인인이 되어있나 아닌가에 따라 달라지다 보니, 위와 같이 간단하게만 적용해도 되는 상황이었습니다.</p>\n<h2 id=\"withoutfiltersupporter-클래스\" style=\"position:relative;\"><a href=\"#withoutfiltersupporter-%ED%81%B4%EB%9E%98%EC%8A%A4\" aria-label=\"withoutfiltersupporter 클래스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>WithoutFilterSupporter 클래스</h2>\n<p>먼저 필터부터 거치지 않도록 해야했기 때문에 필터 클래스에서 정상 동작이 되도록 해야 했습니다.</p>\n<p>문제 해결을 위해 크게 2가지 방법으로 접근하였습니다.</p>\n<ol>\n<li><code class=\"language-text\">AuthorizationFilter</code>등 security filter들을 인터페이스화 하여 test profile에서만 동작하는 클래스를 적용하는 방법</li>\n<li>각 필터에서 예외를 잡히지 않기 위해, 특정 부분을 Mock으로 처리하는 방법</li>\n</ol>\n<p>1번의 경우는 Spring Security에서 인증 필터만 항상 인증 되도록 만들어서 사용하는 방식과 유사합니다. 다만 이 경우 인가 필터를 거치게 되면 익명의 사용자가 반환되는 것 처럼 하면됩니다.\n다만 제가 구현한 custom 필터의 경우 exception 필터를 추가로 두지 않아서 CorsFilter와 AuthorizationFilter각각에서 예외를 처리하다 보니, 위와 같이 하면 두 filter 클래스를 test profile에 맞게 변경해야 했습니다.</p>\n<p>따라서 2번 방식을 사용하게 되었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@ExtendWith(FilterProcessExtension.class)\npublic class WithoutFilterSupporter {\n\n\t@MockBean\n\tprivate PathResolver pathResolver;\n\t\n\n\t@SpyBean\n\tprivate CorsFilter corsFilter;\n\n\t@BeforeEach\n\tvoid setUpMock() {\n\t\twillReturn(\"http://localhost:8080\")\n\t\t\t.given(corsFilter).getReferer(any());\n\n\t\twillReturn(Optional.of(PathResolver.Path.builder()\n\t\t\t.uri(\"/\")\n\t\t\t.role(Role.USER)\n\t\t\t.build()))\n\t\t\t.given(pathResolver).permitPathMatch(any());\n\t}\n}</code></pre></div>\n<p>위와 같이 Filter에서 사용하는 클래스를 mock bean으로 등록함으로써 적용시켰습니다</p>\n<h2 id=\"withmember\" style=\"position:relative;\"><a href=\"#withmember\" aria-label=\"withmember permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@WithMember</h2>\n<p>위 코드는 단순 필터만 넘기는 기능이라 ContextHolder에 사용자의 정보를 넣어줘야 합니다.\n위 기능은 Spring security에서 사용하는 <code class=\"language-text\">@WithCustomUser</code>와 같이 만들려 했습니다.</p>\n<p>어노테이션의 경우 <code class=\"language-text\">메서드</code>, <code class=\"language-text\">파라미터</code>에서 동작할 수 있도록 하고자 했고, id값과 닉네임을 커스터 마이징할 수 있어야 했기 때문에</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@Target({ElementType.METHOD, ElementType.PARAMETER})\n@Retention(RetentionPolicy.RUNTIME)\npublic @interface WithMember {\n\n\tlong id() default 1L;\n\n\tString nickname() default \"닉네임\";\n\n\tRole role() default Role.USER;\n}</code></pre></div>\n<p>위와 같이 어노테이션을 만들었습니다.</p>\n<h2 id=\"filterprocessextension\" style=\"position:relative;\"><a href=\"#filterprocessextension\" aria-label=\"filterprocessextension permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FilterProcessExtension</h2>\n<p>이후 매 클래스나 메서드에 어노테이션을 추가하면 사용할 수 있도록 해야 했고,\nSpring junit에서는 <code class=\"language-text\">BeforeEachCallback</code>, <code class=\"language-text\">AfterEachCallback</code>와 같은 인터페이스를 제공하여 해당 인터페이스를 사용했습니다.</p>\n<p>위 인터페이스들은 매 테스트를 진행하기 전/후에 대해서 특정 기능을 넣을 수 있도록 해주는 인터페이스 입니다.\n해당 인터페이스를 통해 <code class=\"language-text\">@WithMember</code>어노테이션이 존재하게 된다면 ContextHolder에 값을 넣도록 했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">public class FilterProcessExtension implements BeforeEachCallback, AfterEachCallback, ParameterResolver {\n\n\t@Override\n\tpublic void beforeEach(ExtensionContext context) {\n\t\tAnnotatedElement annotatedElement =\n\t\t\tcontext.getElement().orElse(null);\n\n\t\tif (isNull(annotatedElement)) {\n\t\t\treturn;\n\t\t}\n\n\t\tWithMember withMember = annotatedElement.getAnnotation(WithMember.class);\n\n\t\tif (isNull(withMember)) {\n\t\t\treturn;\n\t\t}\n\n\t\tAuthorizationThreadLocal.setAuthMember(\n\t\t\tnew AuthMember(withMember.id(), withMember.nickname(), withMember.role()));\n\t}\n\n\t@Override\n\tpublic void afterEach(ExtensionContext context) throws Exception {\n\t\tAuthorizationThreadLocal.remove();\n\t}\n}</code></pre></div>\n<p>이번에는 파라미터로 해당 어노테이션이 존재한다면 값을 넣을 수 있도록 해야했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">public class FilterProcessExtension implements ParameterResolver{\n    ...\n\n    @Override\n\tpublic boolean supportsParameter(ParameterContext parameterContext, ExtensionContext extensionContext) throws\n\t\tParameterResolutionException {\n\t\treturn parameterContext.getParameter().isAnnotationPresent(WithMember.class);\n\t}\n\n\t@Override\n\tpublic Object resolveParameter(ParameterContext parameterContext, ExtensionContext extensionContext) throws\n\t\tParameterResolutionException {\n\t\tWithMember withMember = parameterContext.getParameter().getAnnotation(WithMember.class);\n\n\t\tif (isNull(withMember)) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn new AuthMember(withMember.id(), withMember.nickname(), withMember.role());\n\t}\n}</code></pre></div>\n<p>파라미터의 경우 <code class=\"language-text\">ParameterResolver</code>의 인터페이스를 사용하여 값을 넣을 수 있습니다.</p>\n<p>이렇게 한다면 <code class=\"language-text\">WithoutFilterSupporter</code>의 클래스를 통합테스트에 적용하면 바로 사용이 가능했습니다.</p>\n<h2 id=\"문서화-및-공유\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%84%9C%ED%99%94-%EB%B0%8F-%EA%B3%B5%EC%9C%A0\" aria-label=\"문서화 및 공유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문서화 및 공유</h2>\n<p>이렇게 만들어서 인가된 사용자의 정보를 가져오는 법 및 테스트 방법에 대해 문서화 하여 팀원들과 discussion을 통해 공유하였습니다.</p>\n<p><a href=\"https://github.com/orgs/team-moabam/discussions/49\">회원: Controller 파라미터 인터페이스 및 Test 클래스 지원 인터페이스 지원 내용 및 사용법</a></p>\n<p>개발자의 편의성을 위해 위와 같은 기능을 제공하고자 했고, 실제로 사용하면서 편함을 느낄 수 있었습니다.</p>","frontmatter":{"date":"January 14, 2024","title":"개발자 테스트 간편화를 위한 Custom Security Support 기능 도입기","categories":"Tech","author":"박세연","emoji":"🦻🏼🖥️"},"fields":{"slug":"/security-test/"}},"site":{"siteMetadata":{"siteUrl":"https://team-moabam.github.io","comments":{"utterances":{"repo":"team-moabam/team-moabam.github.io"}}}}},"pageContext":{"slug":"/coupon-cache/","nextSlug":"/ranking-system/","prevSlug":"/security-test/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}