{"componentChunkName":"component---src-templates-blog-template-js","path":"/ranking-system/","result":{"data":{"cur":{"id":"2c80a0a9-5a46-5df1-bdbc-2d3722444f77","html":"<p>안녕하세요. 모아밤팀의 서버 개발자 박세연입니다!</p>\n<p>랭킹 시스템을 도입했던 경험을 공유하고 싶어 작성합니다.</p>\n<hr>\n<h2 id=\"서비스-분석\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%B6%84%EC%84%9D\" aria-label=\"서비스 분석 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서비스 분석</h2>\n<p>모아밤 서비스의 경우 이용자들은 매일 인증을 통해 경험치를 얻게 됩니다. 이러한 경험치를 기준으로 랭킹이 있다면, 서로 경쟁을 통해 더욱 열심히 인증을 참여할 수 있기 때문에 도입하게 되었습니다.</p>\n<h3 id=\"랭킹의-기준\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9%EC%9D%98-%EA%B8%B0%EC%A4%80\" aria-label=\"랭킹의 기준 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹의 기준</h3>\n<p>모아밤에서 랭킹의 기준은 사용자가 인증할때 마다 쌓이는 경험치입니다.</p>\n<h3 id=\"랭킹에서-보여주는-데이터\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9%EC%97%90%EC%84%9C-%EB%B3%B4%EC%97%AC%EC%A3%BC%EB%8A%94-%EB%8D%B0%EC%9D%B4%ED%84%B0\" aria-label=\"랭킹에서 보여주는 데이터 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹에서 보여주는 데이터</h3>\n<p>랭킹에서는 현재 <code class=\"language-text\">사용자의 점수</code>, <code class=\"language-text\">닉네임</code>, <code class=\"language-text\">프로필 이미지</code>을 보여주고 있습니다.</p>\n<h2 id=\"모아밤-서비스의-트래픽-특성\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-%ED%8A%B8%EB%9E%98%ED%94%BD-%ED%8A%B9%EC%84%B1\" aria-label=\"모아밤 서비스의 트래픽 특성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤 서비스의 트래픽 특성</h2>\n<h3 id=\"랭킹-업데이트\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8\" aria-label=\"랭킹 업데이트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹 업데이트</h3>\n<ul>\n<li>매시 15분 모든 회원에 대해 업데이트를 진행</li>\n</ul>\n<h3 id=\"랭킹-조회\" style=\"position:relative;\"><a href=\"#%EB%9E%AD%ED%82%B9-%EC%A1%B0%ED%9A%8C\" aria-label=\"랭킹 조회 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>랭킹 조회</h3>\n<ul>\n<li>사용자의 요청이 있을 경우</li>\n</ul>\n<p>위와 같은 특성을 봤을 때 대부분의 트래픽은 랭킹조회에서 발생하는 것을 알 수 있습니다.</p>\n<h2 id=\"설계\" style=\"position:relative;\"><a href=\"#%EC%84%A4%EA%B3%84\" aria-label=\"설계 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>설계</h2>\n<h3 id=\"1-db만으로-구성\" style=\"position:relative;\"><a href=\"#1-db%EB%A7%8C%EC%9C%BC%EB%A1%9C-%EA%B5%AC%EC%84%B1\" aria-label=\"1 db만으로 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. DB만으로 구성</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 659px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNElEQVQozy2STWsTURSG8xPaZD7uvUnaJiZpm1RroVHbJpmZJDMTO00atIS0Su1CGuhCoeLChrqR4kZBsC5EEBQR3EhbXakbF+LHP3DlT3kkkyxe7oFzOZz3fU4kOraCNl5CmBZiwkEkHUTcRhTqmFc89GIdrVjDvOwhFlxEwkYmHcy4zVTawa/UCRyXQqGGnnCIFA97nD/YIR6sI1MuMuuhsj7a8y7i7Bb2lwOqX/vET3aIvttCLgWolIuRa5Cf93jTDzh73MSvuIxJh4j1cp/F4z0SmxvIjI+abaDyAdHXW8z9uMvq70c0/xxR+dVHO91G2i1UxsecC8jN+3x/1uTf+zZe2WV8MHA8tkxMKyGEhUjaQykLc8VDtAJkMFS81UTUG4iJgWU7tJyYcnh4+yrH+wHzF2poA8vxVA2VqiGnqsjJkQa1sJFRCxkbyB6+uh32xeiPnqiiJqtMnqsSU07Yi+jKQlcVDGUNYQw2HASfrmLOVtGmHaI5C23aRmRrIyg2urKZmanS2/DZ6/iULtXDoRH/8yH+hz5LH++hNtrIlEe8sEb0SYf86R7Opwcsn93n4ukdYq+6yOJqCM0oBMwuNDg5WuPni3Ua1ghK7maH6W6H9OZ15GIDmXZRGQ+jHZDcvUZut0u+d4NMr4uxtYac8VAZFyPjkc27fHva5O/bNvXSCIquldH1MoZWQSh7dIs20rQxNQs9VkaLlTFi5TBDkRjeaggm6dCqeWw3/TBHc8LhP8vCMT08GeNVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"onlydb\"\n        title=\"onlydb\"\n        src=\"/static/556fc347a32fb3fa41256c525287258d/6db71/onlydb.png\"\n        srcset=\"/static/556fc347a32fb3fa41256c525287258d/e9ff0/onlydb.png 180w,\n/static/556fc347a32fb3fa41256c525287258d/f21e7/onlydb.png 360w,\n/static/556fc347a32fb3fa41256c525287258d/6db71/onlydb.png 659w\"\n        sizes=\"(max-width: 659px) 100vw, 659px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>사실 현재는 랭킹 자체가 지금까지 쌓아온 인증 경험치에 대해 매기고 있기 때문에 아주 단순한 구조 입니다.</p>\n<p>따라서 위와 같이 조회할때는 단순 조회</p>\n<p>랭킹에 대한 score를 업데이트를 할때는 update를 하면 됩니다.</p>\n<p>만약 최근 1달간 랭킹과 같이 여러 조건이 붙는 경우네는</p>\n<p>Ranking Board와 같은 테이블로 분리하여 테이블에서 가져올 수 있을 것입니다.</p>\n<h3 id=\"그렇다면-문제는\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%A0%87%EB%8B%A4%EB%A9%B4-%EB%AC%B8%EC%A0%9C%EB%8A%94\" aria-label=\"그렇다면 문제는 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>그렇다면 문제는?</strong></h3>\n<p><strong>1 . 매번 조회 쿼리를 날린다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> nickname<span class=\"token punctuation\">,</span>\n       member_id<span class=\"token punctuation\">,</span>\n       profile_url<span class=\"token punctuation\">,</span>\n       count<span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">from</span> members\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> member_id\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> count <span class=\"token keyword\">DESC</span>\n<span class=\"token keyword\">LIMIT</span> <span class=\"token number\">10</span></code></pre></div>\n<p>위와 같이 매번 동일한 쿼리로 Grouping과 정렬하여 Top Ranking의 정보를 가져오게 됩니다.</p>\n<p>이렇게 되면, <code class=\"language-text\">조회를 할 때마다 매번 테이블의 모든 데이터를 정렬</code>해야 합니다.</p>\n<p>이러면 데이터가 많아지면 점점 병목현상이 심해지고, 스코어는 매번 변경이 되기 때문에 인덱스를 걸기도 힘듭니다.</p>\n<p><strong>2 . 조회 쿼리를 날릴때 변경이 될 수 있다.</strong></p>\n<p>데이터를 업데이트를 할 때 조회를 하게 된다면 잘못된 정보를 가져가게 된다. 물론 사용자가 재 조회할 수도 있지만, 어쨌든 문제이다. 따라서\n업데이트를 할 때는 조회가 안되도록 락을 걸어야 한다.</p>\n<h3 id=\"2-redis와-함께-사용\" style=\"position:relative;\"><a href=\"#2-redis%EC%99%80-%ED%95%A8%EA%BB%98-%EC%82%AC%EC%9A%A9\" aria-label=\"2 redis와 함께 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Redis와 함께 사용</h3>\n<p>우리 서비스에서 랭킹에 대한 트래픽은 업데이트는 매 정각에서 10분 사이에 인증 경험치가 업데이트되다 보니 조회가 압도적으로 많았습니다.</p>\n<p>따라서 이를 해결하기 위해 caching 기능을 따로 사용해야 했습니다.\n그래서 인메모리DB를 고민하였고 그 중 다양한 자료구조가 존재하고, 무엇보다 ranking system을 구축하기에 적합한 sorted set을 제공하는 redis를 사욯하고자 하였습니다.</p>\n<p><img src=\"redis.png\" alt=\"Alt text\"></p>\n<p>위 구조가 변경이 된 구조 입니다.</p>\n<p>먼저 <code class=\"language-text\">조회</code>의 경우, 2가지 정도 생각해 볼 수 있었습니다</p>\n<ol>\n<li>redis에 보여주려는 모든 데이터를 저장하고서 전달 할 것인가.</li>\n<li>redis에 id(인덱싱 되어있는)를 저장하고, 조회시 가져와서 DB에서 데이터를 가져와서 사용할 것인가 입니다.</li>\n</ol>\n<p>이렇게 생각할 수 밖에 없었던 이유는 redis에 해당 정보만 사용하는 것이 아니라 여러 정보를 같이 사용합니다. 따라서 저장되는 데이터가 크면 비용적으로 문제가 발생할 수 있다고 생각했습니다.\n또한, 인덱싱을 통해 데이터를 조회하기 때문에 이전 쿼리 방식보다는 낫기 때문입니다.</p>\n<p>여기서 현재는 아직 redis에 인증 및 인가용 refreshtoken, 실시간 이벤트 발급 캐싱용 이렇게 2가지를 사용하고 있었고, db에 접근하지 않고 빠른 조회를 위해 사용하기 위해서 redis를 사용했었기 때문에 <code class=\"language-text\">2번</code>을 사용했습니다.</p>\n<p>반대로 <code class=\"language-text\">업데이트</code>의 경우에도 2가지를 고민해 볼 수 있었습니다.</p>\n<ol>\n<li>인증 경험치가 업데이트 될 때 마다, redis의 데이터도 같이 업데이트 하여 실시간을 유지</li>\n<li>scheduler를 통해 특정 시간에 업데이트 하도록 하기</li>\n</ol>\n<p>처음에는 1번을 적용했었습니다. 더 좋은 user experience를 제공해주기 때문이었습니다.</p>\n<h3 id=\"인증-업데이트-마다-redis에-같이-했을-때의-문제점\" style=\"position:relative;\"><a href=\"#%EC%9D%B8%EC%A6%9D-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8-%EB%A7%88%EB%8B%A4-redis%EC%97%90-%EA%B0%99%EC%9D%B4-%ED%96%88%EC%9D%84-%EB%95%8C%EC%9D%98-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"인증 업데이트 마다 redis에 같이 했을 때의 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>인증 업데이트 마다 redis에 같이 했을 때의 문제점</h3>\n<p>“실시간을 유지하기 위해 매번 redis와 db를 접근해야 할까”에 대한 피드백을 받았습니다.</p>\n<p>실시간 변경이 필수 기능도 아니였고, 인증 업데이트 트래픽은 인증시간인 매 정각 10분 사이에 일어나기 때문에, db 업데이트 후 트랜잭션 밖에서 redis에 데이터를 저장한다 하더라도 하더라도 매번 조회하기 때문에 인증 시간에 너무 많은 일을 하기 때문에 다른 작업에 영향이 갈 수 있다고 판단하였습니다.</p>\n<p>따라서 매 인증이 끝나고 바로 업데이트를 할 수 있도록 인증 시간 외의 시간에 scheduler를 적용하여 업데이트를 적용하였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@Scheduled(cron = \"0 11 * * * *\")\npublic void updateAllRanking() {\n\tList&lt;Member> members = memberSearchRepository.findAllMembers();\n\tList&lt;UpdateRanking> updateRankings = members.stream()\n\t\t.map(MemberMapper::toUpdateRanking)\n\t\t.toList();\n\n\trankingService.updateScores(updateRankings);\n}</code></pre></div>\n<h2 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<p>결과적으로\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 574px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACuElEQVQoz02SzW8TVxTF/RcExfbMvPfGHnvsZBw7H9igQhJs5sMznnGLkyhFaYKaNhEEVTSgCBAIlA0gsUNIVcWCjw3toqraCqntiq76V8Bf80MzJlEWR096996je849uWK+S3GyixAuwvIRJQ9hB4h2hHa6n0GciRBOkNWk5WOYLp1mzMPhFvsdn6bVQ1QCZMUn1z68SufJHurSKtKOUFaEsTGi8M827vsHBP8dov37HdqjDZQ9QDoxqhbw+vwSH/Z2+H+xw+OpWbRKf0w4f/A9C/d2UPEKsj5AVQdo65co/7HLxXf38d89oP33LbSHl1G1GNmIKTVink63+H2qyp8thzvTbTTr84bFQpdU9liyN5Zc8RFzIfpcH302QMz1EbaPUC6y5GKYHnbpIuutLrFzATOdO5Is7YAM1fRjjNRLWQ6QZR9ph6jGENVMkClmEszWEDGTkD+9Sr4+wEj7srmA3BFJhvQo1rhoCBct38WoRujlPobwkNUQWQvRLA+94mPW+qis38/IxhueIBRHb9nHWllleneD+tVNnN1N7CtfI+YiTDvinPst7cUNjGqAsvsnCNMNU6np5wnZetmj8XSH5b/ucubXfZZ+u83CLzcQwQg1leB8sc5UZ42ik6A5CbrpHVuVMwyXQprFQhdDd8e+lTz0yR6TE0ucmlhiYuI82qkuMj1cyUUXPXTZI1gOWRnENJsBWmlsVW567xu6Px+w+NM+9ZtbGLUQNTNEO7zMwpsfOPvyRzqvbiCebyKWh6jaADWToDsJz25+yftnI7zliEnpo6oBuWqywvzeNq1rV7BGq4h6iHJi9K0R9YMtZm9tk2ZVXF9DtGNkStgYkLcHvLj7FR/frnHhXEhefSZMJWdZLPSOJYuyh9Q99EKP45wWXaTpZQeTZQ/N9DjbCUnciJIdHKfjE1v4hp581Y1/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Alt text\"\n        title=\"Alt text\"\n        src=\"/static/7c0f8d47ec5484066e4c18158a424614/86389/image.png\"\n        srcset=\"/static/7c0f8d47ec5484066e4c18158a424614/e9ff0/image.png 180w,\n/static/7c0f8d47ec5484066e4c18158a424614/f21e7/image.png 360w,\n/static/7c0f8d47ec5484066e4c18158a424614/86389/image.png 574w\"\n        sizes=\"(max-width: 574px) 100vw, 574px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\n위와 같은 구조를 구성하게 되었으며, 랭킹에 대해 트래픽이 집중된 시간을 피해 업데이트를 하고 랭킹을 빠르게 조회할 수 있습니다.</p>\n<p>이상으로 모아밤 서비스의 랭킹 시스템 도입기였습니다. 서비스 로직상 랭킹 로직 자체가 간단했지만 조건이 많아지게 된다면 그에 따른 변화에 대해서는 추가적으로 포스팅할 예정입니다.</p>","excerpt":"안녕하세요. 모아밤팀의 서버 개발자 박세연입니다! 랭킹 시스템을 도입했던 경험을 공유하고 싶어 작성합니다. 서비스 분석 모아밤 서비스의 경우 이용자들은 매일 인증을 통해 경험치를 얻게 됩니다. 이러한 경험치를 기준으로 랭킹이 있다면, 서로 경쟁을 통해 더욱 열심히 인증을 참여할 수 있기 때문에 도입하게 되었습니다. 랭킹의 기준 모아밤에서 랭킹의 기준은 사용자가 인증할때 마다 쌓이는 경험치입니다. 랭킹에서 보여주는 데이터 랭킹에서는 현재 , , 을 보여주고 있습니다. 모아밤 서비스의 트래픽 특성 랭킹 업데이트 매시 15분 모든 회원에 대해 업데이트를 진행 랭킹 조회 사용자의 요청이 있을 경우 위와 같은 특성을 봤을 때 대부분의 트래픽은 랭킹조회에서 발생하는 것을 알 수 있습니다. 설계 1. DB만으로 구성  사실 현재는 랭킹 자체가 지금까지 쌓아온 인증 경험치에 대해 매기고 있기 때문에 아주 단순한 구조 입니다. 따라서 위와 같이 조회할때는 단순 조회 랭킹에 대한 score를 업데이…","frontmatter":{"date":"December 06, 2023","title":"모아밤 랭킹 시스템 도입기","categories":"Tech","author":"박세연","emoji":"🦻🏼🖥️"},"fields":{"slug":"/ranking-system/"}},"next":{"id":"9406497c-9b1c-5499-8eef-a5a4f1a67e27","html":"<p>안녕하세요. 현재 데브코스 4기로 활동 중인 모아밤팀 서버 개발자 홍혁준입니다.</p>\n<p>이번 포스팅에서 <strong>실시간 선착순 시스템</strong>에 대해 이야기를 풀어내 보려고 합니다. 감사합니다.</p>\n<hr>\n<h2 id=\"배경\" style=\"position:relative;\"><a href=\"#%EB%B0%B0%EA%B2%BD\" aria-label=\"배경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>배경</h2>\n<p>저희 모아밤 서비스는 사용자들을 위해 쿠폰 이벤트를 도입하게 되었습니다.\n현재 생각 중인 쿠폰은 선착순으로 진행하는 이벤트로 사용자들이 다양한 종류의 N개 쿠폰을 선착순으로 지급 받도록 할 계획입니다.</p>\n<p>선착순 쿠폰 발급 이벤트는 짧은 시간에 많은 트래픽이 발생합니다.\n중요한 점은 서버가 다운되지 않고 수량 제한에 맞춰 정확하게 쿠폰이 발급되어야 합니다.\n이런 사항들을 모아밤에서는 어떻게 해결했는지 살펴봅시다.</p>\n<h3 id=\"요구사항\" style=\"position:relative;\"><a href=\"#%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD\" aria-label=\"요구사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>요구사항</h3>\n<ul>\n<li>사용자들은 정해진 재고에 따라 선착순으로 쿠폰을 발급 받을 수 있다.</li>\n<li>동일한 이벤트에서 동일 사용자가 쿠폰을 중복하여 발급 받을 수 없다.</li>\n<li>쿠폰은 발급 후 쿠폰함 혹은 결제창에서 1회 사용 가능하다.</li>\n</ul>\n<h3 id=\"고민사항\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%AF%BC%EC%82%AC%ED%95%AD\" aria-label=\"고민사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고민사항</h3>\n<ul>\n<li>N번의 선착순일 때, 정확하게 N번 발급해줄 수 있어야 합니다.</li>\n<li>쿠폰 발급 요청을 여러번 하는 경우 최초 요청을 선착순 발급 기준으로 1회만 받습니다.</li>\n<li>짧은 시간 내에 발생하는 높은 트래픽을 감당해야 합니다.</li>\n</ul>\n<hr>\n<h2 id=\"모아밤의-쿠폰-발급-아키텍처\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98\" aria-label=\"모아밤의 쿠폰 발급 아키텍처 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤의 쿠폰 발급 아키텍처</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAj0lEQVQY031PSwoCMRTr/a/gFQQv4A3ceQBltOKu2g/t9Bt5GQZcOAZCXtM0vCpsYIyB3jt1pZz/QTJKhhgjWmtkKYU6zzN95xwZQkDOmay1kpKVkvvjicv1xlIlhjGGQSmw1vKxlMistcY0TdSUEu/E997DvN5Az9gfz9gdTkvhuurWl78hm/9C6wOlLdkPRUA4TbNfKVQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon1.png\"\n        title=\"coupon1.png\"\n        src=\"/static/436573b6d1398874d65228a206559242/37523/coupon1.png\"\n        srcset=\"/static/436573b6d1398874d65228a206559242/e9ff0/coupon1.png 180w,\n/static/436573b6d1398874d65228a206559242/f21e7/coupon1.png 360w,\n/static/436573b6d1398874d65228a206559242/37523/coupon1.png 720w,\n/static/436573b6d1398874d65228a206559242/302a4/coupon1.png 1080w,\n/static/436573b6d1398874d65228a206559242/21b4d/coupon1.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>쿠폰 발급을 위한 흐름을 살펴봅시다.</p>\n<ol>\n<li>사용자가 쿠폰 발급 요청을 서버로 보냅니다.</li>\n<li>서버에서는 요청을 받아 쿠폰 발급 로직을 처리합니다.</li>\n<li>발급된 쿠폰이 데이터베이스에 저장됩니다.</li>\n</ol>\n<p>이처럼 쿠폰 발급 요청은 매우 간단합니다. 하지만 쿠폰 발급 요청이 많아지고 트래픽이 많아진다면,\n그만큼 동시에 들어오는 요청이 많을 텐데 Race Condition 문제는 어떻게 해결해야 할까요?\n또 Race Condition 문제가 발생하지 않더라도 트래픽이 API 처리량을 넘어간다면 장애가 발생할텐데,\n이런 문제들이 어떤 상황에 발생하는 것이고 어떤 해결방법이 있고 모아밤에서는 어떻게 해결했을까요?\n계속해서 살펴봅시다.</p>\n<br/>\n<h3 id=\"race-condition-살펴보기\" style=\"position:relative;\"><a href=\"#race-condition-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"race condition 살펴보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Race Condition 살펴보기</h3>\n<blockquote>\n<p>Race Condition (경쟁 상태) : 둘 이상의 입력 또는 조작의 타이밍, 순서 등이 결과값에 영향을 줄 수 있는 상태</p>\n</blockquote>\n<p>모아밤 서비스에서 사용자들에게 선착순으로 100개의 쿠폰을 지급한다고 가정해봅시다.</p>\n<p>개발 관점으로 보면 여러명의 사용자가 쿠폰을 동시에 발급받아서 쿠키 재고를 감소시킬 수 있게 됩니다.\n즉 쿠폰(공유 자원)에 N명의 사용자가 접근하여 읽거나 쓰려고 하는 Race Condition이 발생할 수 있게 됩니다.</p>\n<br/>\n<p><strong>[그림으로 이해하기]</strong></p>\n<p>단, 한명의 사용자에게만 쿠폰을 지급하는 이벤트가 있다고 가정해봅시다. 이해를 위해 재고 감소 과정을 표현했습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACBElEQVQoz22S3WsTQRTF99/1QdGKiChS+iiIotA3H/omitpabH1QW2ttjdWEIEk2ye5287VJNsluPhp3d/bjJzN2K4oHLgNz75x7z7mjZVmGhFg4JM47ksEBbn0Xr/mGWXOTYFwlR+QbLIxNfGOHfuU1S3uX0N4mntsqn2UpWk6YJoKNjSesra1yfPSJVCwRwYxYBAgRc3Z2RhwFJNEcES7wJ0PW1x+zcv0qJ99OFEeSJGi/mTP16Onzlzx4tE6p/EMVTGdzvheLVCoVTNPEMEwM85QwEgRhxOFRgWcvNjEt+0KFtlwu6Xa7WJbFZDxGRCHD4ZAwDEmSGN/38TxPxXg8ZrFYkKYJ0+kU3/cIgp+q3nVdVavNZjNM06LVatHr9bBtm26vR5qmpGnG/yAVSeJSqUS5XEbXder1uhpKy4tebW1z684qly5f4+Dws7qbz+dMJhMcx1EN5SSSSCIIQnL/5ZmHFgSBGr9Q+MrO7lv29g+wWy01oZRYq+nUdJ1mo4FhGEqaRBhFCCHOlaR/CAeDAcViUY3e0HVM06Ddbquk9Lff79PpdFSMXJfRaEQcx/jTKffuP+Tm7btcWbmhGqilyIcXHc7PPCm/SrVapdlscmpZyifpsyQcDl2OvxTY2//I+w97anJpkfaX2ednLuXfReSeSXieT6PRUIvoO46yRP6WX86w5Dgglv5HAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon2.png\"\n        title=\"coupon2.png\"\n        src=\"/static/5b8872ac290d498cb5e670cd5d5213bb/37523/coupon2.png\"\n        srcset=\"/static/5b8872ac290d498cb5e670cd5d5213bb/e9ff0/coupon2.png 180w,\n/static/5b8872ac290d498cb5e670cd5d5213bb/f21e7/coupon2.png 360w,\n/static/5b8872ac290d498cb5e670cd5d5213bb/37523/coupon2.png 720w,\n/static/5b8872ac290d498cb5e670cd5d5213bb/302a4/coupon2.png 1080w,\n/static/5b8872ac290d498cb5e670cd5d5213bb/21b4d/coupon2.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 그림처럼 클라이언트 A가 쿠폰을 가져옵니다.\n하지만 클라이언트 B도 클라이언트 A가 쿠폰을 발급받기 전에 쿠폰을 가져오게 되고 클라이언트 A와 B 모두 가져온\n쿠폰 재고는 1개가 있습니다. 때문에, 결국 클라이언트 A와 B가 쿠폰을 발급받게 되고 쿠폰 재고는 -1개가 됩니다.\n이러한 상황을 Race Condition이라고 할 수 있습니다.</p>\n<p>이처럼 Race Condition은 두 개 이상의 스레드가 공유 데이터에 접근할 때 발생하는 문제이므로\n싱글 스레드로 작업을 한다면 레이드 컨디션은 일어나지 않습니다.\n하지만 싱글 스레드 작업은 먼저 요청한 사용자가 쿠폰이 발급되기까지 대기하다가 다른 사람들이 쿠폰 발급이\n가능해지기 때문에 성능이 좋지 못합니다. 그렇다면 어떻게 해결해야 할까요?</p>\n<hr>\n<h2 id=\"문제-해결---java-x\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---java-x\" aria-label=\"문제 해결   java x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 - Java <strong>(X)</strong></h2>\n<h3 id=\"자바의-synchronized-키워드-이용하기\" style=\"position:relative;\"><a href=\"#%EC%9E%90%EB%B0%94%EC%9D%98-synchronized-%ED%82%A4%EC%9B%8C%EB%93%9C-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"자바의 synchronized 키워드 이용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>자바의 synchronized 키워드 이용하기</h3>\n<p>자바의 synchronized는 멀티 스레드 환경에서 단 하나의 스레드만이 특정 코드 블럭을 실행하도록 보장하는\n역할을 합니다. 그래서 해결할 수 있을 거라 생각할 수 있습니다. 하지만 이는 서버가 여러 대가 되는 순간 다시\nRace Condition이 발생하게 되어 적절하지 않습니다.</p>\n<hr>\n<h2 id=\"문제-해결---lock-x\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---lock-x\" aria-label=\"문제 해결   lock x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 - Lock <strong>(X)</strong></h2>\n<h3 id=\"mysql-lock과-redis를-활용한-분산락을-이용하기\" style=\"position:relative;\"><a href=\"#mysql-lock%EA%B3%BC-redis%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EB%B6%84%EC%82%B0%EB%9D%BD%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"mysql lock과 redis를 활용한 분산락을 이용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MySQL Lock과 Redis를 활용한 분산락을 이용하기</h3>\n<p><a href=\"https://hongdosan.tistory.com/373\">[🌐 동시성 이슈 보러 가기]</a></p>\n<p>MySQL Lock과 Redis Lock을 이용해도 충분히 해결할 수 있습니다. 하지만 다시 생각해봅시다.\n우리는 선착순으로 쿠폰을 발급해주기 위해 Coupon Table에서 해당 쿠폰의 갯수를 먼저 가져와야 합니다.\n그리고 나서 쿠폰 재고를 감소함과 동시에 한 사용자의 지갑에 쿠폰을 생성해줘야 합니다.\n즉 <strong>이 모든 과정에 락을 걸어야 하는 것</strong>입니다.</p>\n<p>이렇게 된다면 락을 거는 구간이 길어져서 성능에 불이익이 있을 수밖에 없습니다.\n예를 들어, n초가 걸린다면 n초만큼 계속해서 밀리게 되고 사용자는 밀린 시간만큼 기다려야 합니다.\n따라서 해당 방법도 적절하지 않을 것 같습니다.</p>\n<hr>\n<h2 id=\"문제-해결---redis-incr-x\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---redis-incr-x\" aria-label=\"문제 해결   redis incr x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 - Redis INCR <strong>(X)</strong></h2>\n<h3 id=\"redis의-incr-혹은-decr-명령어\" style=\"position:relative;\"><a href=\"#redis%EC%9D%98-incr-%ED%98%B9%EC%9D%80-decr-%EB%AA%85%EB%A0%B9%EC%96%B4\" aria-label=\"redis의 incr 혹은 decr 명령어 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis의 INCR 혹은 DECR 명령어</h3>\n<blockquote>\n<p>INCR 명령어 : 키에 대한 값을 1씩 증가시키는 명령어로 성능도 매우 빠릅니다.<br>\nDECR 명령어 : 키에 대한 값을 1씩 감소시키는 명령어로 성능도 매우 빠릅니다.</p>\n</blockquote>\n<p>Redis는 싱글 스레드이기 때문에, Race Condition도 해결할 수 있습니다.\n또한 저희의 핵심은 쿠폰 개수이므로 쿠폰 개수 정합성만 관리하면 충분합니다.\n때문에 <strong>성능도 매우 빠른</strong> <strong>Redis의 DECR 명령어를 활용해 해결하는 것은 매우 적절</strong>합니다.</p>\n<br/>\n<p><strong>[redis-cli 실습]</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhUlEQVQY063QzQ6CMBAEYN5DowEtvwVaqFsVkAvh/d9oyBZiPPLjYQ5z+TK7XmxahPoFX9a4JApXTqrnJAonIXEO89XxymZARr1Db8UD94IQVe+l0z4wpQ+Ees5gaRHVzQGw/QXpP2Bm+++ZQlnwX7kzvhnU3egW8u/45CA3bi33QJrN4AQ/hrGi8ZITGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon3.png\"\n        title=\"coupon3.png\"\n        src=\"/static/013d5820ae4efca062bf60f278d9bfe6/37523/coupon3.png\"\n        srcset=\"/static/013d5820ae4efca062bf60f278d9bfe6/e9ff0/coupon3.png 180w,\n/static/013d5820ae4efca062bf60f278d9bfe6/f21e7/coupon3.png 360w,\n/static/013d5820ae4efca062bf60f278d9bfe6/37523/coupon3.png 720w,\n/static/013d5820ae4efca062bf60f278d9bfe6/302a4/coupon3.png 1080w,\n/static/013d5820ae4efca062bf60f278d9bfe6/b94e3/coupon3.png 1126w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 이미지처럼 incr 명령어로 값을 1씩 증가시키고 decr 명령어로 값이 1씩 감소하는 것을 살펴볼 수 있습니다.\n이처럼 해당 명령어로 발급된 쿠폰 개수를 제어할 수 있게 되는 것입니다.\n즉, 쿠폰 발급전에 쿠폰 재고를 1 증가시키고 반환되는 값이 100보다 크면 쿠폰 발급을 멈추는 로직을 작성할 수 있습니다.</p>\n<h3 id=\"흐름\" style=\"position:relative;\"><a href=\"#%ED%9D%90%EB%A6%84\" aria-label=\"흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>흐름</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.55555555555555%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACJUlEQVQoz3WS60/aYBTG+/9n9yyafVhc3JYlRsW47cNu8a6JyVRAtEBBCi0UsBdqC73Bb3lfrUOzneSkp0/Pec5zzqkCkI37RK1NJvpXuucFvNoGQaNA0PpOkkREUUyWxnjaF/x6AauygVUpEDQ/S59GtqBhNpuhiGBnd5enz56yuLjA2dlvkiigZ7a5qJRotVpoWoNOx6Br6kTjG+IoxB853PgOI++acRg+JHRdD71tYJg9bMdlOgPDMDk9K9JsNjEMg45hoLc7BEFIHCdY1oCFN2958uI1K2sFclNE8bylaSo7JXGMbdt0u12q1aqMHcchu/seRRFxHBOGIUlyiyEU9vrXbH7b4cfWHnv7B1SrNZksVG1tb3N8fMylqnJaLKNpdVzXlY2jOGY6nZIkyQNBSr/fZ72wwcrqGkvLH6hcXEqVIll2fWQCy7JM+rzl+YoI5k2MkaSpHMWyLEzTpNFoMBgMGA6vCcdj2dAwTVZW11n++In9gyNJKHAlZxcdxXMSRZJYEBweHlEqlbi6ukJVq3INAhcrGQyG7O4d8PPXFueVi78jC5m55wrzbkKl53n0ej1GoxG+798XZo+umXMo80BOKMy2HYrFIuVymZOTE1RVpd1uEwQ3pGmGPxwy9UfMslQeJq//L6FQVKvV0HUdx7YZWha240h8MpnQrGu8fP6KpXfv5futwn8RJgnzh7q/6t2ec8xxXS6rNWp17f7XESP/AUg1hqvtcIkCAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon4.png\"\n        title=\"coupon4.png\"\n        src=\"/static/00ac516debd4e87054fc9af4f42e702b/37523/coupon4.png\"\n        srcset=\"/static/00ac516debd4e87054fc9af4f42e702b/e9ff0/coupon4.png 180w,\n/static/00ac516debd4e87054fc9af4f42e702b/f21e7/coupon4.png 360w,\n/static/00ac516debd4e87054fc9af4f42e702b/37523/coupon4.png 720w,\n/static/00ac516debd4e87054fc9af4f42e702b/302a4/coupon4.png 1080w,\n/static/00ac516debd4e87054fc9af4f42e702b/21b4d/coupon4.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>Redis는 싱글-스레드 기반으로 동작하기 때문에,\n위 흐름처럼 클라이언트 A가 INCR 명령어를 실행했다면 클라이언트 B는 해당 명령어 작업이 종료될 때까지 기다렸다가 INCR 명령어를 실행하게 됩니다.\n이처럼 <strong>모든 스레드에서는 언제나 최신값을 가져갈 수 있게 됩니다.</strong></p>\n<h3 id=\"문제점\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제점</h3>\n<p>Redis의 INCR을 사용해, 선착순으로 쿠폰을 발급할 수 있게 하였습니다.\n하지만 이 방식은 높은 트래픽이 발생했을 때, 발생하는 문제점들을 해결하지 못했습니다.\n예를 들어, 이는 선착순 쿠폰 재고가 10_000개이고 선착순 쿠폰 발급 가능 시각이 되어서 10_000명의 사용자가 동시에 선착순 쿠폰 요청을 보냈다고 가정해봅시다.\n이 경우 <strong>10_000개의 쿠폰 저장 쿼리</strong>가 동시에 발생합니다. 이로 인해 데이터베이스에 설정된 1분에 가능한 최대 INSERT 수가 100명이라면 모든 쿼리가 날라가는데, 총 100분이 걸리게 됩니다.\n최악의 경우 데이터베이스의 타임아웃보다 지연시간이 길어져서 쿠폰 저장이 되지 않는 이슈도 발생하게 됩니다.</p>\n<h3 id=\"해결-방법\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\" aria-label=\"해결 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결 방법</h3>\n<p>해결 방법으로는 여러가지가 있을 텐데, 그 중 대표적으로 메시징 큐에 담아 처리하는 방법이 있습니다.\n메시징 큐에 담아 처리하는 방법으로는 Kafka와 RabbitMQ를 사용하면 해결이 가능할 것입니다.\n하지만 <a href=\"https://hongdosan.tistory.com/374\">FCM Token 도입기</a> 포스팅 에서도 말했듯 초기 자원이\n한정적이라 서버 비용 추가 발생 시, 감당이 힘들다는 문제점과 초기 프로젝트임만큼 오버 엔지니어링입니다.\n또한 러닝커브가 높고 현재 사용되는 기술에 있어서 이해와 공부가 먼저라고 생각하여 해당 방법은 고려 대상에서 제외되었습니다.</p>\n<hr>\n<h2 id=\"문제-해결---redis-queue-system-o\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---redis-queue-system-o\" aria-label=\"문제 해결   redis queue system o permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제 해결 - Redis Queue System <strong>(O)</strong></h2>\n<p>앞서 포스팅에 적었던 문제 해결 방식들은 모두 적절하지 않다고 판단했습니다.\n따라서 “쿠폰 발급 요청에 대한 대기열을 만들어서 해결하자.”란 결론을 내리게 되었습니다.</p>\n<h3 id=\"왜-redis를-선택했을까\" style=\"position:relative;\"><a href=\"#%EC%99%9C-redis%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%96%88%EC%9D%84%EA%B9%8C\" aria-label=\"왜 redis를 선택했을까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>왜 Redis를 선택했을까?</h3>\n<p>대기열 저장소 선택에 있어서 고려사항은 고성능 처리 기능을 제공해야 해서 Redis를 고려하게 되었습니다.\n또한 저희 모아밤의 한정적인 자원에서 이미 Redis 사용을 기획에 포함시켰기 때문에, Redis 선택은 매우\n적합하다고 생각했습니다. 기술적인 면에서도 Redis는 아래와 같은 근거로 적절하다고 판단했습니다.</p>\n<ul>\n<li>Redis는 이미 많은 서비스에서 사용되는 검증된 저장소입니다.</li>\n<li>Redis는 I/O이 빠른 In-memory 데이터베이스입니다.</li>\n<li>다양한 자료구조 지원으로 요구사항을 쉽게 해결 가능합니다.</li>\n</ul>\n<h3 id=\"redis의-어떤-명령어와-자료구조를-선택할까\" style=\"position:relative;\"><a href=\"#redis%EC%9D%98-%EC%96%B4%EB%96%A4-%EB%AA%85%EB%A0%B9%EC%96%B4%EC%99%80-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%95%A0%EA%B9%8C\" aria-label=\"redis의 어떤 명령어와 자료구조를 선택할까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis의 어떤 명령어와 자료구조를 선택할까?</h3>\n<p><strong>[Redis KEYS 명령어] - X</strong></p>\n<p>KEYS 명령어는 Full-Scan을 합니다. 그리고 시간복잡도가 O(n)이기 때문에,\n데이터가 많을 수록 성능이 떨어질 수밖에 없습니다. 심지어 Redis는 싱글-스레드이기 때문에 명령어 수행 시\n다른 명령어들은 블락되고 그만큼 지연되어 적절하지 않다고 판단했습니다.</p>\n<br/>\n<p><strong>[대기열 Redis의 List 자료구조] - X</strong></p>\n<p>대기열을 추가하는데 List의 RPUSH와 대기열에서 대상을 가져오는 데 LPOP을 사용할 수 있습니다.\n두 명령어는 O(1)의 시간복잡도로 사용할 수 있습니다. 하지만 문제점이 있습니다.\nList 자료구조의 특정값의 순서를 찾을 수 있는 LPOS 명령어는 순차탐색이 필요하여 O(n)의 시간복잡도가 소요됩니다.\n또한 동일한 사용자가 쿠폰 발급 요청을 했을 때, List 자료구조를 사용하면 새로운 데이터가 계속되어 추가됩니다. 따라서 적절하지 않다고 판단하였습니다.</p>\n<br/>\n<p><strong>[대기열 - Redis의 Sorted Set 자료구조] - O</strong></p>\n<p>Sorted Set은 특정 스코어를 기반으로 정렬하여 스코어로 TimeStamp를 사용할 수 있습니다.\n또한 대기열을 추가하고 가져오는데 ZADD 명령어와 ZRANGE 명령어를 사용할 수 있습니다.\n두 명령어의 시간복잡도는 O(log(n))이기 List보다는 느리지만, 이 정도면 충분하다고 생각했습니다.</p>\n<p>추가적으로 Sorted Set 자료구조에서는 Sorted Set은 ZADD NX 명령어 사용 시,\n데이터가 중복되지 않아 중복 쿠폰 발급 요청이 들어와도 최초 요청 기준으로 대기열을 관리할 수 있습니다.\n이러한 이유로 Sorted Set은 요구사항들을 간단하고 준수한 성능으로 만족시킬 수 있을 거라 판단하여 선택하게 되었습니다.</p>\n<hr>\n<h2 id=\"redis-sorted-set으로-선착순-쿠폰-발급-시스템-구현하기\" style=\"position:relative;\"><a href=\"#redis-sorted-set%EC%9C%BC%EB%A1%9C-%EC%84%A0%EC%B0%A9%EC%88%9C-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"redis sorted set으로 선착순 쿠폰 발급 시스템 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis Sorted Set으로 선착순 쿠폰 발급 시스템 구현하기</h2>\n<p>위와 같은 다양한 해결방법을 고민하다가 모아밤에서는 결국 Redis에서 제공하는 Sorted Set을 활용하게 되었습니다.\nSorted Set을 활용해 모든 요청이 바로 Database에 바로 부하가 가지 않고 순서대로 일정 범위만큼씩 처리하도록 구성했습니다.</p>\n<h3 id=\"모아밤에서의-sorted-set-구조\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4%EC%97%90%EC%84%9C%EC%9D%98-sorted-set-%EA%B5%AC%EC%A1%B0\" aria-label=\"모아밤에서의 sorted set 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤에서의 Sorted Set 구조</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApklEQVQY03WQbQ+DIAyE+f//cUYFgh+Mb4BRiN5yzXRkcU2ag/D02qJCCJjnGdR1XZFzxjiOcM7BdR2appG3GCOGYbjP5FhHzloryneFT5zniX3fcRyHGL6qCtoYaK3F5Inz3kvDuq5F+76HIsBkEEop3cW8l0YXR/3HqRK6gp20NrJKOWFpypimCW3bShpjviv/mrL79VfLstzTPHFc2/sg/LZteANdeYPJipQFYAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon8.png\"\n        title=\"coupon8.png\"\n        src=\"/static/0adc4fd89a3a4b356eb7f263d1b3096a/37523/coupon8.png\"\n        srcset=\"/static/0adc4fd89a3a4b356eb7f263d1b3096a/e9ff0/coupon8.png 180w,\n/static/0adc4fd89a3a4b356eb7f263d1b3096a/f21e7/coupon8.png 360w,\n/static/0adc4fd89a3a4b356eb7f263d1b3096a/37523/coupon8.png 720w,\n/static/0adc4fd89a3a4b356eb7f263d1b3096a/302a4/coupon8.png 1080w,\n/static/0adc4fd89a3a4b356eb7f263d1b3096a/21b4d/coupon8.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>Sorted Set은 하나의 Key에 여러 Value와 Score를 가지고 있으며 중복되지 않는 Value가 Score 순으로 데이터를\n정렬합니다. 만약 Score가 같으면 Value로 정렬됩니다.</p>\n<p>모아밤에서는 쿠폰명이 유니크한 값이기 때문에, Sorted Set의 Key로 쿠폰명으로 하였고 Value를 사용자\nID으로 선정했습니다. 마지막으로 Score는 참여 순서로 정렬하기 위해 쿠폰 발급 요청 시간을 유닉스타임(m/s) 값으로\n선정했습니다.</p>\n<h3 id=\"모아밤-쿠폰-발급-흐름\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%ED%9D%90%EB%A6%84\" aria-label=\"모아밤 쿠폰 발급 흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤 쿠폰 발급 흐름</h3>\n<p><strong>이해를 위해 100명에게 지급하는 선착순 쿠폰이 있고 1000명이 동시에 쿠폰을 요청했다고 가정해봅시다.</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABB0lEQVQoz32SP0vEQBDF90NbWfo5rK5VsLfTQlDORkRBsEuRi4Rkk+y/bJInb2C93HJxYDJhM/nNY96qZVkwjiNY53nGNE2SPLPWwjknNYQgPYxU83eG4o9N0wjEe4+u69D3vWRZlpJFUWAYhhNgyhyqCDLGIA+qpSoO4PcY4wkoB6ZUa+l5I6O3FoOxOBfHXlY+AbU1Kam8v7zA690tZgDeWdln27aiOMMDy3xUmE9OwOfdNarPd5n+U1Wyb66B60gmEv74tMfbx9cGcLVHqQB026I8HATGc5pJE2lWcAZXuxfcPHz/r5A1eIdOa2itRV1d138mrcOHiDFO54E5NL9rW27z2vwCeVe/4nwm5ZMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon7.png\"\n        title=\"coupon7.png\"\n        src=\"/static/c3f2dbfbd172f705e826da43e5187be9/37523/coupon7.png\"\n        srcset=\"/static/c3f2dbfbd172f705e826da43e5187be9/e9ff0/coupon7.png 180w,\n/static/c3f2dbfbd172f705e826da43e5187be9/f21e7/coupon7.png 360w,\n/static/c3f2dbfbd172f705e826da43e5187be9/37523/coupon7.png 720w,\n/static/c3f2dbfbd172f705e826da43e5187be9/302a4/coupon7.png 1080w,\n/static/c3f2dbfbd172f705e826da43e5187be9/21b4d/coupon7.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ol>\n<li>1000명의 사용자가 동시에 쿠폰 발급 요청을 보냅니다.</li>\n<li>서버는 해당 요청을 바로 처리하지 않고 대기열의 크기가 100보다 작다면 계속해서 대기열에 등록합니다.</li>\n<li>대기열이 크기가 100과 같거나 크다면 해당 사용자들은 대기열에 등록하지 않습니다.</li>\n<li>서버는 스케쥴러를 통해 정해진 주기마다 대기열에 등록된 사용자 중 10명씩 쿠폰 발급 처리를 진행합니다.</li>\n<li>서버는 선착순 이벤트가 종료되기 전까지 2번부터 다시 반복합니다.</li>\n</ol>\n<h3 id=\"모아밤-대기열-등록-코드\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EB%8C%80%EA%B8%B0%EC%97%B4-%EB%93%B1%EB%A1%9D-%EC%BD%94%EB%93%9C\" aria-label=\"모아밤 대기열 등록 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤 대기열 등록 코드</h3>\n<ul>\n<li>findByNameAndStartAt(…) : 요청이 들어오면 발급 가능한 쿠폰이 있는지 조회합니다.</li>\n<li>sizeQueue(…) : 시간복잡도가 O(1)인 Redis의 <a href=\"https://redis.io/commands/zcard/\">ZCARD</a> 명령으로 대기열 사이즈를 조회합니다.</li>\n<li>sendCouponIssueResult(…) : 선착순 가능 인원보다 대기열 사이즈가 같다면 비동기로 발급 실패 알림을 보냅니다.</li>\n<li>addIfAbsentQueue(…) : 시간복잡도가 O(log(n))인 Redis의 <a href=\"https://redis.io/commands/zadd/\">ZADD NX</a> 명령으로 대기열에 등록합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">registerQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">double</span> registerTime <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">validateRegisterQueue</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    couponManageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">addIfAbsentQueue</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> memberId<span class=\"token punctuation\">,</span> registerTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n    \n<span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">validateRegisterQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">LocalDate</span> now <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Coupon</span> coupon <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByNameAndStartAt</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> now<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorMessage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_COUPON_PERIOD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">int</span> maxCount <span class=\"token operator\">=</span> coupon<span class=\"token punctuation\">.</span><span class=\"token function\">getMaxCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> sizeQueue <span class=\"token operator\">=</span> couponManageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">sizeQueue</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxCount <span class=\"token operator\">==</span> sizeQueue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        notificationService<span class=\"token punctuation\">.</span><span class=\"token function\">sendCouponIssueResult</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token constant\">FAIL_ISSUE_BODY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorMessage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_COUPON_STOCK_END</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"모아밤-쿠폰-발급-코드\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%BD%94%EB%93%9C\" aria-label=\"모아밤 쿠폰 발급 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>모아밤 쿠폰 발급 코드</h3>\n<ul>\n<li>findByStartAt(…) : 스케줄러를 통해 1초마다 발급 가능한 쿠폰이 있는 지 체크합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Scheduled</span><span class=\"token punctuation\">(</span>fixedDelay <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">issue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">LocalDate</span> now <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">></span></span> optionalCoupon <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByStartAt</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>optionalCoupon<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>getCount(…) : 시간복잡도가 O(1)인 Redis의 <a href=\"https://redis.io/commands/get/\">GET</a> 명령을 통해 현재 발급 갯수를 조회하고 선착순 가능</li>\n</ul>\n<p>인원과 비교하여 발급이 가능한지 체크합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Scheduled</span><span class=\"token punctuation\">(</span>fixedDelay <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">issue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    \n    <span class=\"token keyword\">int</span> maxCount <span class=\"token operator\">=</span> coupon<span class=\"token punctuation\">.</span><span class=\"token function\">getMaxCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> currentCount <span class=\"token operator\">=</span> couponManageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">getCount</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxCount <span class=\"token operator\">&lt;=</span> currentCount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>rangeQueue(…) : 시간복잡도가 O(log(n) + m)인 Redis의 <a href=\"https://redis.io/commands/zrange/\">ZRANGE</a> 명령을 통해 대기열에서</li>\n</ul>\n<p>10명을 조회 후 쿠폰 발급을 진행합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Scheduled</span><span class=\"token punctuation\">(</span>fixedDelay <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">issue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    \n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> membersId <span class=\"token operator\">=</span> couponManageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">rangeQueue</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> currentCount<span class=\"token punctuation\">,</span> currentCount <span class=\"token operator\">+</span> <span class=\"token constant\">ISSUE_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId <span class=\"token operator\">:</span> membersId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        couponWalletRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponWallet</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> coupon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        notificationService<span class=\"token punctuation\">.</span><span class=\"token function\">sendCouponIssueResult</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token constant\">SUCCESS_ISSUE_BODY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>increase(…) : 시간복잡도가 O(1)인 Redis의 <a href=\"https://redis.io/commands/incrby/\">INCRBY</a></li>\n</ul>\n<p>명령어를 통해 발급 횟수만큼 현재 발급 갯수를 증가시켜줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Scheduled</span><span class=\"token punctuation\">(</span>fixedDelay <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">issue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    \n    couponManageRepository<span class=\"token punctuation\">.</span><span class=\"token function\">increase</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> membersId<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<h3 id=\"문제점-1\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90-1\" aria-label=\"문제점 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제점</h3>\n<p><strong>[상황]</strong></p>\n<p>코드를 보면, 대기열 등록에서와 쿠폰 발급에서 아래 명령을 통해 DB에 동일한 요청을 계속해서 보내고 있습니다.\n즉 불필요한 쿼리가 발생하고 최악의 경우 성능이 저하됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 대기열 등록의 동일한 요청</span>\n<span class=\"token class-name\">Coupon</span> coupon <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByNameAndStartAt</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> now<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorMessage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_COUPON_PERIOD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n<span class=\"token comment\">// 쿠폰 발급의 동일한 요청</span>\n<span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">></span></span> optionalCoupon <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByStartAt</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>[원인]</strong></p>\n<ul>\n<li>대기열 등록 : 사용자들이 쿠폰 발급을 위해 동일한 요청이 단기간에 날라옵니다.</li>\n<li>쿠폰 발급 : 스케줄러로 인해 1초마다 동일한 쿼리가 계속 발생합니다.</li>\n</ul>\n<p><strong>[해결]</strong></p>\n<p>현재 쿠폰은 변경 가능성이 없다고 봐도 무방합니다. 또한 동일한 요청을 보내고 별도의 연산 수행없이 동일한\n응답값을 받습니다. 따라서 Redis의 Cache 기능을 활용해 성능을 개선할 수 있을 것이라 판단했습니다.</p>\n<p>긴 글 읽어주셔서 감사합니다. 이상으로 포스팅은 여기서 마치고 Redis Cache에 대한 자세한 내용은 모아밤의 <strong>[Redis Cache 기능 도입기]</strong> 포스팅에서 이어나가겠습니다. 😁</p>\n<hr>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://hongdosan.tistory.com/entry/%EB%B2%A1%EC%97%94%EB%93%9C-%EB%8D%B0%EB%B8%8C%EC%BD%94%EC%8A%A4-TIL-%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%9D%B4%EC%8A%88-%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" title=\"동시성 이슈 해결하기 - 홍도산\">동시성 이슈 해결하기 - 홍도산</a></li>\n<li><a href=\"https://www.inflearn.com/course/%EC%84%A0%EC%B0%A9%EC%88%9C-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%8B%A4%EC%8A%B5/dashboard\">실습으로 배우는 선착순 이벤트 시스템 - 최상용</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=MTSn93rNPPE&#x26;t=710s\">선착순 이벤트 서버 생존기! 47만 RPM에서 살아남다?! - 우아한테크토크 김민국</a></li>\n<li><a href=\"https://redis.io/docs/data-types/sorted-sets/\">Redis Sorted Set - 공식문서</a></li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B0%B0%EA%B2%BD\">배경</a></p>\n<ul>\n<li><a href=\"#%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD\">요구사항</a></li>\n<li><a href=\"#%EA%B3%A0%EB%AF%BC%EC%82%AC%ED%95%AD\">고민사항</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98\">모아밤의 쿠폰 발급 아키텍처</a></p>\n<ul>\n<li><a href=\"#race-condition-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\">Race Condition 살펴보기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---java-x\">문제 해결 - Java <strong>(X)</strong></a></p>\n<ul>\n<li><a href=\"#%EC%9E%90%EB%B0%94%EC%9D%98-synchronized-%ED%82%A4%EC%9B%8C%EB%93%9C-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\">자바의 synchronized 키워드 이용하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---lock-x\">문제 해결 - Lock <strong>(X)</strong></a></p>\n<ul>\n<li><a href=\"#mysql-lock%EA%B3%BC-redis%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EB%B6%84%EC%82%B0%EB%9D%BD%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%98%EA%B8%B0\">MySQL Lock과 Redis를 활용한 분산락을 이용하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---redis-incr-x\">문제 해결 - Redis INCR <strong>(X)</strong></a></p>\n<ul>\n<li><a href=\"#redis%EC%9D%98-incr-%ED%98%B9%EC%9D%80-decr-%EB%AA%85%EB%A0%B9%EC%96%B4\">Redis의 INCR 혹은 DECR 명령어</a></li>\n<li><a href=\"#%ED%9D%90%EB%A6%84\">흐름</a></li>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90\">문제점</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EB%B2%95\">해결 방법</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0---redis-queue-system-o\">문제 해결 - Redis Queue System <strong>(O)</strong></a></p>\n<ul>\n<li><a href=\"#%EC%99%9C-redis%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%96%88%EC%9D%84%EA%B9%8C\">왜 Redis를 선택했을까?</a></li>\n<li><a href=\"#redis%EC%9D%98-%EC%96%B4%EB%96%A4-%EB%AA%85%EB%A0%B9%EC%96%B4%EC%99%80-%EC%9E%90%EB%A3%8C%EA%B5%AC%EC%A1%B0%EB%A5%BC-%EC%84%A0%ED%83%9D%ED%95%A0%EA%B9%8C\">Redis의 어떤 명령어와 자료구조를 선택할까?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#redis-sorted-set%EC%9C%BC%EB%A1%9C-%EC%84%A0%EC%B0%A9%EC%88%9C-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\">Redis Sorted Set으로 선착순 쿠폰 발급 시스템 구현하기</a></p>\n<ul>\n<li><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4%EC%97%90%EC%84%9C%EC%9D%98-sorted-set-%EA%B5%AC%EC%A1%B0\">모아밤에서의 Sorted Set 구조</a></li>\n<li><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%ED%9D%90%EB%A6%84\">모아밤 쿠폰 발급 흐름</a></li>\n<li><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EB%8C%80%EA%B8%B0%EC%97%B4-%EB%93%B1%EB%A1%9D-%EC%BD%94%EB%93%9C\">모아밤 대기열 등록 코드</a></li>\n<li><a href=\"#%EB%AA%A8%EC%95%84%EB%B0%A4-%EC%BF%A0%ED%8F%B0-%EB%B0%9C%EA%B8%89-%EC%BD%94%EB%93%9C\">모아밤 쿠폰 발급 코드</a></li>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C%EC%A0%90-1\">문제점</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#reference\">Reference</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"November 09, 2023","title":"모아밤의 실시간 선착순 쿠폰 이벤트 도입기","categories":"Tech","author":"홍혁준","emoji":"🧑🏻‍💻"},"fields":{"slug":"/coupon-event/"}},"prev":{"id":"d37e8b5a-8f6d-5642-bae2-1b2381790237","html":"<p>안녕하세요. 백엔드 데브코스 4기를 무사히 수료한 모아밤팀 서버 개발자 홍혁준입니다.<br>\n이번 포스팅에서 <strong>Caching</strong>에 대해 이야기를 풀어내 보려고 합니다. 감사합니다.</p>\n<hr>\n<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요</h1>\n<h3 id=\"문제\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C\" aria-label=\"문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제</h3>\n<p>현재 모아밤 서비스의 문제점은\n<a href=\"https://hongdosan.tistory.com/376\">Moabam Tech - 실시간 선착순 쿠폰 이벤트 도입기</a> 포스팅을 보면 알 수 있듯\n대기열 등록 및 쿠폰 발급 부분에서 DB에 동일한 요청을 계속해서 보내고 있습니다.\n즉 불필요한 쿼리가 발생하고 있습니다.</p>\n<h3 id=\"원인\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8\" aria-label=\"원인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인</h3>\n<p>사용자들이 선착순 쿠폰 발급을 위해 쿠폰 발급 요청을 하기 때문에,\n단기간에 동일한 요청이 여러번 발생합니다. 또한 스케줄러로 인해 1초마다 동일한 쿼리가 발생합니다.</p>\n<h3 id=\"해결\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0\" aria-label=\"해결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결</h3>\n<p>현재 모아밤 서비스는 쿠폰 정보 변경 가능성이 없다고 봐도 무방합니다.\n또한 동일한 요청을 보내고 별도 연산없이 동일한 응답값을 보내고 있습니다.\n따라서 <strong>캐싱 기능</strong>을 통해 성능을 개선할 수 있을 것이라 판단했습니다.</p>\n<hr>\n<h1 id=\"캐시란-무엇일까\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%9C%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C\" aria-label=\"캐시란 무엇일까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐시란 무엇일까?</h1>\n<p>캐시는 <strong>값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고,\n뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소</strong>입니다.\n애플리케이션은 데이터베이스를 얼마나 자주 호출하냐에 크게 좌우되는데,\n현재 모아밤은 쿠폰 데이터를 가져오기 한 번 이상의 데이터베이스 호출이 단기간 혹은 주기적으로 발생합니다.\n캐시는 이 문제를 해결할 수 있습니다. 글로만 보면 이해가 안가니, 그림을 보면서 캐시 흐름을 이해해봅시다.</p>\n<hr>\n<h3 id=\"그림으로-이해하기\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%A6%BC%EC%9C%BC%EB%A1%9C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0\" aria-label=\"그림으로 이해하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그림으로 이해하기</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApElEQVQI1zVPWwrCQBDr9byVR/IC/vjjCQShSLsPWnxsi7vus+1GZtCBkBBmQqZxzmFdV2zbhlIKjDGMaZqQcwaN9wFv61jXWhl/TXeolTNuQqMZhgEUSvDeYxxHKKWYP96jlIzLtcXxdIazlveklOi6DkIIaK2RU4S+G+z2BzTzPHNQSgkxRtjfEfkhBCzLgsfzhV5q1tSKPqH2xOTRhBjR9hpf4nvke4vCdcgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"img.png\"\n        src=\"/static/d54d7b59a8f869eeb3b15bb755660aec/37523/cache1.png\"\n        srcset=\"/static/d54d7b59a8f869eeb3b15bb755660aec/e9ff0/cache1.png 180w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/f21e7/cache1.png 360w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/37523/cache1.png 720w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/302a4/cache1.png 1080w,\n/static/d54d7b59a8f869eeb3b15bb755660aec/21b4d/cache1.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 그림처럼 별도의 캐시 계층을 두어서 데이터를 잠시 보관한다면\n성능이 개선될 뿐만 아니라 데이터베이스의 부하를 줄일 수 있게 됩니다.</p>\n<hr>\n<h1 id=\"어떤-점을-고려해야-할까\" style=\"position:relative;\"><a href=\"#%EC%96%B4%EB%96%A4-%EC%A0%90%EC%9D%84-%EA%B3%A0%EB%A0%A4%ED%95%B4%EC%95%BC-%ED%95%A0%EA%B9%8C\" aria-label=\"어떤 점을 고려해야 할까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>어떤 점을 고려해야 할까?</h1>\n<p>캐시를 사용하기 위해서 여러 고민사항이 있는데, 모아밤이 현재 큰 서비스는 아니기 때문에,\n아래에 정리한 3가지를 고민해봤습니다.</p>\n<h3 id=\"1-캐시에-저장할-쿠폰-정보-데이터는-어떻게-만료할-것인가\" style=\"position:relative;\"><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"1 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</h3>\n<p>만료 정책이 없거나 너무 길면 캐시에 쿠폰 정보가 계속 남게 되어 일관성 문제가 발생합니다.\n이로 인해 쿠폰 발급에 문제가 발생할 것입니다. 또한 만료 기한이 너무 짧으면 데이터베이스를\n자주 읽기 때문에 곤란합니다.</p>\n<h3 id=\"2-장애에는-어떻게-대처할-것인가\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"2 장애에는 어떻게 대처할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장애에는 어떻게 대처할 것인가?</h3>\n<p>사실 캐시 서버를 한 대만 두는 경우 해당 서버는 단일 장애 지점(SPOF)이 되어버릴 가능성이\n있습니다.</p>\n<h3 id=\"3-local-cache와-global-cache-중-어떤-것을-선택할-것인가\" style=\"position:relative;\"><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\" aria-label=\"3 local cache와 global cache 중 어떤 것을 선택할 것인가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</h3>\n<p><strong>로컬 캐시는 각 캐시 서버를 두고 저장하는 전략</strong>으로 로컬 서버의 리소스(Memory, Disk)를\n사용해 캐싱을 처리합니다. 때문에 속도는 빠르지만, 다른 서버의 캐시를 참조하기가 어렵습니다.\n반대로 <strong>글로벌 캐시는 별도의 캐시 서버를 두는 전략</strong>으로 Redis 혹은 Memcached 등을\n사용해 캐싱을 처리합니다. 때문에, 서버 간 데이터 공유가 쉽지만 네트워크 트래픽을 사용하기 때문에\n로컬 캐시보단 속도가 느립니다.</p>\n<hr>\n<h2 id=\"고려사항에-대한-모아밤의-선택\" style=\"position:relative;\"><a href=\"#%EA%B3%A0%EB%A0%A4%EC%82%AC%ED%95%AD%EC%97%90-%EB%8C%80%ED%95%9C-%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%84%A0%ED%83%9D\" aria-label=\"고려사항에 대한 모아밤의 선택 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>고려사항에 대한 모아밤의 선택</h2>\n<h3 id=\"1-캐시에-저장할-쿠폰-정보-데이터는-어떻게-만료할-것인가-1\" style=\"position:relative;\"><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"1 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</h3>\n<p>모아밤 서비스는 00시에 단 하나의 쿠폰 이벤트가 발생합니다. 즉,\n캐시 데이터는 00시가 되면 그 즉시 만료하는 정책으로 가면 될 것 같습니다. 예\n를 들어, 최초 요청이 들어왔을 때, 00시에서 해당 요청 시간을 뺀 값으로 만료시간을\n정하면 될 것 같습니다.</p>\n<h3 id=\"2-장애에는-어떻게-대처할-것인가-1\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"2 장애에는 어떻게 대처할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장애에는 어떻게 대처할 것인가?</h3>\n<p>현재 모아밤의 자원은 한정적입니다. 어쩔 수 없이 SPOF를 감안하고 캐시 서버는 한 대로 진\n행해야 할 것 같습니다.</p>\n<h3 id=\"3-local-cache와-global-cache-중-어떤-것을-선택할-것인가-1\" style=\"position:relative;\"><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\" aria-label=\"3 local cache와 global cache 중 어떤 것을 선택할 것인가 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</h3>\n<p>고민 끝에, 모아밤에서는 Global Cache를 선택하게 되었습니다. 여러가지 이유가 있는데,\n사실 현재 상황에선 Local Cache 전략을 사용하는 게 더 좋습니다. 다만 이미 Redis 저\n장소를 사용하고 있는 점, 추후 서버가 2대 이상이 되거나, 모아밤의 쿠폰 이벤트 정책이 변경되\n었을 때, 코드 변경이 크게 일어난다는 점을 고려해서 Global Cache를 선택하게 되었습니다.</p>\n<hr>\n<h1 id=\"redis로-캐싱-구현하기\" style=\"position:relative;\"><a href=\"#redis%EB%A1%9C-%EC%BA%90%EC%8B%B1-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"redis로 캐싱 구현하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redis로 캐싱 구현하기</h1>\n<h3 id=\"캐싱에-필요한-설정-및-만료-정책-코드\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%B1%EC%97%90-%ED%95%84%EC%9A%94%ED%95%9C-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EB%A7%8C%EB%A3%8C-%EC%A0%95%EC%B1%85-%EC%BD%94%EB%93%9C\" aria-label=\"캐싱에 필요한 설정 및 만료 정책 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐싱에 필요한 설정 및 만료 정책 코드</h3>\n<ul>\n<li><strong>redisCacheConfiguration()</strong> : 원하는 TTL과 직렬화 전략을 설정했습니다.</li>\n<li><strong>getTtl()</strong> : TTL을 반환합니다. 이는 00시 기준으로 요청 시각을 뺀 값입니다.</li>\n<li><strong>objectMapper()</strong> : Jackson2는 LocalDate 타입을 인식하지 못하기 때문에, 그에 따른 에러 방지 설정</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EnableCaching</span>\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisCacheConfiguration</span> <span class=\"token function\">redisCacheConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">var</span> strSerializePair <span class=\"token operator\">=</span> <span class=\"token class-name\">SerializationPair</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">var</span> objSerializePair <span class=\"token operator\">=</span> <span class=\"token class-name\">SerializationPair</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">GenericJackson2JsonRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token function\">objectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">RedisCacheConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token function\">defaultCacheConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">entryTtl</span><span class=\"token punctuation\">(</span><span class=\"token function\">getTtl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">serializeKeysWith</span><span class=\"token punctuation\">(</span>strSerializePair<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">serializeValuesWith</span><span class=\"token punctuation\">(</span>objSerializePair<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Duration</span> <span class=\"token function\">getTtl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">LocalTime</span> now <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">LocalTime</span> end <span class=\"token operator\">=</span> clockHolder<span class=\"token punctuation\">.</span><span class=\"token function\">endOfDay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">between</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">ObjectMapper</span> <span class=\"token function\">objectMapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">PolymorphicTypeValidator</span> polymorphicTypeValidator <span class=\"token operator\">=</span> <span class=\"token class-name\">BasicPolymorphicTypeValidator</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">allowIfSubType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">JsonMapper</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">polymorphicTypeValidator</span><span class=\"token punctuation\">(</span>polymorphicTypeValidator<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SerializationFeature</span><span class=\"token punctuation\">.</span><span class=\"token constant\">WRITE_DATES_AS_TIMESTAMPS</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">addModule</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">JavaTimeModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">activateDefaultTyping</span><span class=\"token punctuation\">(</span>polymorphicTypeValidator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ObjectMapper<span class=\"token punctuation\">.</span>DefaultTyping</span><span class=\"token punctuation\">.</span><span class=\"token constant\">NON_FINAL</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"캐시-서비스-코드\" style=\"position:relative;\"><a href=\"#%EC%BA%90%EC%8B%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%BD%94%EB%93%9C\" aria-label=\"캐시 서비스 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>캐시 서비스 코드</h3>\n<ul>\n<li><strong>getByNameAndStartAt(…)</strong> : 쿠폰 발급 요청 시, 요청된 쿠폰 정보 캐싱</li>\n<li><strong>getByStartAt(…)</strong> : 쿠폰 발급 대기열 처리 시, 해당 쿠폰 정보 캐싱</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token annotation punctuation\">@CacheConfig</span><span class=\"token punctuation\">(</span>cacheNames <span class=\"token operator\">=</span> <span class=\"token string\">\"coupons\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponCacheService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"#couponName + #now\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Coupon</span> <span class=\"token function\">getByNameAndStartAt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> couponName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">LocalDate</span> now<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByNameAndStartAt</span><span class=\"token punctuation\">(</span>couponName<span class=\"token punctuation\">,</span> now<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorMessage</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_COUPON_PERIOD</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">=</span> <span class=\"token string\">\"#now\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getByStartAt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDate</span> now<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByStartAt</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<p>이로 인해, <code class=\"language-text\">실시간 선착순 쿠폰 이벤트 도입기</code>의 문제점들을 모두 해결했습니다. 긴 글 읽어주셔서 감사합니다. 이상으로 포스팅은 여기서 마치도록 하겠습니다.</p>\n<hr>\n<h1 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h1>\n<ul>\n<li><a href=\"https://www.baeldung.com/spring-expression-language\">Spring Expression Language Guide - Baeldung</a></li>\n<li><a href=\"https://www.baeldung.com/spring-boot-redis-cache\">Spring Boot Cache with Redis - Baeldung</a></li>\n<li><a href=\"https://docs.spring.io/spring-data-redis/reference/redis/redis-cache.html\">Redis Cache - 공식 문서</a></li>\n<li><a href=\"https://docs.spring.io/spring-framework/reference/integration/cache/jsr-107.html\">JCache Annotations - 공식 문서</a></li>\n<li> 가상 면접 사례로 배우는 대규모 시스템 설계 기초 - 알렉스 쉬 지음, 이병준 옮김</li>\n</ul>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<ul>\n<li><a href=\"#%EB%AC%B8%EC%A0%9C\">문제</a></li>\n<li><a href=\"#%EC%9B%90%EC%9D%B8\">원인</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0\">해결</a></li>\n<li><a href=\"#%EA%B7%B8%EB%A6%BC%EC%9C%BC%EB%A1%9C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0\">그림으로 이해하기</a></li>\n<li><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</a></li>\n<li><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">2. 장애에는 어떻게 대처할 것인가?</a></li>\n<li><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80\">3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EA%B3%A0%EB%A0%A4%EC%82%AC%ED%95%AD%EC%97%90-%EB%8C%80%ED%95%9C-%EB%AA%A8%EC%95%84%EB%B0%A4%EC%9D%98-%EC%84%A0%ED%83%9D\">고려사항에 대한 모아밤의 선택</a></p>\n<ul>\n<li><a href=\"#1-%EC%BA%90%EC%8B%9C%EC%97%90-%EC%A0%80%EC%9E%A5%ED%95%A0-%EC%BF%A0%ED%8F%B0-%EC%A0%95%EB%B3%B4-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%A7%8C%EB%A3%8C%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">1. 캐시에 저장할 쿠폰 정보 데이터는 어떻게 만료할 것인가?</a></li>\n<li><a href=\"#2-%EC%9E%A5%EC%95%A0%EC%97%90%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">2. 장애에는 어떻게 대처할 것인가?</a></li>\n<li><a href=\"#3-local-cache%EC%99%80-global-cache-%EC%A4%91-%EC%96%B4%EB%96%A4-%EA%B2%83%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%A0-%EA%B2%83%EC%9D%B8%EA%B0%80-1\">3. Local Cache와 Global Cache 중 어떤 것을 선택할 것인가?</a></li>\n<li><a href=\"#%EC%BA%90%EC%8B%B1%EC%97%90-%ED%95%84%EC%9A%94%ED%95%9C-%EC%84%A4%EC%A0%95-%EB%B0%8F-%EB%A7%8C%EB%A3%8C-%EC%A0%95%EC%B1%85-%EC%BD%94%EB%93%9C\">캐싱에 필요한 설정 및 만료 정책 코드</a></li>\n<li><a href=\"#%EC%BA%90%EC%8B%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%BD%94%EB%93%9C\">캐시 서비스 코드</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"January 12, 2024","title":"모아밤의 캐싱으로 성능 개선하기","categories":"Tech","author":"홍혁준","emoji":"🧑🏻‍💻"},"fields":{"slug":"/coupon-cache/"}},"site":{"siteMetadata":{"siteUrl":"https://team-moabam.github.io","comments":{"utterances":{"repo":"team-moabam/team-moabam.github.io"}}}}},"pageContext":{"slug":"/ranking-system/","nextSlug":"/coupon-event/","prevSlug":"/coupon-cache/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}